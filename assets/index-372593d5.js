var M=Object.defineProperty;var F=(o,s,e)=>s in o?M(o,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[s]=e;var a=(o,s,e)=>(F(o,typeof s!="symbol"?s+"":s,e),e);(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&t(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function t(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();class S{constructor(s,e){a(this,"currentPage","");var t;this.defaultPage=s,this.pages=e,location.hash.slice(1)==""&&(location.hash="#"+s),window.onhashchange=n=>{this.onOpen()};for(const n in e)(t=document.getElementById("app"))==null||t.appendChild(e[n].htmlElement),e[n].hide();this.onOpen()}onOpen(){var i,r,c;let s={},e=this.defaultPage,n=location.hash.slice(1).split("&");n.length>0&&(e=n[0],n=n.splice(1));for(const p of n){let u=p.split("="),h=decodeURIComponent(u[0]),E=decodeURIComponent(u[1]);s[h]=E}this.currentPage!=e&&(console.log("Hide page: "+this.currentPage),(i=this.pages[this.currentPage])==null||i.hide(),this.currentPage=e,console.log("Show page: "+e),(r=this.pages[this.currentPage])==null||r.show()),console.log("Calling page.update with: "+JSON.stringify(s)),(c=this.pages[this.currentPage])==null||c.update(s)}static open(s,e){window.setTimeout(()=>{let t="";for(let n in e)t+="&"+encodeURIComponent(n)+"="+encodeURIComponent(e[n]);location.hash="#"+encodeURIComponent(s)+t},200)}static back(){history.back()}}class d{constructor(){}static APPLY_COUNTED(s,e){return e.replace("{count}",s.toString())}}a(d,"TIME_LOCALE","en"),a(d,"TIME_YESTERDAY","yesterday"),a(d,"TIME_HOURS_AGO","{count} hour(s) ago"),a(d,"TIME_MINUTES_AGO","{count} minute(s) ago"),a(d,"TIME_SECONDS_AGO","{count} second(s) ago"),a(d,"TIME_TODAY_AT","today at"),a(d,"TIME_JUST_NOW","just now"),a(d,"APPNAME","Knowledgebase"),a(d,"LOGIN_KNOWN_CONNECTIONS","Reuse Connection"),a(d,"LOGIN_SESSION_NAME","Session Name"),a(d,"LOGIN_API_ENDPOINT_LABEL","API Endpoint URL"),a(d,"LOGIN_API_TOKEN_LABEL","API Token"),a(d,"LOGIN_SUBMIT","Add Connection"),a(d,"LOGIN_ERROR_MISSING_INPUTS","You must provide all fields (session name, api endpoint and api token)."),a(d,"LOGIN_ERROR_LOGIN_FAILED","The provided login information is wrong. Is the URL and API token correct?"),a(d,"SEARCH_FILETREE_IS_NULL","Cannot retrieve list of files. Maybe you have a weak internet connection."),a(d,"SEARCH_PLACEHOLDER","Search (Keyword, Keyword, Keyword)"),a(d,"SEARCH_LAST_MODIFIED","modified"),a(d,"SEARCH_NUM_RESULTS","files found");class O extends d{}a(O,"TIME_LOCALE","de"),a(O,"APPNAME","Wissensdatenbank");let l=d;function v(){switch(localStorage.language){case"de":l=O;break;case"en":case"us":default:l=d;break}}class f{constructor(s){a(this,"apiEndpoint","");a(this,"sessionToken","");this.session_name=s,this.loadSessionConfig()}loadSessionConfig(){if(localStorage.webfs_sessions){let s=JSON.parse(localStorage.webfs_sessions);if(this.session_name in s){let e=s[this.session_name];this.apiEndpoint=e.apiEndpoint,this.sessionToken=e.sessionToken}}}writeSessionConfig(s,e){this.apiEndpoint=s,this.sessionToken=e;let t={};localStorage.webfs_sessions&&(t=JSON.parse(localStorage.webfs_sessions)),t[this.session_name]={apiEndpoint:this.apiEndpoint,sessionToken:e},localStorage.webfs_sessions=JSON.stringify(t)}removeSession(){if(localStorage.webfs_sessions){let s=JSON.parse(localStorage.webfs_sessions);s.indexOf(this.session_name)>=0&&s.remove(this.session_name)}}request(s){s.append("token",this.sessionToken);const e={method:"POST",body:s};return fetch(this.apiEndpoint,e)}async ping(){let s=new FormData;s.append("cmd","ping"),s.append("uri",".");let e=await this.request(s);return e.status!=200?(console.error(e.text()),!1):await e.text()=="pong"}async login(s,e){let t=new FormData;t.append("cmd","login"),t.append("uri","."),t.append("token",e);let i=await fetch(s,{method:"POST",body:t});if(i.status!=200)return console.error(i.text()),!1;let r=await i.text();return this.writeSessionConfig(s,r),!0}buildFileTree(s){return s}async list(s){let e=new FormData;e.append("cmd","list"),e.append("uri",s);let t=await this.request(e);return t.status!=200?(console.error(t.text()),null):await t.json()}async walk(s){let e=new FormData;e.append("cmd","walk"),e.append("uri",s);let t=await this.request(e);if(t.status!=200)return console.error(t.text()),null;let n=await t.json();return this.buildFileTree(n)}async md5(s){let e=new FormData;e.append("cmd","md5"),e.append("uri",s);let t=await this.request(e);return t.status!=200?(console.error(t.text()),null):t.text()}async open(s){let e=new FormData;e.append("cmd","open"),e.append("uri",s);let t=await this.request(e);return t.status!=200?(console.error(t.text()),!1):(await t.text(),!0)}async readTxt(s){let e=new FormData;e.append("cmd","read"),e.append("uri",s);let t=await this.request(e);return t.status!=200?(console.error(t.text()),null):t.text()}read(s,e="_self"){function t(r,c,p){let u=document.createElement("input");u.type="hidden",u.name=c,u.value=p,r.appendChild(u)}let n=document.getElementsByTagName("body")[0],i=document.createElement("form");i.action=this.apiEndpoint,i.method="post",i.target=e,t(i,"cmd","read"),t(i,"token",this.sessionToken),t(i,"uri",s),n.appendChild(i),i.submit(),n.removeChild(i)}async putTxt(s,e,t){return this.putFile(s,e,t)}async putFile(s,e,t){let n="",i=new FormData;i.append("cmd","write"),i.append("operation","write"),i.append("uri",s),i.append("file",e),i.append("md5",t+","+n);let r=await this.request(i);return r.status!=200?(console.error(r.text()),!1):(await r.text(),!0)}async mkdir(s){let e=new FormData;e.append("cmd","write"),e.append("operation","mkdir"),e.append("uri",s);let t=await this.request(e);return t.status!=200?(console.error(t.text()),!1):(await t.text(),!0)}async rmdir(s){let e=new FormData;e.append("cmd","write"),e.append("operation","rmdir"),e.append("uri",s);let t=await this.request(e);return t.status!=200?(console.error(t.text()),!1):(await t.text(),!0)}async mv(s,e){let t=new FormData;t.append("cmd","write"),t.append("operation","mv"),t.append("uri",s),t.append("target",e);let n=await this.request(t);return n.status!=200?(console.error(n.text()),!1):(await n.text(),!0)}async rm(s,e){let t=new FormData;t.append("cmd","write"),t.append("operation","rm"),t.append("uri",s),t.append("md5",e);let n=await this.request(t);return n.status!=200?(console.error(n.text()),!1):(await n.text(),!0)}}a(f,"instance",null);class m{constructor(s){a(this,"parent",null);a(this,"htmlElement");a(this,"displayStyle","None");this.htmlElement=document.createElement(s)}add(s){this.htmlElement.appendChild(s.htmlElement),s.parent=this}remove(s){this.htmlElement.removeChild(s.htmlElement),s.parent=null}hide(){this.htmlElement.style.display!="None"&&(this.displayStyle=this.htmlElement.style.display,this.htmlElement.style.display="None")}show(){this.displayStyle!="None"&&(this.htmlElement.style.display=this.displayStyle)}update(s){}select(){this.setClass("selected")}unselect(){this.unsetClass("selected")}setClass(s){this.htmlElement.classList.contains(s)||this.htmlElement.classList.add(s)}unsetClass(s){this.htmlElement.classList.contains(s)||this.htmlElement.classList.remove(s)}}class R extends m{constructor(s,e=""){super("a"),this.htmlElement.innerText=s,e!=""&&this.setClass(e),this.htmlElement.onclick=()=>{this.onClick()}}onClick(){console.log("Buttom::onClick: Not implemented! Must be implemented by subclass.")}}class k extends m{constructor(...s){super("div");for(const e of s)this.add(e)}submit(){let s=new FormData;for(const e in this.htmlElement.children){let t=this.htmlElement.children[e];t instanceof HTMLInputElement&&s.append(t.name,t.value)}this.onSubmit(s)}onSubmit(s){console.log("Form::onSubmit: Not implemented! Must be implemented by subclass."),console.log(s)}}class w extends m{constructor(s,e,t,n=""){super("input"),this.htmlElement.name=s,this.htmlElement.placeholder=e,this.htmlElement.type=t,n!=""&&this.setClass(n),this.htmlElement.oninput=()=>{this.onChange(this.htmlElement.value)}}value(s=void 0){return s!==void 0&&(this.htmlElement.value=s),this.htmlElement.value}onChange(s){}}class _ extends m{constructor(s,e=""){super("label"),this.htmlElement.innerText=s,e!=""&&this.setClass(e)}}class x extends R{onClick(){this.parent.submit()}}const P=6,H=6,U=10,G=12,Y=.001,N=31557600,g=2629800,I=86400,y=3600,L=60;function B(o,s="long"){let e=new Date;const t=A(e,o),{hours:n,minutes:i,seconds:r}=t;let c=new Date(e.toISOString().substring(0,10)),p=new Date(o.toISOString().substring(0,10));const u=A(c,p),{years:h,months:E,days:T}=u;return h>100?"unknown":h>0||E>H?C(o,{includeYear:!0,length:s}):E>0||T>P?C(o,{includeYear:!1,length:s}):T>1?o.toLocaleDateString(l.TIME_LOCALE,{weekday:s}):T===1?l.TIME_YESTERDAY:n>G?l.TIME_TODAY_AT+" "+o.toLocaleTimeString(l.TIME_LOCALE,{hour:"numeric",minute:"2-digit"}):n>0?l.APPLY_COUNTED(n,l.TIME_HOURS_AGO):i>0?l.APPLY_COUNTED(i,l.TIME_MINUTES_AGO):r>U?l.APPLY_COUNTED(r,l.TIME_SECONDS_AGO):l.TIME_JUST_NOW}function C(o,{includeYear:s,length:e}){const t=o.toLocaleDateString(l.TIME_LOCALE,{month:e});let i=`${o.getDate().toString()}. ${t}`;return s&&(i+=` ${o.getFullYear()}`),i}function D(o){return Math.floor(o*Y)}function A(o,s){const e={years:0,months:0,days:0,hours:0,minutes:0,seconds:0};let t=D(o.valueOf())-D(s.valueOf());return e.years=Math.floor(t/N),t-=e.years*N,e.months=Math.floor(t/g),t-=e.months*g,e.days=Math.floor(t/I),t-=e.days*I,e.hours=Math.floor(t/y),t-=e.hours*y,e.minutes=Math.floor(t/L),t-=e.minutes*L,e.seconds=t,e}class q{constructor(s){a(this,"activeTimeout");this.timeout=s}defer(s){this.activeTimeout&&window.clearTimeout(this.activeTimeout),this.activeTimeout=window.setTimeout(()=>{this.activeTimeout=void 0,s()},this.timeout)}}class J extends m{constructor(){super("div");a(this,"searchField");a(this,"results");a(this,"fileTree",null);a(this,"updateHashLater",new q(1e3));this.searchField=new w("search",l.SEARCH_PLACEHOLDER,"search","searchInput"),this.searchField.onChange=e=>{this.updateSearchResults(),this.updateHashLater.defer(()=>{S.open("search",{q:e})})},this.add(this.searchField),this.results=new m("div"),this.results.setClass("searchResults"),this.add(this.results)}async update(e){var t;if(f.instance==null){S.open("login",{});return}this.fileTree=await((t=f.instance)==null?void 0:t.walk(".")),this.searchField.value(e.q),this.updateSearchResults()}async updateSearchResults(){let e=this.searchField.value();if(this.results.htmlElement.innerHTML="",this.fileTree==null){alert(l.SEARCH_FILETREE_IS_NULL);return}let t=this.flatten(this.fileTree);t=this.sortFilesByLastModified(t),t=this.sortFilesByRelevance(t,e),this.showNumResults(t),t=t.slice(0,50);for(let n of t)this.results.add(new W(n.filepath,B(n.modified)))}showNumResults(e){let t=new m("div");t.htmlElement.innerText=e.length+" "+l.SEARCH_NUM_RESULTS,t.setClass("searchNumResults"),this.results.add(t)}sortFilesByRelevance(e,t){let n=t.toLowerCase().split(",").map(c=>c.trim()),i=[];for(let c of e){let{filename:p,folder:u}=b(c.filepath);var r=0;for(let h of n){if(h==""){r=1;continue}let E=h.startsWith("!");p.toLowerCase().includes(h)&&(r+=100),!E&&u.toLowerCase().includes(h)&&(r+=1),E&&u.toLowerCase().startsWith(h.substring(1))&&(r+=100)}r>0&&i.push({filepath:c.filepath,modified:c.modified,score:r})}return i.sort((c,p)=>p.score-c.score)}sortFilesByLastModified(e){return e.sort((t,n)=>n.modified.toISOString().localeCompare(t.modified.toISOString()))}flatten(e,t="",n=[]){for(const i in e){const r=e[i];typeof r!="string"?n=this.flatten(r,t+i+"/",n):n.push({filepath:t+i,modified:new Date(r)})}return n}}class W extends m{constructor(s,e){super("div"),this.setClass("searchResult");let{filename:t,folder:n}=b(s),i=document.createElement("div");i.innerText=t,i.classList.add("searchResultFilename"),this.htmlElement.appendChild(i);let r=document.createElement("div");r.innerText=l.SEARCH_LAST_MODIFIED+": "+e,r.classList.add("searchResultModified"),this.htmlElement.appendChild(r);let c=document.createElement("div");c.innerText=n,c.classList.add("searchResultFolder"),this.htmlElement.appendChild(c),this.htmlElement.onclick=()=>{S.open("edit",{folder:n,filename:t})}}}function b(o){let s=o.split("/"),e=s.pop(),t=s.join("/");return t==""&&(t="."),{filename:e,folder:t}}class K extends m{constructor(){super("div");a(this,"connections");this.setClass("loginView"),this.connections=new m("div"),this.add(this.connections);let e=new k(new _(l.LOGIN_SESSION_NAME,"loginLabel"),new w("sessionName","myserver","text","loginInput"),new _(l.LOGIN_API_ENDPOINT_LABEL,"loginLabel"),new w("apiEndpoint","https://myserver/webfs/api.php","url","loginInput"),new _(l.LOGIN_API_TOKEN_LABEL,"loginLabel"),new w("apiToken","a4ef9...","password","loginInput"),new x(l.LOGIN_SUBMIT,"loginButton"));e.setClass("loginForm"),e.onSubmit=this.onCreateSession.bind(this),this.add(e)}update(e){if(this.connections.htmlElement.innerHTML="",localStorage.kb_sessions){let t=JSON.parse(localStorage.kb_sessions);t.length>0&&this.connections.add(new _(l.LOGIN_KNOWN_CONNECTIONS,"loginLabel"));for(const n of t){let i=new R(n,"loginButton");i.onClick=()=>{this.onReuseSession(n)},this.connections.add(i)}if(t.length>0){let n=new m("hr");n.setClass("loginDivider"),this.connections.add(n)}}}async onReuseSession(e){let t=new f(e);await t.ping()?(f.instance=t,S.back()):alert("Connection refused. Either the server is not available or the connection was not used for too long.")}async onCreateSession(e){let t=e.get("sessionName"),n=e.get("apiEndpoint"),i=e.get("apiToken");if(t==""||n==""||i==""||t==null||n==null||i==null){alert(l.LOGIN_ERROR_MISSING_INPUTS);return}let r=new f(t);if(await r.login(n,i)){let c=[];localStorage.kb_sessions&&(c=JSON.parse(localStorage.kb_sessions)),c.push(t),localStorage.kb_sessions=JSON.stringify(c),f.instance=r,S.back()}else alert(l.LOGIN_ERROR_LOGIN_FAILED)}}class j extends m{constructor(){super("div");a(this,"iframe");this.iframe=document.createElement("iframe"),this.iframe.name="editFrame",this.iframe.classList.add("editFrame"),this.htmlElement.appendChild(this.iframe)}async update(e){var t;if(f.instance==null){S.open("login",{});return}(t=f.instance)==null||t.read(e.folder+"/"+e.filename,"editFrame")}hide(){this.iframe.src="about:blank",super.hide()}}function $(){v(),document.getElementsByTagName("title")[0].innerHTML=l.APPNAME,new S("search",{search:new J,login:new K,edit:new j})}$();
