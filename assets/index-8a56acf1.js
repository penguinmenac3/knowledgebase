var F=Object.defineProperty;var H=(o,t,e)=>t in o?F(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var r=(o,t,e)=>(H(o,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();class E{constructor(t,e){r(this,"currentPage","");var s;this.defaultPage=t,this.pages=e,location.hash.slice(1)==""&&(location.hash="#"+t),window.onhashchange=n=>{this.onOpen()};for(const n in e)(s=document.getElementById("app"))==null||s.appendChild(e[n].htmlElement),e[n].hide();this.onOpen()}onOpen(){var a,d,m;let t={},e=this.defaultPage,n=location.hash.slice(1).split("&");n.length>0&&(e=n[0],n=n.splice(1));for(const p of n){let f=p.split("="),u=decodeURIComponent(f[0]),S=decodeURIComponent(f[1]);t[u]=S}let i=this.currentPage!=e;i&&(console.log("Hide page: "+this.currentPage),(a=this.pages[this.currentPage])==null||a.hide(),this.currentPage=e,console.log("Show page: "+e),(d=this.pages[this.currentPage])==null||d.show()),console.log("Calling page.update with: "+JSON.stringify(t)),(m=this.pages[this.currentPage])==null||m.update(t,i)}static open(t,e){window.setTimeout(()=>{let s="";for(let n in e)s+="&"+encodeURIComponent(n)+"="+encodeURIComponent(e[n]);location.hash="#"+encodeURIComponent(t)+s},200)}static back(){history.back()}}class c{constructor(){}static APPLY_COUNTED(t,e){return e.replace("{count}",t.toString())}}r(c,"TIME_LOCALE","en"),r(c,"TIME_YESTERDAY","yesterday"),r(c,"TIME_HOURS_AGO","{count} hour(s) ago"),r(c,"TIME_MINUTES_AGO","{count} minute(s) ago"),r(c,"TIME_SECONDS_AGO","{count} second(s) ago"),r(c,"TIME_TODAY_AT","today at"),r(c,"TIME_JUST_NOW","just now"),r(c,"APPNAME","Knowledgebase"),r(c,"LOGIN_KNOWN_CONNECTIONS","Reuse Connection"),r(c,"LOGIN_SESSION_NAME","Session Name"),r(c,"LOGIN_API_ENDPOINT_LABEL","API Endpoint URL"),r(c,"LOGIN_API_TOKEN_LABEL","API Token"),r(c,"LOGIN_SUBMIT","Add Connection"),r(c,"LOGIN_ERROR_MISSING_INPUTS","You must provide all fields (session name, api endpoint and api token)."),r(c,"LOGIN_ERROR_LOGIN_FAILED","The provided login information is wrong. Is the URL and API token correct?"),r(c,"SEARCH_FILETREE_IS_NULL","Cannot retrieve list of files. Maybe you have a weak internet connection."),r(c,"SEARCH_PLACEHOLDER","Search (Keyword, Keyword, Keyword)"),r(c,"SEARCH_LAST_MODIFIED","modified"),r(c,"SEARCH_CREATED","created"),r(c,"SEARCH_NUM_RESULTS","files found"),r(c,"SEARCH_MORE_RESULTS","Click here to show more results!"),r(c,"SETTINGS_TITLE","Settings"),r(c,"SETTINGS_GENERAL","General"),r(c,"SETTINGS_CONNECTION","Connection"),r(c,"SETTINGS_SELECT_SERVER","Select server"),r(c,"SETTINGS_DISPLAY","Display"),r(c,"SETTINGS_SHOW_TXT_PREVIEWS","Show previews for text documents"),r(c,"SETTINGS_SHOW_IMG_PREVIEWS","Show previews for images"),r(c,"SETTINGS_SHOW_PDF_PREVIEWS","Show previews for PDFs");class L extends c{}r(L,"TIME_LOCALE","de"),r(L,"APPNAME","Wissensdatenbank");let l=c;function G(){switch(localStorage.language){case"de":l=L;break;case"en":case"us":default:l=c;break}}class _{constructor(t){r(this,"apiEndpoint","");r(this,"sessionToken","");this.session_name=t,this.loadSessionConfig()}loadSessionConfig(){if(localStorage.webfs_sessions){let t=JSON.parse(localStorage.webfs_sessions);if(this.session_name in t){let e=t[this.session_name];this.apiEndpoint=e.apiEndpoint,this.sessionToken=e.sessionToken}}}writeSessionConfig(t,e){this.apiEndpoint=t,this.sessionToken=e;let s={};localStorage.webfs_sessions&&(s=JSON.parse(localStorage.webfs_sessions)),s[this.session_name]={apiEndpoint:this.apiEndpoint,sessionToken:e},localStorage.webfs_sessions=JSON.stringify(s)}removeSession(){if(localStorage.webfs_sessions){let t=JSON.parse(localStorage.webfs_sessions);t.indexOf(this.session_name)>=0&&t.remove(this.session_name)}}request(t){t.append("token",this.sessionToken);const e={method:"POST",body:t};return fetch(this.apiEndpoint,e)}async ping(){let t=new FormData;t.append("cmd","ping"),t.append("uri",".");let e=await this.request(t);return e.status!=200?(console.error(e.text()),!1):await e.text()=="pong"}async login(t,e){let s=new FormData;s.append("cmd","login"),s.append("uri","."),s.append("token",e);let i=await fetch(t,{method:"POST",body:s});if(i.status!=200)return console.error(i.text()),!1;let a=await i.text();return this.writeSessionConfig(t,a),!0}buildFileTree(t){return t}async list(t){let e=new FormData;e.append("cmd","list"),e.append("uri",t);let s=await this.request(e);return s.status!=200?(console.error(s.text()),null):await s.json()}async walk(t){let e=new FormData;e.append("cmd","walk"),e.append("uri",t);let s=await this.request(e);if(s.status!=200)return console.error(s.text()),null;let n=await s.json();return this.buildFileTree(n)}async md5(t){let e=new FormData;e.append("cmd","md5"),e.append("uri",t);let s=await this.request(e);return s.status!=200?(console.error(s.text()),null):s.text()}async open(t){let e=new FormData;e.append("cmd","open"),e.append("uri",t);let s=await this.request(e);return s.status!=200?(console.error(s.text()),!1):(await s.text(),!0)}async readTxt(t){let e=new FormData;e.append("cmd","read"),e.append("uri",t);let s=await this.request(e);return s.status!=200?(console.error(s.text()),null):s.text()}readURL(t,e=!1){let s="";return e&&(s="&subsample=1&width=256&height=256"),this.apiEndpoint+"?token="+encodeURIComponent(this.sessionToken)+"&cmd=read&uri="+encodeURIComponent(t)+s}read(t,e="_self"){function s(a,d,m){let p=document.createElement("input");p.type="hidden",p.name=d,p.value=m,a.appendChild(p)}let n=document.getElementsByTagName("body")[0],i=document.createElement("form");i.action=this.apiEndpoint,i.method="post",i.target=e,s(i,"cmd","read"),s(i,"token",this.sessionToken),s(i,"uri",t),n.appendChild(i),i.submit(),n.removeChild(i)}async putTxt(t,e,s){return this.putFile(t,e,s)}async putFile(t,e,s){let n="",i=new FormData;i.append("cmd","write"),i.append("operation","write"),i.append("uri",t),i.append("file",e),i.append("md5",s+","+n);let a=await this.request(i);return a.status!=200?(console.error(a.text()),!1):(await a.text(),!0)}async mkdir(t){let e=new FormData;e.append("cmd","write"),e.append("operation","mkdir"),e.append("uri",t);let s=await this.request(e);return s.status!=200?(console.error(s.text()),!1):(await s.text(),!0)}async rmdir(t){let e=new FormData;e.append("cmd","write"),e.append("operation","rmdir"),e.append("uri",t);let s=await this.request(e);return s.status!=200?(console.error(s.text()),!1):(await s.text(),!0)}async mv(t,e){let s=new FormData;s.append("cmd","write"),s.append("operation","mv"),s.append("uri",t),s.append("target",e);let n=await this.request(s);return n.status!=200?(console.error(n.text()),!1):(await n.text(),!0)}async rm(t,e){let s=new FormData;s.append("cmd","write"),s.append("operation","rm"),s.append("uri",t),s.append("md5",e);let n=await this.request(s);return n.status!=200?(console.error(n.text()),!1):(await n.text(),!0)}}r(_,"instance",null);class h{constructor(t,e="",s=""){r(this,"parent",null);r(this,"htmlElement");r(this,"displayStyle","none");this.htmlElement=document.createElement(t),this.htmlElement.innerHTML=e,s!=""&&this.setClass(s)}add(t){this.htmlElement.appendChild(t.htmlElement),t.parent=this}remove(t){this.htmlElement.removeChild(t.htmlElement),t.parent=null}isVisible(){return this.htmlElement.style.display.toLowerCase()!="none"}hide(){this.isVisible()&&(this.displayStyle=this.htmlElement.style.display,this.htmlElement.style.display="None")}show(){this.displayStyle.toLowerCase()!="none"&&(this.htmlElement.style.display=this.displayStyle)}update(t,e){}select(){this.setClass("selected")}unselect(){this.unsetClass("selected")}setClass(t){this.htmlElement.classList.contains(t)||this.htmlElement.classList.add(t)}unsetClass(t){this.htmlElement.classList.contains(t)||this.htmlElement.classList.remove(t)}}class T extends h{constructor(t,e=""){super("a",t,e),this.htmlElement.onclick=()=>{this.onClick()}}onClick(){console.log("Buttom::onClick: Not implemented! Must be implemented by subclass.")}}class U extends h{constructor(...t){super("div");for(const e of t)this.add(e)}submit(){let t=new FormData;for(const e in this.htmlElement.children){let s=this.htmlElement.children[e];s instanceof HTMLInputElement&&t.append(s.name,s.value)}this.onSubmit(t)}onSubmit(t){console.log("Form::onSubmit: Not implemented! Must be implemented by subclass."),console.log(t)}}class g extends h{constructor(t,e,s,n=""){super("input"),this.htmlElement.name=t,this.htmlElement.placeholder=e,this.htmlElement.type=s,n!=""&&this.setClass(n),this.htmlElement.oninput=()=>{this.onChange(this.htmlElement.value)}}value(t=void 0){return t!==void 0&&(this.htmlElement.value=t),this.htmlElement.value}onChange(t){}}class w extends h{constructor(t,e=""){super("label",t,e)}}class N extends h{constructor(t,e,s="",n=!1){super("div");let i=new h("input");i.htmlElement.name=t,i.htmlElement.type="checkbox",i.htmlElement.checked=n,s!=""&&this.setClass(s),i.htmlElement.onchange=()=>{this.onChange(i.htmlElement.checked)},this.add(i);let a=new h("label");a.htmlElement.innerHTML=e,this.add(a)}onChange(t){console.log("Checkbox::onChange: Not implemented! Must be implemented by subclass.")}}class B extends T{onClick(){this.parent.submit()}}class W extends h{constructor(){super("div");r(this,"connections");this.setClass("loginView"),this.connections=new h("div"),this.add(this.connections);let e=new U(new w(l.LOGIN_SESSION_NAME,"loginLabel"),new g("sessionName","myserver","text","loginInput"),new w(l.LOGIN_API_ENDPOINT_LABEL,"loginLabel"),new g("apiEndpoint","https://myserver/webfs/api.php","url","loginInput"),new w(l.LOGIN_API_TOKEN_LABEL,"loginLabel"),new g("apiToken","a4ef9...","password","loginInput"),new B(l.LOGIN_SUBMIT,"buttonWide"));e.setClass("loginForm"),e.onSubmit=this.onCreateSession.bind(this),this.add(e)}update(e,s){if(this.connections.htmlElement.innerHTML="",localStorage.kb_sessions){let n=JSON.parse(localStorage.kb_sessions);n.length>0&&this.connections.add(new w(l.LOGIN_KNOWN_CONNECTIONS,"loginLabel"));for(const i of n){let a=new T(i,"buttonWide");a.onClick=()=>{M(i)},this.connections.add(a)}if(n.length>0){let i=new h("hr");i.setClass("loginDivider"),this.connections.add(i)}}}async onCreateSession(e){let s=e.get("sessionName"),n=e.get("apiEndpoint"),i=e.get("apiToken");if(s==""||n==""||i==""||s==null||n==null||i==null){alert(l.LOGIN_ERROR_MISSING_INPUTS);return}let a=new _(s);if(await a.login(n,i)){let d=[];localStorage.kb_sessions&&(d=JSON.parse(localStorage.kb_sessions)),d.push(s),localStorage.kb_sessions=JSON.stringify(d),_.instance=a,E.back()}else alert(l.LOGIN_ERROR_LOGIN_FAILED)}}async function M(o,t=!1){console.log("Connecting to: "+o);let e=new _(o);await e.ping()?(_.instance=e,localStorage.kb_last_session=o,t||E.back()):t||alert("Connection refused. Either the server is not available or the connection was not used for too long.")}async function Y(){if(localStorage.kb_sessions){let o=JSON.parse(localStorage.kb_sessions);if(o.length>0){let t=o[0];localStorage.kb_last_session&&(t=localStorage.kb_last_session),await M(t,!0)}}}const q=6,V=6,J=10,j=12,K=.001,O=31557600,y=2629800,b=86400,v=3600,R=60;function $(o,t="long"){let e=new Date;const s=A(e,o),{hours:n,minutes:i,seconds:a}=s;let d=new Date(e.toISOString().substring(0,10)),m=new Date(o.toISOString().substring(0,10));const p=A(d,m),{years:f,months:u,days:S}=p;return f>100?"unknown":f>0||u>V?k(o,{includeYear:!0,length:t}):u>0||S>q?k(o,{includeYear:!1,length:t}):S>1?o.toLocaleDateString(l.TIME_LOCALE,{weekday:t}):S===1?l.TIME_YESTERDAY:n>j?l.TIME_TODAY_AT+" "+o.toLocaleTimeString(l.TIME_LOCALE,{hour:"numeric",minute:"2-digit"}):n>0?l.APPLY_COUNTED(n,l.TIME_HOURS_AGO):i>0?l.APPLY_COUNTED(i,l.TIME_MINUTES_AGO):a>J?l.APPLY_COUNTED(a,l.TIME_SECONDS_AGO):l.TIME_JUST_NOW}function k(o,{includeYear:t,length:e}){const s=o.toLocaleDateString(l.TIME_LOCALE,{month:e});let i=`${o.getDate().toString()}. ${s}`;return t&&(i+=` ${o.getFullYear()}`),i}function D(o){return Math.floor(o*K)}function A(o,t){const e={years:0,months:0,days:0,hours:0,minutes:0,seconds:0};let s=D(o.valueOf())-D(t.valueOf());return e.years=Math.floor(s/O),s-=e.years*O,e.months=Math.floor(s/y),s-=e.months*y,e.days=Math.floor(s/b),s-=e.days*b,e.hours=Math.floor(s/v),s-=e.hours*v,e.minutes=Math.floor(s/R),s-=e.minutes*R,e.seconds=s,e}class z{constructor(t){r(this,"activeTimeout");this.timeout=t}defer(t){this.activeTimeout&&window.clearTimeout(this.activeTimeout),this.activeTimeout=window.setTimeout(()=>{this.activeTimeout=void 0,t()},this.timeout)}}class X extends h{constructor(){super("div");r(this,"searchField");r(this,"results");r(this,"fileTree",null);r(this,"updateHashLater",new z(200));this.searchField=new g("search",l.SEARCH_PLACEHOLDER,"search","searchInput"),this.searchField.onChange=e=>{this.updateSearchResults(),this.updateHashLater.defer(()=>{E.open("search",{q:e})})},this.add(this.searchField),this.results=new h("div"),this.results.setClass("searchResults"),this.add(this.results)}async update(e,s){var n;if(_.instance==null){E.open("login",{});return}s&&(this.fileTree=await((n=_.instance)==null?void 0:n.walk(".")),this.searchField.value(e.q),this.updateSearchResults())}async updateSearchResults(e=50){let s=this.searchField.value();if(this.results.htmlElement.innerHTML="",this.fileTree==null){alert(l.SEARCH_FILETREE_IS_NULL);return}let n=this.flatten(this.fileTree);n=this.sortFilesByLastModified(n),n=this.sortFilesByRelevance(n,s),this.showNumResults(n);let i=n.length;n=n.slice(0,e);for(let a of n)this.results.add(new Q(a.filepath,$(a.modified)));if(i>e){let a=new h("div");a.htmlElement.innerText=l.SEARCH_MORE_RESULTS,a.setClass("searchMoreResults"),a.htmlElement.onclick=()=>{this.updateSearchResults(e+25)},this.results.add(a)}}showNumResults(e){let s=new h("div");s.htmlElement.innerText=e.length+" "+l.SEARCH_NUM_RESULTS,s.setClass("searchNumResults"),this.results.add(s)}sortFilesByRelevance(e,s){let n=s.toLowerCase().split(",").map(d=>d.trim()),i=[];for(let d of e){let{filename:m,folder:p}=x(d.filepath);var a=0;for(let f of n){if(f==""){a=1;continue}let u=f.startsWith("!");m.toLowerCase().includes(f)&&(a+=100),!u&&p.toLowerCase().includes(f)&&(a+=1),u&&p.toLowerCase().startsWith(f.substring(1))&&(a+=100)}a>0&&i.push({filepath:d.filepath,modified:d.modified,score:a})}return i.sort((d,m)=>m.score-d.score)}sortFilesByLastModified(e){return e.sort((s,n)=>n.modified.toISOString().localeCompare(s.modified.toISOString()))}flatten(e,s="",n=[]){for(const i in e){const a=e[i];typeof a!="string"?n=this.flatten(a,s+i+"/",n):n.push({filepath:s+i,modified:new Date(a)})}return n}}class Q extends h{constructor(t,e){super("div"),this.setClass("searchResult");let{filename:s,folder:n}=x(t),i=s.split("."),a=i[i.length-1].toLowerCase();if(localStorage.kb_allow_img_previews=="true"&&(a=="png"||a=="jpg"||a=="jpeg")||localStorage.kb_allow_pdf_previews=="true"&&a=="pdf"){let u=document.createElement("img");u.classList.add("searchResultPreview"),u.onerror=()=>{let S=document.createElement("div");S.innerHTML="<BR>"+a.toUpperCase(),S.classList.add("searchResultPreview"),this.htmlElement.replaceChild(S,this.htmlElement.childNodes[0])},u.src=_.instance.readURL(t,!0),this.htmlElement.appendChild(u)}else if(localStorage.kb_allow_txt_previews=="true"&&(a=="txt"||a=="md"||a=="py"||a=="csv"||a=="json")){let u=document.createElement("div");u.style.fontSize="1em",u.style.textAlign="left",u.innerHTML="loading...",Z.getTxtPreview(t).then(S=>{let I=S.split(`
`);I=I.map((C,re,le)=>C.startsWith("#")?"<b style='font-size: 1.2em'>"+C+"</b>":C),S=I.join("<BR>"),u.innerHTML=S}),u.classList.add("searchResultPreview"),this.htmlElement.appendChild(u)}else{let u=document.createElement("div");u.innerHTML="<BR>"+a.toUpperCase(),u.classList.add("searchResultPreview"),this.htmlElement.appendChild(u)}let d=document.createElement("div");d.classList.add("searchResultMeta"),this.htmlElement.appendChild(d);let m=document.createElement("div");m.innerText=s,m.classList.add("searchResultFilename"),d.appendChild(m);let p=document.createElement("div");p.innerText=l.SEARCH_LAST_MODIFIED+": "+e,p.classList.add("searchResultModified"),d.appendChild(p);let f=document.createElement("div");f.innerText=n,f.classList.add("searchResultFolder"),d.appendChild(f),this.htmlElement.onclick=()=>{E.open("edit",{folder:n,filename:s})}}}function x(o){let t=o.split("/"),e=t.pop(),s=t.join("/");return s==""&&(s="."),{filename:e,folder:s}}class Z{constructor(){}static async getTxtPreview(t){let e=JSON.parse(localStorage.getItem("kb_preview_cache")||"{}");if(e[t])return console.log("cached"),e[t];let s=await _.instance.readTxt(t);if(s!=null){let n=s.split(`
`).slice(0,13);n=n.map((a,d,m)=>a.slice(0,40)),s=n.join(`
`);let i=JSON.parse(localStorage.getItem("kb_preview_cache")||"{}");return i[t]=s,localStorage.setItem("kb_preview_cache",JSON.stringify(i)),s}return"error loading preview"}static async getImgPreview(t){return""}}class ee extends h{constructor(){super("div");r(this,"iframe");this.iframe=document.createElement("iframe"),this.iframe.name="editFrame",this.iframe.classList.add("editFrame"),this.htmlElement.appendChild(this.iframe)}async update(e,s){var n;if(_.instance==null){E.open("login",{});return}(n=_.instance)==null||n.read(e.folder+"/"+e.filename,"editFrame")}hide(){this.iframe.src="about:blank",super.hide()}}const te="/knowledgebase/assets/bars-solid-58a93446.svg",se="/knowledgebase/assets/xmark-solid-47781aaa.svg";let P="<image src='"+te+"' />",ne="<image src='"+se+"' />";class ie extends h{constructor(e,s,n){super("div");r(this,"toggleButton");r(this,"container");this.setClass(e),this.container=new h("div"),this.container.setClass(s),this.container.add(this),this.container.hide(),this.toggleButton=new T(P,n),this.toggleButton.onClick=this.toggleVisibility.bind(this)}addToDivById(e){var s,n;(s=document.getElementById(e))==null||s.appendChild(this.container.htmlElement),(n=document.getElementById(e))==null||n.appendChild(this.toggleButton.htmlElement)}update(){}toggleVisibility(){this.container.isVisible()?(this.container.hide(),this.toggleButton.htmlElement.innerHTML=P):(this.toggleButton.htmlElement.innerHTML=ne,this.update(),this.container.show())}}class ae extends ie{constructor(){super("settingsOverlayContent","settingsOverlay","settingsToggle"),this.addToDivById("global"),this.add(new h("div",l.SETTINGS_TITLE,"settingsTitle")),this.add(new h("div",l.SETTINGS_GENERAL,"settingsSubtitle")),this.add(new h("div",l.SETTINGS_DISPLAY,"settingsSubtitle"));let t=new N("showTxtPreviews",l.SETTINGS_SHOW_TXT_PREVIEWS,"settingsCheckbox",localStorage.kb_allow_txt_previews=="true");t.onChange=i=>{localStorage.kb_allow_txt_previews=i},this.add(t);let e=new N("showImgPreviews",l.SETTINGS_SHOW_IMG_PREVIEWS,"settingsCheckbox",localStorage.kb_allow_img_previews=="true");e.onChange=i=>{localStorage.kb_allow_img_previews=i},this.add(e);let s=new N("showPDFPreviews",l.SETTINGS_SHOW_PDF_PREVIEWS,"settingsCheckbox",localStorage.kb_allow_pdf_previews=="true");s.onChange=i=>{localStorage.kb_allow_pdf_previews=i},this.add(s),this.add(new h("div",l.SETTINGS_CONNECTION,"settingsSubtitle"));let n=new T(l.SETTINGS_SELECT_SERVER,"buttonWide");n.onClick=()=>{this.toggleVisibility(),E.open("login",{})},this.add(n)}update(){}}async function oe(){G(),document.getElementsByTagName("title")[0].innerHTML=l.APPNAME,await Y(),new E("search",{search:new X,login:new W,edit:new ee}),new ae}oe();
