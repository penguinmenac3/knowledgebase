var ft=Object.defineProperty;var mt=(h,n,e)=>n in h?ft(h,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[n]=e;var d=(h,n,e)=>mt(h,typeof n!="symbol"?n+"":n,e);(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))t(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&t(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function t(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();class g{constructor(){}static APPLY_COUNTED(n,e){return e.replace("{count}",n.toString())}}d(g,"TIME_LOCALE","en"),d(g,"TIME_YESTERDAY","yesterday"),d(g,"TIME_HOURS_AGO","{count} hour(s) ago"),d(g,"TIME_MINUTES_AGO","{count} minute(s) ago"),d(g,"TIME_SECONDS_AGO","{count} second(s) ago"),d(g,"TIME_TODAY_AT","today at"),d(g,"TIME_JUST_NOW","just now"),d(g,"APPNAME","Knowledgebase"),d(g,"LOGIN_KNOWN_CONNECTIONS","Reuse Connection"),d(g,"LOGIN_SESSION_NAME","Session Name"),d(g,"LOGIN_API_ENDPOINT_LABEL","API Endpoint URL"),d(g,"LOGIN_API_TOKEN_LABEL","API Token"),d(g,"LOGIN_SUBMIT","Add Connection"),d(g,"LOGIN_ALL_CONNECTIONS","All"),d(g,"LOGIN_ERROR_MISSING_INPUTS","You must provide all fields (session name, api endpoint and api token)."),d(g,"LOGIN_ERROR_LOGIN_FAILED","The provided login information is wrong. Is the URL and API token correct?"),d(g,"LOGIN_OFFLINE_MODAL_QUESTION","Cannot connect to server. Do you want to continue in offline mode? Offline mode might show you outdated files and data."),d(g,"LOGIN_OFFLINE_MODAL_CONFIRM","Continue offline"),d(g,"LOGIN_OFFLINE_MODAL_CANCEL","Return to login"),d(g,"FILETREE_MISSING_CONNECTIONS","Add a server via settings!"),d(g,"FILETREE_FILETREE_IS_NULL","Cannot retrieve filetree. Maybe you have a weak internet connection?"),d(g,"FILETREE_SEARCH_PLACEHOLDER","Search (Keyword, Keyword)"),d(g,"FILETREE_OFFLINE","Offline:"),d(g,"FILETREE_MORE_RESULTS","Show more results!"),d(g,"FILETREE_DELETE_QUESTION","Are you sure you want to delete this file?"),d(g,"FILETREE_DELETE_CONFIRM","Delete"),d(g,"FILETREE_DELETE_CANCEL","Keep File"),d(g,"FILETREE_RENAME_CURRENT_PATH","Current Path"),d(g,"FILETREE_RENAME_NEW_PATH","New Path"),d(g,"FILETREE_RENAME_CONFIRM","Rename"),d(g,"FILETREE_INVALID_SESSION","You appear to have a broken session. Try to remove it and add it again."),d(g,"SETTINGS_TITLE","Settings"),d(g,"SETTINGS_GENERAL","General"),d(g,"SETTINGS_LIST_CONNECTIONS","Connections"),d(g,"SETTINGS_ADD_CONNECTION","Add New Connection"),d(g,"SETTINGS_REMOVE_CONNECTION","delete"),d(g,"SETTINGS_REMOVE_CONNECTION_QUESTION","Are you sure you want to delete this connection?"),d(g,"SETTINGS_REMOVE_CONNECTION_CONFIRM","Yes, delete this connection."),d(g,"SETTINGS_REMOVE_CONNECTION_CANCEL","No, keep this connection."),d(g,"UPLOAD_TITLE","Upload File"),d(g,"UPLOAD_SERVER","Server"),d(g,"UPLOAD_FOLDERNAME","Foldername"),d(g,"UPLOAD_LOCATION","Location: "),d(g,"UPLOAD_FILENAME","Filename"),d(g,"UPLOAD_FILE","File"),d(g,"UPLOAD_FILE_OPTIONAL","File (optional)"),d(g,"UPLOAD_SEND","Upload File"),d(g,"UPLOAD_MARKDOWN","Empty File"),d(g,"UPLOAD_FAILED","Upload failed. Reasons could be: The file already exists, the folder is invalid or the server is currently unreachable."),d(g,"VIEWER_READ_FILE_ERROR","Cannot read file or reach server. Maybe your internet connection is too weak or the server is down."),d(g,"VIEWER_SAVE_FILE_ERROR","Cannot save file. It was either changed on the server or you have too weak internet."),d(g,"VIEWER_READ_MD5_ERROR","Cannot read md5 of file. Maye there was an error saving or your internet is weak."),d(g,"VIEWER_EXIT_WITHOUT_SAVE_QUESTION","You did not save your changes. Do you want to exit anyways or continue editing?"),d(g,"VIEWER_EXIT_WITHOUT_SAVE_EXIT","Exit (Discard Changes)"),d(g,"VIEWER_EXIT_WITHOUT_SAVE_CONTINUE_EDITING","Continue Editing"),d(g,"VIEWER_LOAD_HERE_FILE","Open (here)"),d(g,"VIEWER_UPLOAD_HEADING","Update File"),d(g,"VIEWER_UPLOAD_BTN","Upload"),d(g,"VIEWER_UNSAVED_CHANGES","You cannot open a new file while having a file with unsaved changes open!"),d(g,"MD_EMPTY_CELL","Empty, click to add text!"),d(g,"NOTEPAD_CLEAR_QUESTION","Are you sure you want to clear the document? This will delete all strokes and content of it irreversibly!"),d(g,"NOTEPAD_CLEAR_CONFIRM","Yes, delete it"),d(g,"NOTEPAD_CLEAR_CANCEL","No, keep it"),d(g,"NOTEPAD_IMPORT_QUESTION","What file do you want to import (*.spf.svg or *.spf)? Note: Importing will overwrite content currently displayed."),d(g,"NOTEPAD_IMPORT_CONFIRM","Import"),d(g,"NOTEPAD_IMPORT_UNSUPPORTED_FILE","ERROR: Only *.spf and *.spf.svg are supported filetypes.");class we extends g{}d(we,"TIME_LOCALE","de"),d(we,"APPNAME","Wissensdatenbank");let m=g;function gt(){switch(localStorage.language){case"de":m=we;break;case"en":case"us":default:m=g;break}}const ae=class ae{constructor(n){d(this,"apiEndpoint","");d(this,"sessionToken","");this.session_name=n,this.loadSessionConfig(),ae.connections.set(n,this)}getSessionName(){return this.session_name}loadSessionConfig(){if(localStorage.webfs_sessions){let n=JSON.parse(localStorage.webfs_sessions);if(this.session_name in n){let e=n[this.session_name];this.apiEndpoint=e.apiEndpoint,this.sessionToken=e.sessionToken}}}writeSessionConfig(n,e){this.apiEndpoint=n,this.sessionToken=e;let t={};localStorage.webfs_sessions&&(t=JSON.parse(localStorage.webfs_sessions)),t[this.session_name]={apiEndpoint:this.apiEndpoint,sessionToken:e},localStorage.webfs_sessions=JSON.stringify(t)}removeSession(){if(localStorage.webfs_sessions){let n=JSON.parse(localStorage.webfs_sessions);delete n[this.session_name],localStorage.webfs_sessions=JSON.stringify(n)}}async request(n){n.append("token",this.sessionToken);const e={method:"POST",body:n};try{return await fetch(this.apiEndpoint,e)}catch{return console.log("Cannot reach server. It appears you are offline."),null}}async ping(){let n=new FormData;n.append("cmd","ping"),n.append("uri",".");let e=await this.request(n);return e==null?!1:e.status!=200?(console.error(e.text()),!1):await e.text()=="pong"}async login(n,e){let t=new FormData;t.append("cmd","login"),t.append("uri","."),t.append("token",e);const s={method:"POST",body:t};let i;try{i=await fetch(n,s)}catch{return alert("Cannot connect to server. Do you have a working internet connection?"),!1}if(i.status!=200)return console.error(i.text()),!1;let o=await i.text();return this.writeSessionConfig(n,o),!0}buildFileTree(n){return n}async list(n){let e=new FormData;e.append("cmd","list"),e.append("uri",n);let t=await this.request(e);return t==null?null:t.status!=200?(console.error(t.text()),null):await t.json()}async walk(n){let e=new FormData;e.append("cmd","walk"),e.append("uri",n);let t=await this.request(e);if(t==null)return null;if(t.status!=200)return console.error(t.text()),null;let s=await t.json();return this.buildFileTree(s)}async md5(n){let e=new FormData;e.append("cmd","md5"),e.append("uri",n);let t=await this.request(e);return t==null?null:t.status!=200?(console.error(t.text()),null):t.text()}async open(n){let e=new FormData;e.append("cmd","open"),e.append("uri",n);let t=await this.request(e);return t==null?!1:t.status!=200?(console.error(t.text()),!1):(await t.text(),!0)}async readTxt(n){let e=new FormData;e.append("cmd","read"),e.append("uri",n);let t=await this.request(e);return t==null?null:t.status!=200?(console.error(t.text()),null):t.text()}readURL(n,e=0){let t="";return e!=0&&(t="&subsample=1&width="+e.toFixed(0)+"&height="+e.toFixed(0)),this.apiEndpoint+"?token="+encodeURIComponent(this.sessionToken)+"&cmd=read&uri="+encodeURIComponent(n)+t}read(n,e="_self"){function t(o,l,r){let a=document.createElement("input");a.type="hidden",a.name=l,a.value=r,o.appendChild(a)}let s=document.getElementsByTagName("body")[0],i=document.createElement("form");i.action=this.apiEndpoint,i.method="post",i.target=e,t(i,"cmd","read"),t(i,"token",this.sessionToken),t(i,"uri",n),s.appendChild(i),i.submit(),s.removeChild(i)}async putTxt(n,e,t){var s=new Blob([e],{type:"text/plain;charset=utf-8"});return this.putFile(n,s,t)}async putFile(n,e,t){let s="",i=new FormData;i.append("cmd","write"),i.append("operation","write"),i.append("uri",n),i.append("file",e),i.append("md5",t+","+s);let o=await this.request(i);return o==null?!1:o.status!=200?(console.error(o.text()),!1):(await o.text(),!0)}async mkdir(n){let e=new FormData;e.append("cmd","write"),e.append("operation","mkdir"),e.append("uri",n);let t=await this.request(e);return t==null?!1:t.status!=200?(console.error(t.text()),!1):(await t.text(),!0)}async rmdir(n){let e=new FormData;e.append("cmd","write"),e.append("operation","rmdir"),e.append("uri",n);let t=await this.request(e);return t==null?!1:t.status!=200?(console.error(t.text()),!1):(await t.text(),!0)}async mv(n,e){let t=new FormData;t.append("cmd","write"),t.append("operation","mv"),t.append("uri",n),t.append("target",e);let s=await this.request(t);return s==null?!1:s.status!=200?(console.error(s.text()),!1):(await s.text(),!0)}async rm(n,e){let t=new FormData;t.append("cmd","write"),t.append("operation","rm"),t.append("uri",n),t.append("md5",e);let s=await this.request(t);return s==null?!1:s.status!=200?(console.error(s.text()),!1):(await s.text(),!0)}};d(ae,"connections",new Map);let L=ae;class E{constructor(n,e="",t=""){d(this,"parent",null);d(this,"htmlElement");d(this,"displayStyle","none");this.htmlElement=document.createElement(n),this.htmlElement.innerHTML=e,t!=""&&this.setClass(t)}add(n){this.htmlElement.appendChild(n.htmlElement),n.parent=this}addHtml(n,e,t=""){const s=document.createElement(n);return s.innerHTML=e,t!=""&&s.classList.add(t),this.htmlElement.appendChild(s),s}remove(n){this.htmlElement.removeChild(n.htmlElement),n.parent=null}removeHTML(n){this.htmlElement.removeChild(n)}isVisible(){return this.htmlElement.style.display.toLowerCase()!="none"}hide(){this.isVisible()&&(this.displayStyle=this.htmlElement.style.display,this.htmlElement.style.display="None")}show(){this.displayStyle.toLowerCase()!="none"&&(this.htmlElement.style.display=this.displayStyle)}update(n,e){}select(){this.setClass("selected")}unselect(){this.unsetClass("selected")}setClass(n){this.hasClass(n)||this.htmlElement.classList.add(n)}unsetClass(n){this.hasClass(n)&&this.htmlElement.classList.remove(n)}hasClass(n){return this.htmlElement.classList.contains(n)}}class C extends E{constructor(e,t="button"){super("a",e,t);d(this,"disabled",!1);this.htmlElement.onclick=s=>{this.disabled||(s.stopPropagation(),this.onClick())}}onClick(){console.log("Buttom::onClick: Not implemented! Must be implemented by subclass.")}disable(){this.disabled=!0,this.setClass("disabled")}enable(){this.disabled=!1,this.unsetClass("disabled")}}class wt extends E{constructor(n,...e){super("div","",n);for(const t of e)this.add(t)}submit(){let n=new FormData;for(const e in this.htmlElement.children){let t=this.htmlElement.children[e];t instanceof HTMLInputElement&&n.append(t.name,t.value)}this.onSubmit(n)}onSubmit(n){console.log("Form::onSubmit: Not implemented! Must be implemented by subclass."),console.log(n)}}class F extends E{constructor(n,e,t,s="formInput"){super("input","",s),this.htmlElement.name=n,this.htmlElement.placeholder=e,this.htmlElement.type=t,this.htmlElement.oninput=()=>{this.onChange(this.htmlElement.value)},this.htmlElement.onchange=()=>{this.onChangeDone(this.htmlElement.value)}}value(n=void 0){return n!==void 0&&(this.htmlElement.value=n),this.htmlElement.value}onChange(n){}onChangeDone(n){}}class A extends E{constructor(n,e="formLabel"){super("label",n,e)}}class yt extends C{onClick(){this.parent.submit()}}class D{constructor(n,e){d(this,"currentPage","");var t;this.defaultPage=n,this.pages=e;for(const s in e)(t=document.getElementById("app"))==null||t.appendChild(e[s].htmlElement),e[s].hide();window.onhashchange=s=>{this.onOpen()},location.hash.slice(1)==""?location.hash="#"+n:this.onOpen()}onOpen(){var o,l,r;let n={},e=location.hash.slice(1);e.length==0&&(e=this.defaultPage);let t=e.split("&"),s=t[0];t=t.splice(1);for(const a of t){let c=a.split("="),u=decodeURIComponent(c[0]),p=decodeURIComponent(c[1]);n[u]=p}let i=this.currentPage!=s;i&&((o=this.pages[this.currentPage])==null||o.hide(),this.currentPage=s,(l=this.pages[this.currentPage])==null||l.show()),(r=this.pages[this.currentPage])==null||r.update(n,i)}static open(n,e){window.setTimeout(()=>{let t="";for(let s in e)t+="&"+encodeURIComponent(s)+"="+encodeURIComponent(e[s]);location.hash="#"+encodeURIComponent(n)+t},200)}static update(n){let t=location.hash.slice(1).split("&"),s=t[0];t=t.splice(1);for(const i of t){let o=i.split("="),l=decodeURIComponent(o[0]),r=decodeURIComponent(o[1]);n.hasOwnProperty(l)||(n[l]=r)}window.setTimeout(()=>{let i="";for(let o in n)i+="&"+encodeURIComponent(o)+"="+encodeURIComponent(n[o]);location.hash="#"+encodeURIComponent(s)+i},200)}static back(){history.back()}}d(D,"DEBUG",!1);let Ye='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg>',Et='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 128 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M64 360a56 56 0 1 0 0 112 56 56 0 1 0 0-112zm0-160a56 56 0 1 0 0 112 56 56 0 1 0 0-112zM120 96A56 56 0 1 0 8 96a56 56 0 1 0 112 0z"/></svg>',Xe='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 352 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"/></svg>';class Ze extends E{constructor(e,t){var s;super("div");d(this,"container");this.setClass(e),this.container=new E("div"),this.container.setClass(t),this.container.add(this),(s=document.getElementById("global"))==null||s.appendChild(this.container.htmlElement)}dispose(){var e;this.onExit(),(e=document.getElementById("global"))==null||e.removeChild(this.container.htmlElement)}onExit(){}update(){}}class ce extends Ze{constructor(n,e,t,s,i){super(n,e),this.add(new E("p",t));let o=new C(s,"popupConfirmBtn");o.onClick=()=>{this.dispose(),this.onConfirm()},this.add(o);let l=new C(i,"popupCancelBtn");l.onClick=()=>{this.dispose(),this.onCancel()},this.add(l)}onConfirm(){console.log("ConfirmCancelPopup::onConfirm not implemented. Must be implemented by subclass.")}onCancel(){console.log("ConfirmCancelPopup::onCancel not implemented. Must be implemented by subclass.")}}class ee extends Ze{constructor(n="popupContent",e="popupContainer",t="popupExitBtn"){super(n,e);let s=new C(Xe,t);s.onClick=this.dispose.bind(this),this.add(s)}update(){}}let G="webfs";function xt(h){G=h}function bt(){let h=new wt("form",new A(m.LOGIN_SESSION_NAME),new F("sessionName","myserver","text"),new A(m.LOGIN_API_ENDPOINT_LABEL),new F("apiEndpoint","https://myserver/webfs/api.php","url"),new A(m.LOGIN_API_TOKEN_LABEL),new F("apiToken","a4ef9...","password"),new yt(m.LOGIN_SUBMIT,"buttonWide"));return h.onSubmit=_t,h}async function _t(h){let n=h.get("sessionName"),e=h.get("apiEndpoint"),t=h.get("apiToken");if(n==""||e==""||t==""||n==null||e==null||t==null){alert(m.LOGIN_ERROR_MISSING_INPUTS);return}if(await new L(n).login(e,t)){let i=[];localStorage[G+"_sessions"]&&(i=JSON.parse(localStorage[G+"_sessions"])),i.push(n),localStorage[G+"_sessions"]=JSON.stringify(i),D.back()}else L.connections.delete(n),alert(m.LOGIN_ERROR_LOGIN_FAILED)}function kt(){if(localStorage[G+"_sessions"]){let h=JSON.parse(localStorage[G+"_sessions"]);if(h.length>0)for(let n of h)new L(n)}}function Re(){return window.innerWidth<768}const H=class H extends E{constructor(e,t,s,i="master-detail-view"){super("div","",i);d(this,"isSidepanelResizing",!1);d(this,"isMasterResizing",!1);d(this,"preferredView","master");d(this,"master");d(this,"detail");d(this,"sidepanel",null);d(this,"leftHandleWidth",0);d(this,"rightHandleWidth",0);this.masterContent=e,this.detailContent=t,this.sidepanelContent=s,this.master=new E("div","","master"),this.detail=new E("div","","detail"),window.setTimeout(()=>{let o=getComputedStyle(this.detail.htmlElement);this.leftHandleWidth=parseFloat(o.getPropertyValue("border-left-width")),this.rightHandleWidth=parseFloat(o.getPropertyValue("border-right-width")),this.adjustLayout()},100),this.setupLayout(),this.addEventListeners()}setupLayout(){this.master.add(this.masterContent),this.add(this.master),this.detail.add(this.detailContent),this.add(this.detail),this.sidepanelContent!=null&&(this.sidepanel=new E("div","","sidepanel"),this.sidepanel.add(this.sidepanelContent),this.add(this.sidepanel))}addEventListeners(){window.addEventListener("resize",()=>this.adjustLayout()),this.detail.htmlElement.addEventListener("mousedown",e=>this.startResizing(e)),window.addEventListener("mousemove",e=>this.onResize(e)),window.addEventListener("mouseup",()=>this.endResizing()),document.addEventListener("keydown",e=>{if(e.ctrlKey&&e.key==="B"){e.preventDefault();let[t,s]=this.getStoredPanelSizes();e.altKey?s>0?s=0:s=30:t>0?t=0:t=30,localStorage.setItem("webui_masterDetailViewPanelSizes",`${t},${s}`),this.adjustLayout()}})}update(e,t){var s;this.masterContent.update(e,t),this.detailContent.update(e,t),(s=this.sidepanelContent)==null||s.update(e,t)}setPreferedView(e){if(!["master","detail"].includes(e))throw new Error("Invalid preferred view. Please choose 'master' or 'detail'.");this.preferredView=e,this.adjustLayout()}adjustLayout(){Re()?this.adjustLayoutForSmallScreens():this.adjustLayoutForLargeScreens()}adjustLayoutForSmallScreens(){var e;this.detail.htmlElement.style.borderLeftWidth="0px",this.detail.htmlElement.style.borderRightWidth="0px",this.preferredView==="detail"?(this.master.hide(),this.detail.show()):(this.detail.hide(),this.master.show()),(e=this.sidepanel)==null||e.hide(),this.detail.htmlElement.style.width="100%",this.master.htmlElement.style.width="100%"}adjustLayoutForLargeScreens(){var s,i,o;this.detail.htmlElement.style.borderLeftWidth="",this.detail.htmlElement.style.borderRightWidth="",this.master.show(),this.detail.show(),(s=this.sidepanel)==null||s.show();let[e,t]=this.getStoredPanelSizes();[e,t]=this.autohideSmallPanels(e,t),this.master.htmlElement.style.width=`${e}%`,e==0?this.masterContent.hide():this.masterContent.show(),this.sidepanel!=null&&(this.sidepanel.htmlElement.style.width=`${t}%`,t==0?(i=this.sidepanelContent)==null||i.hide():(o=this.sidepanelContent)==null||o.show()),this.detail.htmlElement.style.width=100-(e+t)+"%"}getStoredPanelSizes(){let e=localStorage.getItem("webui_masterDetailViewPanelSizes");e||(e="30,0");let[t,s]=e.split(",").map(Number);return this.sidepanel==null&&(s=0),[t,s]}autohideSmallPanels(e,t){const s=this.htmlElement.clientWidth;return e*s/100<H.MIN_PANEL_WIDTH&&(e=0),t*s/100<H.MIN_PANEL_WIDTH&&(t=0),[e,t]}startResizing(e){if(Re())return;const t=this.detail.htmlElement.getBoundingClientRect();e.clientX-t.left<=this.leftHandleWidth&&(this.isMasterResizing=!0,e.preventDefault()),t.right-e.clientX<=this.rightHandleWidth&&(this.isSidepanelResizing=!0,e.preventDefault())}onResize(e){if(!this.isMasterResizing&&!this.isSidepanelResizing)return;const t=this.htmlElement.clientWidth;let[s,i]=this.getStoredPanelSizes();this.isMasterResizing?(s=e.clientX/t*100,s=Math.max(0,Math.min(s,50)),s<H.MIN_PANEL_WIDTH/t*100&&(s=0)):this.isSidepanelResizing&&(i=100-e.clientX/t*100,i=Math.max(0,Math.min(i,50)),i<H.MIN_PANEL_WIDTH/t*100&&(i=0)),localStorage.setItem("webui_masterDetailViewPanelSizes",`${s},${i}`),window.dispatchEvent(new Event("resize"))}endResizing(){this.isMasterResizing=!1,this.isSidepanelResizing=!1}};d(H,"MIN_PANEL_WIDTH",200);let ye=H;const Tt=6,Ct=6,St=10,vt=12,It=.001,Pe=31557600,Oe=2629800,Ne=86400,Ae=3600,Fe=60;function Lt(h,n="long"){let e=new Date;const t=ze(e,h),{hours:s,minutes:i,seconds:o}=t;let l=new Date(e.toISOString().substring(0,10)),r=new Date(h.toISOString().substring(0,10));const a=ze(l,r),{years:c,months:u,days:p}=a;return c>100?"unknown":c>0||u>Ct?Me(h,{includeYear:!0,length:n}):u>0||p>Tt?Me(h,{includeYear:!1,length:n}):p>1?h.toLocaleDateString(m.TIME_LOCALE,{weekday:n}):p===1?m.TIME_YESTERDAY:s>vt?m.TIME_TODAY_AT+" "+h.toLocaleTimeString(m.TIME_LOCALE,{hour:"numeric",minute:"2-digit"}):s>0?m.APPLY_COUNTED(s,m.TIME_HOURS_AGO):i>0?m.APPLY_COUNTED(i,m.TIME_MINUTES_AGO):o>St?m.APPLY_COUNTED(o,m.TIME_SECONDS_AGO):m.TIME_JUST_NOW}function Me(h,{includeYear:n,length:e}){const t=h.toLocaleDateString(m.TIME_LOCALE,{month:e});let i=`${h.getDate().toString()}. ${t}`;return n&&(i+=` ${h.getFullYear()}`),i}function De(h){return Math.floor(h*It)}function ze(h,n){const e={years:0,months:0,days:0,hours:0,minutes:0,seconds:0};let t=De(h.valueOf())-De(n.valueOf());return e.years=Math.floor(t/Pe),t-=e.years*Pe,e.months=Math.floor(t/Oe),t-=e.months*Oe,e.days=Math.floor(t/Ne),t-=e.days*Ne,e.hours=Math.floor(t/Ae),t-=e.hours*Ae,e.minutes=Math.floor(t/Fe),t-=e.minutes*Fe,e.seconds=t,e}class Rt extends ee{constructor(){super("popupContent-fullscreen","popupContainer","popupExitBtn"),this.add(new E("div",m.SETTINGS_TITLE,"popupTitle")),this.add(new E("div",m.SETTINGS_LIST_CONNECTIONS,"popupSubtitle")),L.connections.forEach(n=>{let e=n.getSessionName(),t=new C(m.SETTINGS_REMOVE_CONNECTION);t.setClass("buttonBad"),t.onClick=()=>{let i=new ce("popupContent","popupContainer",m.SETTINGS_REMOVE_CONNECTION_QUESTION,m.SETTINGS_REMOVE_CONNECTION_CONFIRM,m.SETTINGS_REMOVE_CONNECTION_CANCEL);i.onConfirm=()=>{let o=JSON.parse(localStorage.kb_sessions);o=o.filter(l=>l!==e),localStorage.kb_sessions=JSON.stringify(o),n.removeSession(),location.reload()},i.show()};let s=new E("div","","popupServer");s.addHtml("div",e,"settingsServerName"),s.add(t),this.add(s)}),this.add(new E("div",m.SETTINGS_ADD_CONNECTION,"popupSubtitle")),this.add(bt())}update(){}}function Qe(h){let n=h.split("/"),e=n.pop(),t=n.join("/");return t==""&&(t="."),{filename:e,folder:t}}class Pt extends E{constructor(n,e,t,s,i,o){super("div","","searchResult");let{filename:l,folder:r}=Qe(n),a=r;a=="."&&(a=""),this.htmlElement.innerHTML=l+"<BR><span class='searchResultInfo'>"+e+"/"+a+"</span>";let c=l.split(".");s&&c.push("DIR"),this.htmlElement.onclick=()=>{if(s)i.htmlElement.value="/"+n,i.onChange(i.htmlElement.value),i.onChangeDone(i.htmlElement.value);else{let u=e+":"+r+"/"+l;D.update({view:u})}}}}function Ot(h,n){let e=[];for(let[t,s]of h)e=e.concat(Je(t,s));return e=Ft(e),e=At(e),e=Nt(e,n),e}function Nt(h,n){let e=n.toLowerCase().split(",").map(i=>i.trim()),t=[];for(let i of h){let{filename:o,folder:l}=Qe(i.filepath);o=o.toLowerCase(),l=l.toLowerCase();var s=0;for(let r of e){if(r==""){s+=1;continue}let a=r.startsWith("/"),c=r.substring(1);c==""&&(c="."),!a&&o.includes(r)&&(s+=100,i.isFolder&&(s+=10)),a&&i.isFolder&&o.includes(c)&&i.filepath.toLowerCase()!=c&&(s+=125,o==c&&(s+=25)),a&&l==c&&(s+=100,i.isFolder&&(s+=10))}s>0&&(o.includes(".fav")&&(s+=3),o.includes(".todo")&&(s+=4),t.push({filepath:i.filepath,sessionName:i.sessionName,modified:i.modified,isFolder:i.isFolder,score:s}))}return t.sort((i,o)=>o.score-i.score)}function At(h){return h.sort((n,e)=>n.modified==null?1:e.modified==null?-1:e.modified.toISOString().localeCompare(n.modified.toISOString()))}function Ft(h){return h.sort((n,e)=>n.filepath==null?1:e.filepath==null?-1:n.filepath.localeCompare(e.filepath))}function Je(h,n,e="",t=[]){for(const i in n){var s=n[i];typeof s!="string"?(t=Je(h,s,e+i+"/",t),t.push({filepath:e+i,sessionName:h,modified:null,isFolder:!0})):(s.indexOf("GMT")<0&&(s+=" GMT+0000"),t.push({filepath:e+i,sessionName:h,modified:new Date(s),isFolder:!1}))}return t}class Mt extends ee{constructor(n,e,t){super("popupContent-fullscreen","popupContainer","popupExitBtn"),this.setClass("upload");let s=n.split(":")[0],i=n.split(":")[1];this.add(new E("div",m.UPLOAD_TITLE,"popupTitle")),this.add(new A(m.UPLOAD_SERVER+": "+s)),this.add(new A(m.UPLOAD_FOLDERNAME+": "+i)),this.add(new A(m.UPLOAD_FILENAME));let o=new F("filename",e,"text");o.value(e),this.add(o);let l=new C(m.UPLOAD_MARKDOWN,"buttonWide");l.onClick=async()=>{let c=L.connections.get(s);if(c==null)return;a.disable(),l.disable(),i.endsWith("/")&&(i=i.slice(0,i.length-1));let u=o.value(),p=i+"/"+u,f=await c.putTxt(p,"","");a.enable(),l.enable(),f?(this.dispose(),t()):alert(m.UPLOAD_FAILED)},this.add(l),this.add(new A(m.UPLOAD_FILE_OPTIONAL));let r=new F("file","","file","fileInput");r.onChangeDone=c=>{if(o.value()==""){let u=c.replaceAll("\\","/").split("/");o.value(u[u.length-1])}},this.add(r);let a=new C(m.UPLOAD_SEND,"buttonWide");a.onClick=async()=>{let c=L.connections.get(s);if(c==null)return;a.disable(),l.disable();let u=r.htmlElement.files[0];i.endsWith("/")&&(i=i.slice(0,i.length-1));let p=o.value(),f=i+"/"+p,y=await c.putFile(f,u,"");a.enable(),l.enable(),y?(this.dispose(),t()):alert(m.UPLOAD_FAILED)},this.add(a)}update(){}}class Dt extends ee{constructor(n,e,t,s){super("popupContent-fullscreen","popupContainer","popupExitBtn"),this.setClass("upload"),this.add(new E("div",m.UPLOAD_TITLE,"popupTitle")),this.add(new A(m.UPLOAD_FILE));let i=new F("file","","file","fileInput");this.add(i);let o=new C(m.UPLOAD_SEND,"buttonWide");o.onClick=async()=>{if(n==null)return;o.disable();let l=i.htmlElement.files[0],r=await n.putFile(e,l,t);o.enable(),r?(this.dispose(),s()):alert(m.UPLOAD_FAILED)},this.add(o)}update(){}}class zt extends E{constructor(){super("div","","filetree");d(this,"searchField");d(this,"entriesView");d(this,"fileTrees",new Map);d(this,"offlineConnections",[]);this.searchField=new F("search",m.FILETREE_SEARCH_PLACEHOLDER,"search","filetreeSearch"),this.searchField.onChange=t=>{this.updateEntriesView()},this.searchField.onChangeDone=t=>{D.update({search:t})},this.add(this.searchField),this.entriesView=new E("div"),this.entriesView.setClass("filetreeEntries"),this.add(this.entriesView);let e=new C(Ye,"filetreeSettingsButton");e.onClick=()=>{new Rt},this.add(e)}triggerFullUpdate(){this.update({search:this.searchField.value()},!0)}async update(e,t){if(L.connections.size<1){this.entriesView.htmlElement.innerHTML=m.FILETREE_MISSING_CONNECTIONS;return}t&&(this.offlineConnections=[],this.fileTrees.clear()),(this.searchField.value()!=e.search||t)&&(this.searchField.value(e.search),this.updateEntriesView())}async getFileTree(e){console.log("Gathering filetrees for: "+e);let t=L.connections.get(e);if(!t)return null;let s=await t.walk(".");if(s==null){console.log("Session offline: "+e);let i=localStorage["kb_filetree_cache_"+e];i&&(s=JSON.parse(i)),this.offlineConnections.push(e)}else{let i=JSON.stringify(s);localStorage["kb_filetree_cache_"+e]=i}return s!=null&&this.fileTrees.set(e,s),s}async updateEntriesView(e=50){this.entriesView.htmlElement.innerHTML="",this.showOfflineStatus();let t=this.searchField.value();t==""?await this.renderFiletreeView():await this.renderSearchResults(t,e)}showOfflineStatus(){let e="";for(let t of this.offlineConnections)e==""&&(e=m.FILETREE_OFFLINE),e+=" "+t;if(e!=""){let t=new E("div",e,"filetreeOfflineStatus");this.entriesView.add(t)}}async renderSearchResults(e,t){let s=Ot(this.fileTrees,e),i=s.length;s=s.slice(0,t);for(let o of s)this.entriesView.add(new Pt(o.filepath,o.sessionName,o.modified!=null?Lt(o.modified):"",o.isFolder,this.searchField,this.triggerFullUpdate.bind(this)));if(i>t){let o=new E("div");o.htmlElement.innerText=m.FILETREE_MORE_RESULTS,o.htmlElement.onclick=()=>{this.updateEntriesView(t+25)},this.entriesView.add(o)}}async renderFiletreeView(){this.entriesView.htmlElement.innerHTML="";let e=new E("ul","","filetreeRoot");for(let t of L.connections.keys())e.add(new xe("",t,null,async()=>await this.getFileTree(t)));this.entriesView.add(e)}}class Ke extends E{constructor(e,t,s,i){super("li","",s?"fileTreeFolder":"fileTreeFile");d(this,"elementSettings");this.path=e,this.name=t,this.isFolder=s,this.hasChildren=i,this.elementSettings=new C(Et,"fileTreeElementSettings"),this.elementSettings.setClass("right"),this.elementSettings.onClick=()=>{this.showMenu()},this.add(this.elementSettings);let o=new C("","fileTreeElementTitle");o.onClick=()=>{this.onClick()};let l=s?"filetreeFolderIcon":"filetreeFileIcon";e==""&&(l="filetreeServerIcon"),o.htmlElement.innerHTML+=`<span class="${l}"></span> ${t.replaceAll("_"," ")}`,this.add(o)}onClick(){}showMenu(){let e=new Ht(this,this.isFolder,this.path!="",!this.hasChildren&&this.path!="");e.htmlElement.style.display="block",e.htmlElement.style.position="absolute";const t=this.elementSettings.htmlElement.getBoundingClientRect();let s=(t.left+t.right)/2,i=(t.top+t.bottom)/2,o=window.innerWidth,l=window.innerHeight,r=o-s,a=l-i;console.log(e.htmlElement.getBoundingClientRect()),console.log(a,e.htmlElement.clientHeight),console.log(r,e.htmlElement.clientWidth),a<e.htmlElement.clientHeight?e.htmlElement.style.top=`${i-e.htmlElement.clientHeight}px`:e.htmlElement.style.top=`${i}px`,r<e.htmlElement.clientWidth?e.htmlElement.style.left=`${s-e.htmlElement.clientWidth}px`:e.htmlElement.style.left=`${s}px`}getURI(){let e=this.path+"/"+this.name;return e=e.replace("/","").replace("/",":./"),e.includes(":./")||(e=e+":./"),e}async newFile(){new Mt(this.getURI(),"",()=>location.reload())}async newFolder(){let e=this.getURI(),t=e.split(":")[0],s=e.split(":")[1],i=L.connections.get(t);if(i==null){alert(m.FILETREE_INVALID_SESSION);return}i.mkdir(s+"/New Folder"),location.reload()}async rename(){let e=this.getURI(),t=e.split(":")[0],s=e.split(":")[1],i=L.connections.get(t);if(i==null){alert(m.FILETREE_INVALID_SESSION);return}let o=new ee;o.htmlElement.style.width="87%",o.htmlElement.style.maxWidth="40em",o.add(new A(m.FILETREE_RENAME_CURRENT_PATH));let l=new F("current_path","","text");l.value(s),l.htmlElement.disabled=!0,o.add(l),o.add(new A(m.FILETREE_RENAME_NEW_PATH));let r=new F("current_path","","text");r.value(s),o.add(r);let a=new C(m.FILETREE_RENAME_CONFIRM,"buttonWide");a.setClass("good"),a.onClick=()=>{i.mv(s,r.value()),location.reload()},o.add(a)}async delete(){let e=this.getURI(),t=e.split(":")[0],s=e.split(":")[1],i=L.connections.get(t);if(i==null){alert(m.FILETREE_INVALID_SESSION);return}let o="";if(!this.isFolder&&await i.md5(s)==null){alert(m.VIEWER_READ_MD5_ERROR);return}let l=new ce("popupContent","popupContainer",m.FILETREE_DELETE_QUESTION+" "+this.path+"/"+this.name,m.FILETREE_DELETE_CANCEL,m.FILETREE_DELETE_CONFIRM);l.onConfirm=()=>{},l.onCancel=()=>{this.isFolder?i.rmdir(s):i.rm(s,o),location.reload()}}}class xe extends Ke{constructor(e,t,s,i=null){super(e,t,!0,s==null||Object.keys(s).length>0);d(this,"folderContent");this.children=s,this.getChildren=i,this.folderContent=new E("ul"),this.folderContent.htmlElement.style.display="none",this.add(this.folderContent),this.isExpandedFolder()&&this.onClick()}isExpandedFolder(){return localStorage.kb_filetree_expanded_folders||(localStorage.kb_filetree_expanded_folders="[]"),JSON.parse(localStorage.kb_filetree_expanded_folders).includes(this.getURI())}setExpandedFolder(){if(!this.isExpandedFolder()){let e=JSON.parse(localStorage.kb_filetree_expanded_folders);e.push(this.getURI()),localStorage.kb_filetree_expanded_folders=JSON.stringify(e)}}unsetExpandedFolder(){if(this.isExpandedFolder()){let e=JSON.parse(localStorage.kb_filetree_expanded_folders),t=this.getURI();e=e.filter((s,i)=>s!=t),localStorage.kb_filetree_expanded_folders=JSON.stringify(e)}}async onClick(){if(this.folderContent.htmlElement.style.display==="none"){if(this.folderContent.htmlElement.style.display="",this.setExpandedFolder(),this.folderContent.htmlElement.children.length==0){let e=this.path+"/"+this.name,t=[],s=[],i=[];if(this.children==null){if(this.getChildren==null)return;this.children=await this.getChildren()}for(const o in this.children)i.push(o);i=i.sort((o,l)=>o.toLowerCase().localeCompare(l.toLowerCase()));for(const o of i){let l=this.children[o];typeof l!="string"?t.push(new xe(e,o,l)):s.push(new Vt(e,o))}for(const o of t)this.folderContent.add(o);for(const o of s)this.folderContent.add(o)}}else this.folderContent.htmlElement.style.display="none",this.unsetExpandedFolder()}}class Vt extends Ke{constructor(n,e){super(n,e,!1,!1)}onClick(){D.update({view:this.getURI()})}}class Ht extends E{constructor(e,t,s,i){super("div","","filetreeElementMenu");d(this,"background");if(t){let o=new C("New File","filetreeElementMenuButton");o.onClick=()=>{this.close(),e.newFile()},this.add(o);let l=new C("New Folder","filetreeElementMenuButton");l.onClick=()=>{this.close(),e.newFolder()},this.add(l)}if(s){let o=new C("Move","filetreeElementMenuButton");o.onClick=()=>{this.close(),e.rename()},this.add(o)}if(i){let o=new C("Delete","filetreeElementMenuButton");o.onClick=()=>{this.close(),e.delete()},this.add(o)}this.background=new E("div","","toolPopupGrayout"),this.background.htmlElement.onclick=()=>{this.close()},document.body.appendChild(this.background.htmlElement),document.body.appendChild(this.htmlElement)}close(){document.body.removeChild(this.background.htmlElement),document.body.removeChild(this.htmlElement)}}function be(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}let $=be();function et(h){$=h}const Q={exec:()=>null};function T(h,n=""){let e=typeof h=="string"?h:h.source;const t={replace:(s,i)=>{let o=typeof i=="string"?i:i.source;return o=o.replace(I.caret,"$1"),e=e.replace(s,o),t},getRegex:()=>new RegExp(e,n)};return t}const I={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] /,listReplaceTask:/^\[[ xX]\] +/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:h=>new RegExp(`^( {0,3}${h})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:h=>new RegExp(`^ {0,${Math.min(3,h-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:h=>new RegExp(`^ {0,${Math.min(3,h-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:h=>new RegExp(`^ {0,${Math.min(3,h-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:h=>new RegExp(`^ {0,${Math.min(3,h-1)}}#`),htmlBeginRegex:h=>new RegExp(`^ {0,${Math.min(3,h-1)}}<(?:[a-z].*>|!--)`,"i")},Ut=/^(?:[ \t]*(?:\n|$))+/,$t=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,Bt=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,te=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,Wt=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,tt=/(?:[*+-]|\d{1,9}[.)])/,nt=T(/^(?!bull |blockCode|fences|blockquote|heading|html)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html))+?)\n {0,3}(=+|-+) *(?:\n+|$)/).replace(/bull/g,tt).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).getRegex(),_e=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,Gt=/^[^\n]+/,ke=/(?!\s*\])(?:\\.|[^\[\]\\])+/,qt=T(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",ke).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),jt=T(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,tt).getRegex(),he="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",Te=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,Yt=T("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",Te).replace("tag",he).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),st=T(_e).replace("hr",te).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",he).getRegex(),Xt=T(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",st).getRegex(),Ce={blockquote:Xt,code:$t,def:qt,fences:Bt,heading:Wt,hr:te,html:Yt,lheading:nt,list:jt,newline:Ut,paragraph:st,table:Q,text:Gt},Ve=T("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",te).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",he).getRegex(),Zt={...Ce,table:Ve,paragraph:T(_e).replace("hr",te).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",Ve).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",he).getRegex()},Qt={...Ce,html:T(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",Te).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:Q,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:T(_e).replace("hr",te).replace("heading",` *#{1,6} *[^
]`).replace("lheading",nt).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},it=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,Jt=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,ot=/^( {2,}|\\)\n(?!\s*$)/,Kt=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,de=/[\p{P}\p{S}]/u,Se=/[\s\p{P}\p{S}]/u,lt=/[^\s\p{P}\p{S}]/u,en=T(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,Se).getRegex(),tn=/\[[^[\]]*?\]\((?:\\.|[^\\\(\)]|\((?:\\.|[^\\\(\)])*\))*\)|`[^`]*?`|<[^<>]*?>/g,nn=T(/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,"u").replace(/punct/g,de).getRegex(),sn=T("^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)","gu").replace(/notPunctSpace/g,lt).replace(/punctSpace/g,Se).replace(/punct/g,de).getRegex(),on=T("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,lt).replace(/punctSpace/g,Se).replace(/punct/g,de).getRegex(),ln=T(/\\(punct)/,"gu").replace(/punct/g,de).getRegex(),rn=T(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),an=T(Te).replace("(?:-->|$)","-->").getRegex(),cn=T("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",an).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),oe=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,hn=T(/^!?\[(label)\]\(\s*(href)(?:\s+(title))?\s*\)/).replace("label",oe).replace("href",/<(?:\\.|[^\n<>\\])+>|[^\s\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),rt=T(/^!?\[(label)\]\[(ref)\]/).replace("label",oe).replace("ref",ke).getRegex(),at=T(/^!?\[(ref)\](?:\[\])?/).replace("ref",ke).getRegex(),dn=T("reflink|nolink(?!\\()","g").replace("reflink",rt).replace("nolink",at).getRegex(),ve={_backpedal:Q,anyPunctuation:ln,autolink:rn,blockSkip:tn,br:ot,code:Jt,del:Q,emStrongLDelim:nn,emStrongRDelimAst:sn,emStrongRDelimUnd:on,escape:it,link:hn,nolink:at,punctuation:en,reflink:rt,reflinkSearch:dn,tag:cn,text:Kt,url:Q},un={...ve,link:T(/^!?\[(label)\]\((.*?)\)/).replace("label",oe).getRegex(),reflink:T(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",oe).getRegex()},Ee={...ve,escape:T(it).replace("])","~|])").getRegex(),url:T(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\.|[^\\])*?(?:\\.|[^\s~\\]))\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},pn={...Ee,br:T(ot).replace("{2,}","*").getRegex(),text:T(Ee.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},se={normal:Ce,gfm:Zt,pedantic:Qt},j={normal:ve,gfm:Ee,breaks:pn,pedantic:un},fn={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},He=h=>fn[h];function N(h,n){if(n){if(I.escapeTest.test(h))return h.replace(I.escapeReplace,He)}else if(I.escapeTestNoEncode.test(h))return h.replace(I.escapeReplaceNoEncode,He);return h}function Ue(h){try{h=encodeURI(h).replace(I.percentDecode,"%")}catch{return null}return h}function $e(h,n){var i;const e=h.replace(I.findPipe,(o,l,r)=>{let a=!1,c=l;for(;--c>=0&&r[c]==="\\";)a=!a;return a?"|":" |"}),t=e.split(I.splitPipe);let s=0;if(t[0].trim()||t.shift(),t.length>0&&!((i=t.at(-1))!=null&&i.trim())&&t.pop(),n)if(t.length>n)t.splice(n);else for(;t.length<n;)t.push("");for(;s<t.length;s++)t[s]=t[s].trim().replace(I.slashPipe,"|");return t}function Y(h,n,e){const t=h.length;if(t===0)return"";let s=0;for(;s<t;){const i=h.charAt(t-s-1);if(i===n&&!e)s++;else if(i!==n&&e)s++;else break}return h.slice(0,t-s)}function mn(h,n){if(h.indexOf(n[1])===-1)return-1;let e=0;for(let t=0;t<h.length;t++)if(h[t]==="\\")t++;else if(h[t]===n[0])e++;else if(h[t]===n[1]&&(e--,e<0))return t;return-1}function Be(h,n,e,t,s){const i=n.href,o=n.title||null,l=h[1].replace(s.other.outputLinkReplace,"$1");if(h[0].charAt(0)!=="!"){t.state.inLink=!0;const r={type:"link",raw:e,href:i,title:o,text:l,tokens:t.inlineTokens(l)};return t.state.inLink=!1,r}return{type:"image",raw:e,href:i,title:o,text:l}}function gn(h,n,e){const t=h.match(e.other.indentCodeCompensation);if(t===null)return n;const s=t[1];return n.split(`
`).map(i=>{const o=i.match(e.other.beginningSpace);if(o===null)return i;const[l]=o;return l.length>=s.length?i.slice(s.length):i}).join(`
`)}class le{constructor(n){d(this,"options");d(this,"rules");d(this,"lexer");this.options=n||$}space(n){const e=this.rules.block.newline.exec(n);if(e&&e[0].length>0)return{type:"space",raw:e[0]}}code(n){const e=this.rules.block.code.exec(n);if(e){const t=e[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:e[0],codeBlockStyle:"indented",text:this.options.pedantic?t:Y(t,`
`)}}}fences(n){const e=this.rules.block.fences.exec(n);if(e){const t=e[0],s=gn(t,e[3]||"",this.rules);return{type:"code",raw:t,lang:e[2]?e[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):e[2],text:s}}}heading(n){const e=this.rules.block.heading.exec(n);if(e){let t=e[2].trim();if(this.rules.other.endingHash.test(t)){const s=Y(t,"#");(this.options.pedantic||!s||this.rules.other.endingSpaceChar.test(s))&&(t=s.trim())}return{type:"heading",raw:e[0],depth:e[1].length,text:t,tokens:this.lexer.inline(t)}}}hr(n){const e=this.rules.block.hr.exec(n);if(e)return{type:"hr",raw:Y(e[0],`
`)}}blockquote(n){const e=this.rules.block.blockquote.exec(n);if(e){let t=Y(e[0],`
`).split(`
`),s="",i="";const o=[];for(;t.length>0;){let l=!1;const r=[];let a;for(a=0;a<t.length;a++)if(this.rules.other.blockquoteStart.test(t[a]))r.push(t[a]),l=!0;else if(!l)r.push(t[a]);else break;t=t.slice(a);const c=r.join(`
`),u=c.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");s=s?`${s}
${c}`:c,i=i?`${i}
${u}`:u;const p=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(u,o,!0),this.lexer.state.top=p,t.length===0)break;const f=o.at(-1);if((f==null?void 0:f.type)==="code")break;if((f==null?void 0:f.type)==="blockquote"){const y=f,w=y.raw+`
`+t.join(`
`),x=this.blockquote(w);o[o.length-1]=x,s=s.substring(0,s.length-y.raw.length)+x.raw,i=i.substring(0,i.length-y.text.length)+x.text;break}else if((f==null?void 0:f.type)==="list"){const y=f,w=y.raw+`
`+t.join(`
`),x=this.list(w);o[o.length-1]=x,s=s.substring(0,s.length-f.raw.length)+x.raw,i=i.substring(0,i.length-y.raw.length)+x.raw,t=w.substring(o.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:s,tokens:o,text:i}}}list(n){let e=this.rules.block.list.exec(n);if(e){let t=e[1].trim();const s=t.length>1,i={type:"list",raw:"",ordered:s,start:s?+t.slice(0,-1):"",loose:!1,items:[]};t=s?`\\d{1,9}\\${t.slice(-1)}`:`\\${t}`,this.options.pedantic&&(t=s?t:"[*+-]");const o=this.rules.other.listItemRegex(t);let l=!1;for(;n;){let a=!1,c="",u="";if(!(e=o.exec(n))||this.rules.block.hr.test(n))break;c=e[0],n=n.substring(c.length);let p=e[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,S=>" ".repeat(3*S.length)),f=n.split(`
`,1)[0],y=!p.trim(),w=0;if(this.options.pedantic?(w=2,u=p.trimStart()):y?w=e[1].length+1:(w=e[2].search(this.rules.other.nonSpaceChar),w=w>4?1:w,u=p.slice(w),w+=e[1].length),y&&this.rules.other.blankLine.test(f)&&(c+=f+`
`,n=n.substring(f.length+1),a=!0),!a){const S=this.rules.other.nextBulletRegex(w),B=this.rules.other.hrRegex(w),ne=this.rules.other.fencesBeginRegex(w),q=this.rules.other.headingBeginRegex(w),ue=this.rules.other.htmlBeginRegex(w);for(;n;){const W=n.split(`
`,1)[0];let V;if(f=W,this.options.pedantic?(f=f.replace(this.rules.other.listReplaceNesting,"  "),V=f):V=f.replace(this.rules.other.tabCharGlobal,"    "),ne.test(f)||q.test(f)||ue.test(f)||S.test(f)||B.test(f))break;if(V.search(this.rules.other.nonSpaceChar)>=w||!f.trim())u+=`
`+V.slice(w);else{if(y||p.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||ne.test(p)||q.test(p)||B.test(p))break;u+=`
`+f}!y&&!f.trim()&&(y=!0),c+=W+`
`,n=n.substring(W.length+1),p=V.slice(w)}}i.loose||(l?i.loose=!0:this.rules.other.doubleBlankLine.test(c)&&(l=!0));let x=null,b;this.options.gfm&&(x=this.rules.other.listIsTask.exec(u),x&&(b=x[0]!=="[ ] ",u=u.replace(this.rules.other.listReplaceTask,""))),i.items.push({type:"list_item",raw:c,task:!!x,checked:b,loose:!1,text:u,tokens:[]}),i.raw+=c}const r=i.items.at(-1);if(r)r.raw=r.raw.trimEnd(),r.text=r.text.trimEnd();else return;i.raw=i.raw.trimEnd();for(let a=0;a<i.items.length;a++)if(this.lexer.state.top=!1,i.items[a].tokens=this.lexer.blockTokens(i.items[a].text,[]),!i.loose){const c=i.items[a].tokens.filter(p=>p.type==="space"),u=c.length>0&&c.some(p=>this.rules.other.anyLine.test(p.raw));i.loose=u}if(i.loose)for(let a=0;a<i.items.length;a++)i.items[a].loose=!0;return i}}html(n){const e=this.rules.block.html.exec(n);if(e)return{type:"html",block:!0,raw:e[0],pre:e[1]==="pre"||e[1]==="script"||e[1]==="style",text:e[0]}}def(n){const e=this.rules.block.def.exec(n);if(e){const t=e[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),s=e[2]?e[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",i=e[3]?e[3].substring(1,e[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):e[3];return{type:"def",tag:t,raw:e[0],href:s,title:i}}}table(n){var l;const e=this.rules.block.table.exec(n);if(!e||!this.rules.other.tableDelimiter.test(e[2]))return;const t=$e(e[1]),s=e[2].replace(this.rules.other.tableAlignChars,"").split("|"),i=(l=e[3])!=null&&l.trim()?e[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],o={type:"table",raw:e[0],header:[],align:[],rows:[]};if(t.length===s.length){for(const r of s)this.rules.other.tableAlignRight.test(r)?o.align.push("right"):this.rules.other.tableAlignCenter.test(r)?o.align.push("center"):this.rules.other.tableAlignLeft.test(r)?o.align.push("left"):o.align.push(null);for(let r=0;r<t.length;r++)o.header.push({text:t[r],tokens:this.lexer.inline(t[r]),header:!0,align:o.align[r]});for(const r of i)o.rows.push($e(r,o.header.length).map((a,c)=>({text:a,tokens:this.lexer.inline(a),header:!1,align:o.align[c]})));return o}}lheading(n){const e=this.rules.block.lheading.exec(n);if(e)return{type:"heading",raw:e[0],depth:e[2].charAt(0)==="="?1:2,text:e[1],tokens:this.lexer.inline(e[1])}}paragraph(n){const e=this.rules.block.paragraph.exec(n);if(e){const t=e[1].charAt(e[1].length-1)===`
`?e[1].slice(0,-1):e[1];return{type:"paragraph",raw:e[0],text:t,tokens:this.lexer.inline(t)}}}text(n){const e=this.rules.block.text.exec(n);if(e)return{type:"text",raw:e[0],text:e[0],tokens:this.lexer.inline(e[0])}}escape(n){const e=this.rules.inline.escape.exec(n);if(e)return{type:"escape",raw:e[0],text:e[1]}}tag(n){const e=this.rules.inline.tag.exec(n);if(e)return!this.lexer.state.inLink&&this.rules.other.startATag.test(e[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(e[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(e[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(e[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:e[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:e[0]}}link(n){const e=this.rules.inline.link.exec(n);if(e){const t=e[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(t)){if(!this.rules.other.endAngleBracket.test(t))return;const o=Y(t.slice(0,-1),"\\");if((t.length-o.length)%2===0)return}else{const o=mn(e[2],"()");if(o>-1){const r=(e[0].indexOf("!")===0?5:4)+e[1].length+o;e[2]=e[2].substring(0,o),e[0]=e[0].substring(0,r).trim(),e[3]=""}}let s=e[2],i="";if(this.options.pedantic){const o=this.rules.other.pedanticHrefTitle.exec(s);o&&(s=o[1],i=o[3])}else i=e[3]?e[3].slice(1,-1):"";return s=s.trim(),this.rules.other.startAngleBracket.test(s)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(t)?s=s.slice(1):s=s.slice(1,-1)),Be(e,{href:s&&s.replace(this.rules.inline.anyPunctuation,"$1"),title:i&&i.replace(this.rules.inline.anyPunctuation,"$1")},e[0],this.lexer,this.rules)}}reflink(n,e){let t;if((t=this.rules.inline.reflink.exec(n))||(t=this.rules.inline.nolink.exec(n))){const s=(t[2]||t[1]).replace(this.rules.other.multipleSpaceGlobal," "),i=e[s.toLowerCase()];if(!i){const o=t[0].charAt(0);return{type:"text",raw:o,text:o}}return Be(t,i,t[0],this.lexer,this.rules)}}emStrong(n,e,t=""){let s=this.rules.inline.emStrongLDelim.exec(n);if(!s||s[3]&&t.match(this.rules.other.unicodeAlphaNumeric))return;if(!(s[1]||s[2]||"")||!t||this.rules.inline.punctuation.exec(t)){const o=[...s[0]].length-1;let l,r,a=o,c=0;const u=s[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(u.lastIndex=0,e=e.slice(-1*n.length+o);(s=u.exec(e))!=null;){if(l=s[1]||s[2]||s[3]||s[4]||s[5]||s[6],!l)continue;if(r=[...l].length,s[3]||s[4]){a+=r;continue}else if((s[5]||s[6])&&o%3&&!((o+r)%3)){c+=r;continue}if(a-=r,a>0)continue;r=Math.min(r,r+a+c);const p=[...s[0]][0].length,f=n.slice(0,o+s.index+p+r);if(Math.min(o,r)%2){const w=f.slice(1,-1);return{type:"em",raw:f,text:w,tokens:this.lexer.inlineTokens(w)}}const y=f.slice(2,-2);return{type:"strong",raw:f,text:y,tokens:this.lexer.inlineTokens(y)}}}}codespan(n){const e=this.rules.inline.code.exec(n);if(e){let t=e[2].replace(this.rules.other.newLineCharGlobal," ");const s=this.rules.other.nonSpaceChar.test(t),i=this.rules.other.startingSpaceChar.test(t)&&this.rules.other.endingSpaceChar.test(t);return s&&i&&(t=t.substring(1,t.length-1)),{type:"codespan",raw:e[0],text:t}}}br(n){const e=this.rules.inline.br.exec(n);if(e)return{type:"br",raw:e[0]}}del(n){const e=this.rules.inline.del.exec(n);if(e)return{type:"del",raw:e[0],text:e[2],tokens:this.lexer.inlineTokens(e[2])}}autolink(n){const e=this.rules.inline.autolink.exec(n);if(e){let t,s;return e[2]==="@"?(t=e[1],s="mailto:"+t):(t=e[1],s=t),{type:"link",raw:e[0],text:t,href:s,tokens:[{type:"text",raw:t,text:t}]}}}url(n){var t;let e;if(e=this.rules.inline.url.exec(n)){let s,i;if(e[2]==="@")s=e[0],i="mailto:"+s;else{let o;do o=e[0],e[0]=((t=this.rules.inline._backpedal.exec(e[0]))==null?void 0:t[0])??"";while(o!==e[0]);s=e[0],e[1]==="www."?i="http://"+e[0]:i=e[0]}return{type:"link",raw:e[0],text:s,href:i,tokens:[{type:"text",raw:s,text:s}]}}}inlineText(n){const e=this.rules.inline.text.exec(n);if(e){const t=this.lexer.state.inRawBlock;return{type:"text",raw:e[0],text:e[0],escaped:t}}}}class P{constructor(n){d(this,"tokens");d(this,"options");d(this,"state");d(this,"tokenizer");d(this,"inlineQueue");this.tokens=[],this.tokens.links=Object.create(null),this.options=n||$,this.options.tokenizer=this.options.tokenizer||new le,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const e={other:I,block:se.normal,inline:j.normal};this.options.pedantic?(e.block=se.pedantic,e.inline=j.pedantic):this.options.gfm&&(e.block=se.gfm,this.options.breaks?e.inline=j.breaks:e.inline=j.gfm),this.tokenizer.rules=e}static get rules(){return{block:se,inline:j}}static lex(n,e){return new P(e).lex(n)}static lexInline(n,e){return new P(e).inlineTokens(n)}lex(n){n=n.replace(I.carriageReturn,`
`),this.blockTokens(n,this.tokens);for(let e=0;e<this.inlineQueue.length;e++){const t=this.inlineQueue[e];this.inlineTokens(t.src,t.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(n,e=[],t=!1){var s,i,o;for(this.options.pedantic&&(n=n.replace(I.tabCharGlobal,"    ").replace(I.spaceLine,""));n;){let l;if((i=(s=this.options.extensions)==null?void 0:s.block)!=null&&i.some(a=>(l=a.call({lexer:this},n,e))?(n=n.substring(l.raw.length),e.push(l),!0):!1))continue;if(l=this.tokenizer.space(n)){n=n.substring(l.raw.length);const a=e.at(-1);l.raw.length===1&&a!==void 0?a.raw+=`
`:e.push(l);continue}if(l=this.tokenizer.code(n)){n=n.substring(l.raw.length);const a=e.at(-1);(a==null?void 0:a.type)==="paragraph"||(a==null?void 0:a.type)==="text"?(a.raw+=`
`+l.raw,a.text+=`
`+l.text,this.inlineQueue.at(-1).src=a.text):e.push(l);continue}if(l=this.tokenizer.fences(n)){n=n.substring(l.raw.length),e.push(l);continue}if(l=this.tokenizer.heading(n)){n=n.substring(l.raw.length),e.push(l);continue}if(l=this.tokenizer.hr(n)){n=n.substring(l.raw.length),e.push(l);continue}if(l=this.tokenizer.blockquote(n)){n=n.substring(l.raw.length),e.push(l);continue}if(l=this.tokenizer.list(n)){n=n.substring(l.raw.length),e.push(l);continue}if(l=this.tokenizer.html(n)){n=n.substring(l.raw.length),e.push(l);continue}if(l=this.tokenizer.def(n)){n=n.substring(l.raw.length);const a=e.at(-1);(a==null?void 0:a.type)==="paragraph"||(a==null?void 0:a.type)==="text"?(a.raw+=`
`+l.raw,a.text+=`
`+l.raw,this.inlineQueue.at(-1).src=a.text):this.tokens.links[l.tag]||(this.tokens.links[l.tag]={href:l.href,title:l.title});continue}if(l=this.tokenizer.table(n)){n=n.substring(l.raw.length),e.push(l);continue}if(l=this.tokenizer.lheading(n)){n=n.substring(l.raw.length),e.push(l);continue}let r=n;if((o=this.options.extensions)!=null&&o.startBlock){let a=1/0;const c=n.slice(1);let u;this.options.extensions.startBlock.forEach(p=>{u=p.call({lexer:this},c),typeof u=="number"&&u>=0&&(a=Math.min(a,u))}),a<1/0&&a>=0&&(r=n.substring(0,a+1))}if(this.state.top&&(l=this.tokenizer.paragraph(r))){const a=e.at(-1);t&&(a==null?void 0:a.type)==="paragraph"?(a.raw+=`
`+l.raw,a.text+=`
`+l.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=a.text):e.push(l),t=r.length!==n.length,n=n.substring(l.raw.length);continue}if(l=this.tokenizer.text(n)){n=n.substring(l.raw.length);const a=e.at(-1);(a==null?void 0:a.type)==="text"?(a.raw+=`
`+l.raw,a.text+=`
`+l.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=a.text):e.push(l);continue}if(n){const a="Infinite loop on byte: "+n.charCodeAt(0);if(this.options.silent){console.error(a);break}else throw new Error(a)}}return this.state.top=!0,e}inline(n,e=[]){return this.inlineQueue.push({src:n,tokens:e}),e}inlineTokens(n,e=[]){var l,r,a;let t=n,s=null;if(this.tokens.links){const c=Object.keys(this.tokens.links);if(c.length>0)for(;(s=this.tokenizer.rules.inline.reflinkSearch.exec(t))!=null;)c.includes(s[0].slice(s[0].lastIndexOf("[")+1,-1))&&(t=t.slice(0,s.index)+"["+"a".repeat(s[0].length-2)+"]"+t.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(s=this.tokenizer.rules.inline.blockSkip.exec(t))!=null;)t=t.slice(0,s.index)+"["+"a".repeat(s[0].length-2)+"]"+t.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);for(;(s=this.tokenizer.rules.inline.anyPunctuation.exec(t))!=null;)t=t.slice(0,s.index)+"++"+t.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let i=!1,o="";for(;n;){i||(o=""),i=!1;let c;if((r=(l=this.options.extensions)==null?void 0:l.inline)!=null&&r.some(p=>(c=p.call({lexer:this},n,e))?(n=n.substring(c.raw.length),e.push(c),!0):!1))continue;if(c=this.tokenizer.escape(n)){n=n.substring(c.raw.length),e.push(c);continue}if(c=this.tokenizer.tag(n)){n=n.substring(c.raw.length),e.push(c);continue}if(c=this.tokenizer.link(n)){n=n.substring(c.raw.length),e.push(c);continue}if(c=this.tokenizer.reflink(n,this.tokens.links)){n=n.substring(c.raw.length);const p=e.at(-1);c.type==="text"&&(p==null?void 0:p.type)==="text"?(p.raw+=c.raw,p.text+=c.text):e.push(c);continue}if(c=this.tokenizer.emStrong(n,t,o)){n=n.substring(c.raw.length),e.push(c);continue}if(c=this.tokenizer.codespan(n)){n=n.substring(c.raw.length),e.push(c);continue}if(c=this.tokenizer.br(n)){n=n.substring(c.raw.length),e.push(c);continue}if(c=this.tokenizer.del(n)){n=n.substring(c.raw.length),e.push(c);continue}if(c=this.tokenizer.autolink(n)){n=n.substring(c.raw.length),e.push(c);continue}if(!this.state.inLink&&(c=this.tokenizer.url(n))){n=n.substring(c.raw.length),e.push(c);continue}let u=n;if((a=this.options.extensions)!=null&&a.startInline){let p=1/0;const f=n.slice(1);let y;this.options.extensions.startInline.forEach(w=>{y=w.call({lexer:this},f),typeof y=="number"&&y>=0&&(p=Math.min(p,y))}),p<1/0&&p>=0&&(u=n.substring(0,p+1))}if(c=this.tokenizer.inlineText(u)){n=n.substring(c.raw.length),c.raw.slice(-1)!=="_"&&(o=c.raw.slice(-1)),i=!0;const p=e.at(-1);(p==null?void 0:p.type)==="text"?(p.raw+=c.raw,p.text+=c.text):e.push(c);continue}if(n){const p="Infinite loop on byte: "+n.charCodeAt(0);if(this.options.silent){console.error(p);break}else throw new Error(p)}}return e}}class re{constructor(n){d(this,"options");d(this,"parser");this.options=n||$}space(n){return""}code({text:n,lang:e,escaped:t}){var o;const s=(o=(e||"").match(I.notSpaceStart))==null?void 0:o[0],i=n.replace(I.endingNewline,"")+`
`;return s?'<pre><code class="language-'+N(s)+'">'+(t?i:N(i,!0))+`</code></pre>
`:"<pre><code>"+(t?i:N(i,!0))+`</code></pre>
`}blockquote({tokens:n}){return`<blockquote>
${this.parser.parse(n)}</blockquote>
`}html({text:n}){return n}heading({tokens:n,depth:e}){return`<h${e}>${this.parser.parseInline(n)}</h${e}>
`}hr(n){return`<hr>
`}list(n){const e=n.ordered,t=n.start;let s="";for(let l=0;l<n.items.length;l++){const r=n.items[l];s+=this.listitem(r)}const i=e?"ol":"ul",o=e&&t!==1?' start="'+t+'"':"";return"<"+i+o+`>
`+s+"</"+i+`>
`}listitem(n){var t;let e="";if(n.task){const s=this.checkbox({checked:!!n.checked});n.loose?((t=n.tokens[0])==null?void 0:t.type)==="paragraph"?(n.tokens[0].text=s+" "+n.tokens[0].text,n.tokens[0].tokens&&n.tokens[0].tokens.length>0&&n.tokens[0].tokens[0].type==="text"&&(n.tokens[0].tokens[0].text=s+" "+N(n.tokens[0].tokens[0].text),n.tokens[0].tokens[0].escaped=!0)):n.tokens.unshift({type:"text",raw:s+" ",text:s+" ",escaped:!0}):e+=s+" "}return e+=this.parser.parse(n.tokens,!!n.loose),`<li>${e}</li>
`}checkbox({checked:n}){return"<input "+(n?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:n}){return`<p>${this.parser.parseInline(n)}</p>
`}table(n){let e="",t="";for(let i=0;i<n.header.length;i++)t+=this.tablecell(n.header[i]);e+=this.tablerow({text:t});let s="";for(let i=0;i<n.rows.length;i++){const o=n.rows[i];t="";for(let l=0;l<o.length;l++)t+=this.tablecell(o[l]);s+=this.tablerow({text:t})}return s&&(s=`<tbody>${s}</tbody>`),`<table>
<thead>
`+e+`</thead>
`+s+`</table>
`}tablerow({text:n}){return`<tr>
${n}</tr>
`}tablecell(n){const e=this.parser.parseInline(n.tokens),t=n.header?"th":"td";return(n.align?`<${t} align="${n.align}">`:`<${t}>`)+e+`</${t}>
`}strong({tokens:n}){return`<strong>${this.parser.parseInline(n)}</strong>`}em({tokens:n}){return`<em>${this.parser.parseInline(n)}</em>`}codespan({text:n}){return`<code>${N(n,!0)}</code>`}br(n){return"<br>"}del({tokens:n}){return`<del>${this.parser.parseInline(n)}</del>`}link({href:n,title:e,tokens:t}){const s=this.parser.parseInline(t),i=Ue(n);if(i===null)return s;n=i;let o='<a href="'+n+'"';return e&&(o+=' title="'+N(e)+'"'),o+=">"+s+"</a>",o}image({href:n,title:e,text:t}){const s=Ue(n);if(s===null)return N(t);n=s;let i=`<img src="${n}" alt="${t}"`;return e&&(i+=` title="${N(e)}"`),i+=">",i}text(n){return"tokens"in n&&n.tokens?this.parser.parseInline(n.tokens):"escaped"in n&&n.escaped?n.text:N(n.text)}}class Ie{strong({text:n}){return n}em({text:n}){return n}codespan({text:n}){return n}del({text:n}){return n}html({text:n}){return n}text({text:n}){return n}link({text:n}){return""+n}image({text:n}){return""+n}br(){return""}}class O{constructor(n){d(this,"options");d(this,"renderer");d(this,"textRenderer");this.options=n||$,this.options.renderer=this.options.renderer||new re,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new Ie}static parse(n,e){return new O(e).parse(n)}static parseInline(n,e){return new O(e).parseInline(n)}parse(n,e=!0){var s,i;let t="";for(let o=0;o<n.length;o++){const l=n[o];if((i=(s=this.options.extensions)==null?void 0:s.renderers)!=null&&i[l.type]){const a=l,c=this.options.extensions.renderers[a.type].call({parser:this},a);if(c!==!1||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(a.type)){t+=c||"";continue}}const r=l;switch(r.type){case"space":{t+=this.renderer.space(r);continue}case"hr":{t+=this.renderer.hr(r);continue}case"heading":{t+=this.renderer.heading(r);continue}case"code":{t+=this.renderer.code(r);continue}case"table":{t+=this.renderer.table(r);continue}case"blockquote":{t+=this.renderer.blockquote(r);continue}case"list":{t+=this.renderer.list(r);continue}case"html":{t+=this.renderer.html(r);continue}case"paragraph":{t+=this.renderer.paragraph(r);continue}case"text":{let a=r,c=this.renderer.text(a);for(;o+1<n.length&&n[o+1].type==="text";)a=n[++o],c+=`
`+this.renderer.text(a);e?t+=this.renderer.paragraph({type:"paragraph",raw:c,text:c,tokens:[{type:"text",raw:c,text:c,escaped:!0}]}):t+=c;continue}default:{const a='Token with "'+r.type+'" type was not found.';if(this.options.silent)return console.error(a),"";throw new Error(a)}}}return t}parseInline(n,e=this.renderer){var s,i;let t="";for(let o=0;o<n.length;o++){const l=n[o];if((i=(s=this.options.extensions)==null?void 0:s.renderers)!=null&&i[l.type]){const a=this.options.extensions.renderers[l.type].call({parser:this},l);if(a!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(l.type)){t+=a||"";continue}}const r=l;switch(r.type){case"escape":{t+=e.text(r);break}case"html":{t+=e.html(r);break}case"link":{t+=e.link(r);break}case"image":{t+=e.image(r);break}case"strong":{t+=e.strong(r);break}case"em":{t+=e.em(r);break}case"codespan":{t+=e.codespan(r);break}case"br":{t+=e.br(r);break}case"del":{t+=e.del(r);break}case"text":{t+=e.text(r);break}default:{const a='Token with "'+r.type+'" type was not found.';if(this.options.silent)return console.error(a),"";throw new Error(a)}}}return t}}class J{constructor(n){d(this,"options");d(this,"block");this.options=n||$}preprocess(n){return n}postprocess(n){return n}processAllTokens(n){return n}provideLexer(){return this.block?P.lex:P.lexInline}provideParser(){return this.block?O.parse:O.parseInline}}d(J,"passThroughHooks",new Set(["preprocess","postprocess","processAllTokens"]));class wn{constructor(...n){d(this,"defaults",be());d(this,"options",this.setOptions);d(this,"parse",this.parseMarkdown(!0));d(this,"parseInline",this.parseMarkdown(!1));d(this,"Parser",O);d(this,"Renderer",re);d(this,"TextRenderer",Ie);d(this,"Lexer",P);d(this,"Tokenizer",le);d(this,"Hooks",J);this.use(...n)}walkTokens(n,e){var s,i;let t=[];for(const o of n)switch(t=t.concat(e.call(this,o)),o.type){case"table":{const l=o;for(const r of l.header)t=t.concat(this.walkTokens(r.tokens,e));for(const r of l.rows)for(const a of r)t=t.concat(this.walkTokens(a.tokens,e));break}case"list":{const l=o;t=t.concat(this.walkTokens(l.items,e));break}default:{const l=o;(i=(s=this.defaults.extensions)==null?void 0:s.childTokens)!=null&&i[l.type]?this.defaults.extensions.childTokens[l.type].forEach(r=>{const a=l[r].flat(1/0);t=t.concat(this.walkTokens(a,e))}):l.tokens&&(t=t.concat(this.walkTokens(l.tokens,e)))}}return t}use(...n){const e=this.defaults.extensions||{renderers:{},childTokens:{}};return n.forEach(t=>{const s={...t};if(s.async=this.defaults.async||s.async||!1,t.extensions&&(t.extensions.forEach(i=>{if(!i.name)throw new Error("extension name required");if("renderer"in i){const o=e.renderers[i.name];o?e.renderers[i.name]=function(...l){let r=i.renderer.apply(this,l);return r===!1&&(r=o.apply(this,l)),r}:e.renderers[i.name]=i.renderer}if("tokenizer"in i){if(!i.level||i.level!=="block"&&i.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");const o=e[i.level];o?o.unshift(i.tokenizer):e[i.level]=[i.tokenizer],i.start&&(i.level==="block"?e.startBlock?e.startBlock.push(i.start):e.startBlock=[i.start]:i.level==="inline"&&(e.startInline?e.startInline.push(i.start):e.startInline=[i.start]))}"childTokens"in i&&i.childTokens&&(e.childTokens[i.name]=i.childTokens)}),s.extensions=e),t.renderer){const i=this.defaults.renderer||new re(this.defaults);for(const o in t.renderer){if(!(o in i))throw new Error(`renderer '${o}' does not exist`);if(["options","parser"].includes(o))continue;const l=o,r=t.renderer[l],a=i[l];i[l]=(...c)=>{let u=r.apply(i,c);return u===!1&&(u=a.apply(i,c)),u||""}}s.renderer=i}if(t.tokenizer){const i=this.defaults.tokenizer||new le(this.defaults);for(const o in t.tokenizer){if(!(o in i))throw new Error(`tokenizer '${o}' does not exist`);if(["options","rules","lexer"].includes(o))continue;const l=o,r=t.tokenizer[l],a=i[l];i[l]=(...c)=>{let u=r.apply(i,c);return u===!1&&(u=a.apply(i,c)),u}}s.tokenizer=i}if(t.hooks){const i=this.defaults.hooks||new J;for(const o in t.hooks){if(!(o in i))throw new Error(`hook '${o}' does not exist`);if(["options","block"].includes(o))continue;const l=o,r=t.hooks[l],a=i[l];J.passThroughHooks.has(o)?i[l]=c=>{if(this.defaults.async)return Promise.resolve(r.call(i,c)).then(p=>a.call(i,p));const u=r.call(i,c);return a.call(i,u)}:i[l]=(...c)=>{let u=r.apply(i,c);return u===!1&&(u=a.apply(i,c)),u}}s.hooks=i}if(t.walkTokens){const i=this.defaults.walkTokens,o=t.walkTokens;s.walkTokens=function(l){let r=[];return r.push(o.call(this,l)),i&&(r=r.concat(i.call(this,l))),r}}this.defaults={...this.defaults,...s}}),this}setOptions(n){return this.defaults={...this.defaults,...n},this}lexer(n,e){return P.lex(n,e??this.defaults)}parser(n,e){return O.parse(n,e??this.defaults)}parseMarkdown(n){return(t,s)=>{const i={...s},o={...this.defaults,...i},l=this.onError(!!o.silent,!!o.async);if(this.defaults.async===!0&&i.async===!1)return l(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof t>"u"||t===null)return l(new Error("marked(): input parameter is undefined or null"));if(typeof t!="string")return l(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(t)+", string expected"));o.hooks&&(o.hooks.options=o,o.hooks.block=n);const r=o.hooks?o.hooks.provideLexer():n?P.lex:P.lexInline,a=o.hooks?o.hooks.provideParser():n?O.parse:O.parseInline;if(o.async)return Promise.resolve(o.hooks?o.hooks.preprocess(t):t).then(c=>r(c,o)).then(c=>o.hooks?o.hooks.processAllTokens(c):c).then(c=>o.walkTokens?Promise.all(this.walkTokens(c,o.walkTokens)).then(()=>c):c).then(c=>a(c,o)).then(c=>o.hooks?o.hooks.postprocess(c):c).catch(l);try{o.hooks&&(t=o.hooks.preprocess(t));let c=r(t,o);o.hooks&&(c=o.hooks.processAllTokens(c)),o.walkTokens&&this.walkTokens(c,o.walkTokens);let u=a(c,o);return o.hooks&&(u=o.hooks.postprocess(u)),u}catch(c){return l(c)}}}onError(n,e){return t=>{if(t.message+=`
Please report this to https://github.com/markedjs/marked.`,n){const s="<p>An error occurred:</p><pre>"+N(t.message+"",!0)+"</pre>";return e?Promise.resolve(s):s}if(e)return Promise.reject(t);throw t}}}const U=new wn;function _(h,n){return U.parse(h,n)}_.options=_.setOptions=function(h){return U.setOptions(h),_.defaults=U.defaults,et(_.defaults),_};_.getDefaults=be;_.defaults=$;_.use=function(...h){return U.use(...h),_.defaults=U.defaults,et(_.defaults),_};_.walkTokens=function(h,n){return U.walkTokens(h,n)};_.parseInline=U.parseInline;_.Parser=O;_.parser=O.parse;_.Renderer=re;_.TextRenderer=Ie;_.Lexer=P;_.lexer=P.lex;_.Tokenizer=le;_.Hooks=J;_.parse=_;_.options;_.setOptions;_.use;_.walkTokens;_.parseInline;const yn=_;O.parse;P.lex;const En=new RegExp(/\n\s*(```)/);class xn{constructor(n,e=null,t=!0){d(this,"allowEdit",!0);d(this,"savedText","");this.root=n,this.onSave=e,e==null&&(this.allowEdit=!1),t&&e!=null&&document.addEventListener("keydown",s=>{s.ctrlKey&&s.key==="s"&&(s.preventDefault(),this.save())})}async load(n,e=!1){if(!this.isSaved()&&!e)return!1;this.savedText=n,this.root.innerHTML="";let t=this.render(n);for(let s of t)this.root.appendChild(await s);return!0}save(){let n=this.getText();this.onSave==null?this.isSaved()||alert("ERROR: This should not happen! Documents should not be editable if onSave is null."):this.onSave(n).then(()=>{n==this.getText()&&(this.savedText=n)})}getText(){let n="";for(let e of this.root.children)n+=e.getAttribute("data-text")+`

`;for(;n.endsWith(`

`);)n=n.slice(0,n.length-1);return n}isSaved(){return this.savedText==this.getText()}pluginCreateChunk(n){return n}onDirty(){}pluginOpenEditor(n,e){return null}render(n){let e=n.replaceAll("\r","").split(`

`);const t=[];for(let s=0;s<e.length;s++){let i=e[s];if(En.test(i)||i.trim().startsWith("```")){let o=i.indexOf("```");if(i.indexOf("```",o+3)<0)for(;s+1<e.length&&(s++,i+=`

`+e[s],!e[s].includes("```")););}t.push(this.createChunk(i))}return t}async createChunk(n){let e=document.createElement("div");e.classList.add("chunk"),n=n.trim();let t=this.pluginCreateChunk(n);return e.innerHTML=await yn(t),e.innerHTML==""&&(e.innerHTML="<p><i>"+m.MD_EMPTY_CELL+"</i></p>"),e.onclick=s=>{this.allowEdit&&this.openEditor(e)},e.setAttribute("data-text",n),e}openEditor(n){let e=n.getAttribute("data-text"),t=this;async function s(r){if(r!=""){let a=t.render(r);for(let c of a)t.root.insertBefore(await c,o)}t.root.removeChild(o),t.getText()==""&&t.root.append(await t.createChunk("")),r!=e&&t.onDirty()}let i=this.pluginOpenEditor(e,s);if(i!=null){i.setAttribute("data-text",e),this.root.replaceChild(i,n);return}let o=document.createElement("textarea");o.setAttribute("data-text",e),o.classList.add("editorChunk"),o.placeholder="Add markdown text here!",o.value=e,o.style.height=e.split(`
`).length*1.2+.2+"em",window.setTimeout(()=>{o.style.height="0px",o.style.height=o.scrollHeight+"px"},10),o.setAttribute("data-text",e),o.addEventListener("paste",async r=>{var c,u,p;const a=typeof((c=navigator==null?void 0:navigator.clipboard)==null?void 0:c.read)=="function"?await navigator.clipboard.read():r.clipboardData.files;for(const f of a)if(f instanceof File&&((u=f.type)!=null&&u.startsWith("image/")))l(f),r.preventDefault();else if(f instanceof ClipboardItem){const y=(p=f.types)==null?void 0:p.filter(w=>w.startsWith("image/"));for(const w of y)l(await f.getType(w)),r.preventDefault()}});const l=r=>{var a=new FileReader;a.readAsDataURL(r),a.onloadend=function(){var c=a.result;let u="![pasted image]("+c+")";if(o.selectionStart||o.selectionStart==0){var p=o.selectionStart,f=o.selectionEnd;o.value=o.value.substring(0,p)+u+o.value.substring(f,o.value.length)}else o.value+=u}};this.root.replaceChild(o,n),o.focus(),o.setSelectionRange(e.length,e.length),o.onkeyup=()=>{o.setAttribute("data-text",o.value),o.style.height="0px",o.style.height=o.scrollHeight+"px"},o.onblur=r=>{s(o.value)},o.addEventListener("keydown",r=>{(r.ctrlKey||r.shiftKey)&&r.key==="Enter"&&o.blur()}),o.oninput=()=>{o.setAttribute("data-text",o.value.replaceAll(`\r
`,`
`)),t.onDirty()}}}let bn='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M288 109.3L288 352c0 17.7-14.3 32-32 32s-32-14.3-32-32l0-242.7-73.4 73.4c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l128-128c12.5-12.5 32.8-12.5 45.3 0l128 128c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L288 109.3zM64 352l128 0c0 35.3 28.7 64 64 64s64-28.7 64-64l128 0c35.3 0 64 28.7 64 64l0 32c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64l0-32c0-35.3 28.7-64 64-64zM432 456a24 24 0 1 0 0-48 24 24 0 1 0 0 48z"/></svg>',_n='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 242.7-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7 288 32zM64 352c-35.3 0-64 28.7-64 64l0 32c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-32c0-35.3-28.7-64-64-64l-101.5 0-45.3 45.3c-25 25-65.5 25-90.5 0L165.5 352 64 352zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48z"/></svg>',kn='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l82.7 0L201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3l0 82.7c0 17.7 14.3 32 32 32s32-14.3 32-32l0-160c0-17.7-14.3-32-32-32L320 0zM80 32C35.8 32 0 67.8 0 112L0 432c0 44.2 35.8 80 80 80l320 0c44.2 0 80-35.8 80-80l0-112c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 112c0 8.8-7.2 16-16 16L80 448c-8.8 0-16-7.2-16-16l0-320c0-8.8 7.2-16 16-16l112 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L80 32z"/></svg>',pe='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M48 96V416c0 8.8 7.2 16 16 16H384c8.8 0 16-7.2 16-16V170.5c0-4.2-1.7-8.3-4.7-11.3l33.9-33.9c12 12 18.7 28.3 18.7 45.3V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96C0 60.7 28.7 32 64 32H309.5c17 0 33.3 6.7 45.3 18.7l74.5 74.5-33.9 33.9L320.8 84.7c-.3-.3-.5-.5-.8-.8V184c0 13.3-10.7 24-24 24H104c-13.3 0-24-10.7-24-24V80H64c-8.8 0-16 7.2-16 16zm80-16v80H272V80H128zm32 240a64 64 0 1 1 128 0 64 64 0 1 1 -128 0z"/></svg>',Tn='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M448 80c8.8 0 16 7.2 16 16V415.8l-5-6.5-136-176c-4.5-5.9-11.6-9.3-19-9.3s-14.4 3.4-19 9.3L202 340.7l-30.5-42.7C167 291.7 159.8 288 152 288s-15 3.7-19.5 10.1l-80 112L48 416.3l0-.3V96c0-8.8 7.2-16 16-16H448zM64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zm80 192a48 48 0 1 0 0-96 48 48 0 1 0 0 96z"/></svg>',We='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M441 58.9L453.1 71c9.4 9.4 9.4 24.6 0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9 0zM209.8 256.2L344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1l-58.5 16.7 16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25L175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 100c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l100-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7 0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4 0 152V424c0 48.6 39.4 88 88 88H360c48.6 0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1 0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H200c13.3 0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg>';class Cn extends E{constructor(n="navbar"){super("div","",n)}}class z extends C{constructor(n,e="navbar-button"){super(n,e)}}class Sn extends E{constructor(n,e="navbar-header"){super("div",n,e)}}class R{static register(n,e){this.registry.has(n)||this.registry.set(n,[]),this.registry.get(n).push(e)}static send(n,e){let t=this.registry.get(n)??[];for(let s of t)s(n,e);if(e.allowNetwork){let s=this.registry.get("network")??[];for(let i of s)i(n,e)}}}d(R,"registry",new Map);const K=class K extends E{constructor(e,t,s="",i=!1,o=!1){super("div",s,"tool");d(this,"popup",null);this.id=e,this.selectable=t,this.togglable=o,i&&(this.htmlElement.style.float="right"),t&&K.selectableTools.push(this.id),this.htmlElement.onclick=l=>{this.onClick()},R.register("toolbar/change",this.onSelectionChanged.bind(this)),R.register("toolbar/setting",this.onSettingChanged.bind(this))}onClick(){return this.togglable&&(this.hasClass("selected-tool")?(this.unsetClass("selected-tool"),this.unsetClass("selected-tool-good")):(this.setClass("selected-tool"),this.setClass("selected-tool-good"))),this.popup&&(!this.selectable||this.hasClass("selected-tool"))&&this.popup.show(),R.send("toolbar/change",{type:"string",data:this.id,allowNetwork:!1}),!0}onSelectionChanged(e,t){if(e=="toolbar/change"&&t.type=="string"){if(K.selectableTools.indexOf(t.data)==-1)return;this.togglable||(t.data==this.id?this.setClass("selected-tool"):this.unsetClass("selected-tool"))}}onSettingChanged(e,t){e=="toolbar/setting"&&t.type=="setting"&&t.data.id==this.id&&t.data.color&&(this.htmlElement.style.fill="var(--color-"+t.data.color+"-font)")}addPopup(e){this.popup!=null&&alert("CODING ERROR! Tool already has a popup attached!"),this.add(e),this.popup=e,this.popup.setParent(this.id)}};d(K,"selectableTools",[]);let M=K;class fe extends M{constructor(e,t="",s=""){super(e,!1,t+"&ensp;"+s);d(this,"parentMenu",null);this.id=e,this.unsetClass("tool"),this.setClass("toolWithText")}setParentMenu(e){this.parentMenu=e}onClick(){return window.setTimeout(()=>{var e;return(e=this.parentMenu)==null?void 0:e.hide()},10),super.onClick()}}class vn extends E{constructor(e=[]){super("div","","toolPopup");d(this,"grayOut");this.children=e,e.forEach(t=>{this.add(t)}),this.grayOut=document.createElement("div"),this.grayOut.classList.add("toolPopupGrayout"),this.grayOut.onclick=this.hide.bind(this),document.getElementById("global").appendChild(this.grayOut),this.hide()}setParent(e){this.children.forEach(t=>{t.setParentTool(e,this)})}show(){super.show(),this.grayOut.style.display="block"}hide(){super.hide(),this.grayOut.style.display="none"}}class In extends E{constructor(e=[]){super("div","","menuPopup");d(this,"grayOut");e.forEach(t=>{t.setParentMenu(this),this.add(t)}),this.grayOut=document.createElement("div"),this.grayOut.classList.add("toolPopupGrayout"),this.grayOut.onclick=this.hide.bind(this),document.getElementById("global").appendChild(this.grayOut),this.hide()}setParent(e){}show(){super.show(),this.grayOut.style.display="block"}hide(){super.hide(),this.grayOut.style.display="none"}}class ct extends C{constructor(e){super(e,"tool");d(this,"parentId","");d(this,"parentPopup",null)}setParentTool(e,t){this.parentId=e,this.parentPopup=t}}class X extends ct{constructor(n,e,t=!1){super(n),this.color=e,this.htmlElement.style.fill="var(--color-"+e+"-font)",t&&window.setTimeout(this.onClick.bind(this),100)}onClick(){window.setTimeout(()=>{var n;return(n=this.parentPopup)==null?void 0:n.hide()},10),R.send("toolbar/setting",{type:"setting",data:{id:this.parentId,color:this.color},allowNetwork:!1})}}class Ge extends ct{constructor(n,e,t=!1){super(n),this.size=e,t&&window.setTimeout(this.onClick.bind(this),100)}onClick(){window.setTimeout(()=>{var n;return(n=this.parentPopup)==null?void 0:n.hide()},10),R.send("toolbar/setting",{type:"setting",data:{id:this.parentId,size:this.size},allowNetwork:!1})}}class Ln extends E{constructor(n=!1){super("div","","spacer"),n&&(this.htmlElement.style.float="right")}}let Rn='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z"/></svg>',Pn='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M290.74 93.24l128.02 128.02-277.99 277.99-114.14 12.6C11.35 513.54-1.56 500.62.14 485.34l12.7-114.22 277.9-277.88zm207.2-19.06l-60.11-60.11c-18.75-18.75-49.16-18.75-67.91 0l-56.55 56.55 128.02 128.02 56.55-56.55c18.75-18.76 18.75-49.16 0-67.91z"/></svg>',On='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 544 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M0 479.98L99.92 512l35.45-35.45-67.04-67.04L0 479.98zm124.61-240.01a36.592 36.592 0 0 0-10.79 38.1l13.05 42.83-50.93 50.94 96.23 96.23 50.86-50.86 42.74 13.08c13.73 4.2 28.65-.01 38.15-10.78l35.55-41.64-173.34-173.34-41.52 35.44zm403.31-160.7l-63.2-63.2c-20.49-20.49-53.38-21.52-75.12-2.35L190.55 183.68l169.77 169.78L530.27 154.4c19.18-21.74 18.15-54.63-2.35-75.13z"/></svg>',Nn='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M497.941 273.941c18.745-18.745 18.745-49.137 0-67.882l-160-160c-18.745-18.745-49.136-18.746-67.883 0l-256 256c-18.745 18.745-18.745 49.137 0 67.882l96 96A48.004 48.004 0 0 0 144 480h356c6.627 0 12-5.373 12-12v-40c0-6.627-5.373-12-12-12H355.883l142.058-142.059zm-302.627-62.627l137.373 137.373L265.373 416H150.628l-80-80 124.686-124.686z"/></svg>',An='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 256 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M145.6 7.7C141 2.8 134.7 0 128 0s-13 2.8-17.6 7.7l-104 112c-6.5 7-8.2 17.2-4.4 25.9S14.5 160 24 160H80V352H24c-9.5 0-18.2 5.7-22 14.4s-2.1 18.9 4.4 25.9l104 112c4.5 4.9 10.9 7.7 17.6 7.7s13-2.8 17.6-7.7l104-112c6.5-7 8.2-17.2 4.4-25.9s-12.5-14.4-22-14.4H176V160h56c9.5 0 18.2-5.7 22-14.4s2.1-18.9-4.4-25.9l-104-112z"/></svg>',Fn='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M64 64V241.6c5.2-1 10.5-1.6 16-1.6H96V208 64c0-8.8-7.2-16-16-16s-16 7.2-16 16zM80 288c-17.7 0-32 14.3-32 32c0 0 0 0 0 0v24c0 66.3 53.7 120 120 120h48c52.5 0 97.1-33.7 113.4-80.7c-3.1 .5-6.2 .7-9.4 .7c-20 0-37.9-9.2-49.7-23.6c-9 4.9-19.4 7.6-30.3 7.6c-15.1 0-29-5.3-40-14c-11 8.8-24.9 14-40 14H120c-13.3 0-24-10.7-24-24s10.7-24 24-24h40c8.8 0 16-7.2 16-16s-7.2-16-16-16H120 80zM0 320s0 0 0 0c0-18 6-34.6 16-48V64C16 28.7 44.7 0 80 0s64 28.7 64 64v82c5.1-1.3 10.5-2 16-2c25.3 0 47.2 14.7 57.6 36c7-2.6 14.5-4 22.4-4c20 0 37.9 9.2 49.7 23.6c9-4.9 19.4-7.6 30.3-7.6c35.3 0 64 28.7 64 64v64 24c0 92.8-75.2 168-168 168H168C75.2 512 0 436.8 0 344V320zm336-64c0-8.8-7.2-16-16-16s-16 7.2-16 16v48 16c0 8.8 7.2 16 16 16s16-7.2 16-16V256zM160 240c5.5 0 10.9 .7 16 2v-2V208c0-8.8-7.2-16-16-16s-16 7.2-16 16v32h16zm64 24v40c0 8.8 7.2 16 16 16s16-7.2 16-16V256 240c0-8.8-7.2-16-16-16s-16 7.2-16 16v24z"/></svg>',Mn='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M433.941 129.941l-83.882-83.882A48 48 0 0 0 316.118 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V163.882a48 48 0 0 0-14.059-33.941zM272 80v80H144V80h128zm122 352H54a6 6 0 0 1-6-6V86a6 6 0 0 1 6-6h42v104c0 13.255 10.745 24 24 24h176c13.255 0 24-10.745 24-24V83.882l78.243 78.243a6 6 0 0 1 1.757 4.243V426a6 6 0 0 1-6 6zM224 232c-48.523 0-88 39.477-88 88s39.477 88 88 88 88-39.477 88-88-39.477-88-88-88zm0 128c-22.056 0-40-17.944-40-40s17.944-40 40-40 40 17.944 40 40-17.944 40-40 40z"/></svg>',Dn='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>',zn='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V288H216c-13.3 0-24 10.7-24 24s10.7 24 24 24H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zM384 336V288H494.1l-39-39c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l80 80c9.4 9.4 9.4 24.6 0 33.9l-80 80c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l39-39H384zm0-208H256V0L384 128z"/></svg>',Vn='<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M128 64c0-35.3 28.7-64 64-64H352V128c0 17.7 14.3 32 32 32H512V448c0 35.3-28.7 64-64 64H192c-35.3 0-64-28.7-64-64V336H302.1l-39 39c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l80-80c9.4-9.4 9.4-24.6 0-33.9l-80-80c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l39 39H128V64zm0 224v48H24c-13.3 0-24-10.7-24-24s10.7-24 24-24H128zM512 128H384V0L512 128z"/></svg>',ie;const Hn=new Uint8Array(16);function Un(){if(!ie&&(ie=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ie))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ie(Hn)}const v=[];for(let h=0;h<256;++h)v.push((h+256).toString(16).slice(1));function $n(h,n=0){return v[h[n+0]]+v[h[n+1]]+v[h[n+2]]+v[h[n+3]]+"-"+v[h[n+4]]+v[h[n+5]]+"-"+v[h[n+6]]+v[h[n+7]]+"-"+v[h[n+8]]+v[h[n+9]]+"-"+v[h[n+10]]+v[h[n+11]]+v[h[n+12]]+v[h[n+13]]+v[h[n+14]]+v[h[n+15]]}const Bn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),qe={randomUUID:Bn};function ht(h,n,e){if(qe.randomUUID&&!n&&!h)return qe.randomUUID();h=h||{};const t=h.random||(h.rng||Un)();return t[6]=t[6]&15|64,t[8]=t[8]&63|128,$n(t)}let Wn="2",Gn="3";class dt{constructor(n,e,t,s=!1){this.id=t;let i=new M("tool_"+this.id,!0,e);n.add(i),s&&i.onClick()}register(n){n.set(this.id,this)}render(n){let e=n.bbox_xyxy[2]-n.bbox_xyxy[0],t=n.bbox_xyxy[3]-n.bbox_xyxy[1],s=document.createElement("canvas");return s.width=e,s.height=t,s.getContext("2d").clearRect(0,0,e,t),s}onStart(n,e,t,s,i,o,l){}onMove(n,e,t,s,i,o,l){}onEnd(n,e,t,s,i,o,l){}activate(){}deactivate(){}}class ut{constructor(n,e,t,s,i,o,l,r,a=!1){this.id=t,this.color=s,this.lineWidth=i,this.transparency=o;let c=new M("tool_"+this.id,!0,e);n.add(c),a&&c.onClick(),c.addPopup(new vn([new X(e,"base",s=="base"),new X(e,"brand",s=="brand"),new X(e,"accent",s=="accent"),new X(e,"good",s=="good"),new X(e,"bad",s=="bad"),new Ge("o",l),new Ge("O",r)])),R.register("toolbar/setting",this.onSettingChanged.bind(this))}onSettingChanged(n,e){n=="toolbar/setting"&&e.type=="setting"&&e.data.id=="tool_"+this.id&&(e.data.color&&(this.color=e.data.color),e.data.size&&(this.lineWidth=e.data.size))}getTransparancy(){return this.transparency}register(n){n.set(this.id,this)}render(n){let e=n.bbox_xyxy[2]-n.bbox_xyxy[0],t=n.bbox_xyxy[3]-n.bbox_xyxy[1],s=document.createElement("canvas");return s.width=e,s.height=t,s.getContext("2d").clearRect(0,0,e,t),s}onStart(n,e,t,s,i,o,l){}onMove(n,e,t,s,i,o,l){}onEnd(n,e,t,s,i,o,l){}activate(){}deactivate(){}}function k(h){return Math.round(h*100)/100}let qn=.2;class jn extends ut{constructor(e){super(e,Pn,"pen","brand",.4,"FF",.4,.8,!0);d(this,"points",[]);d(this,"lastPoint",[0,0])}render(e){let t=10,s=(e.bbox_xyxy[2]-e.bbox_xyxy[0])*t,i=(e.bbox_xyxy[3]-e.bbox_xyxy[1])*t,o=document.createElement("canvas");o.width=s,o.height=i;let l=o.getContext("2d");l.clearRect(0,0,s,i);let r=getComputedStyle(document.body).getPropertyValue("--color-"+e.data[0]+"-font");l.strokeStyle=r+this.transparency,l.lineWidth=e.data[1]*t,l.beginPath();let a=!0;for(let c of e.data[2]){let u=c[0]*t,p=c[1]*t;a?(l.moveTo(u,p),a=!1):l.lineTo(u,p)}return l.stroke(),l.closePath(),o}onStart(e,t,s,i,o,l,r){let a=getComputedStyle(document.body).getPropertyValue("--color-"+this.color+"-font");t.strokeStyle=a+this.transparency,t.lineWidth=this.lineWidth/r,t.beginPath(),t.moveTo((s-o)/r,(i-l)/r),this.points.push([s,i]),this.lastPoint=[s,i]}onMove(e,t,s,i,o,l,r){let[a,c]=this.lastPoint;if(Math.sqrt((s-a)**2+(i-c)**2)<qn)return;t.lineTo((s-o)/r,(i-l)/r);let u=getComputedStyle(document.body).getPropertyValue("--color-"+this.color+"-font");t.strokeStyle=u+this.transparency,t.lineWidth=this.lineWidth/r,t.stroke(),this.points.push([s,i]),this.lastPoint=[s,i]}onEnd(e,t,s,i,o,l,r){t.lineTo((s-o)/r,(i-l)/r);let a=getComputedStyle(document.body).getPropertyValue("--color-"+this.color+"-font");t.strokeStyle=a+this.transparency,t.lineWidth=this.lineWidth/r,t.stroke(),t.closePath(),this.points.push([s,i]);let[c,u]=this.normalizePoints(this.points,this.lineWidth);this.points=[],e.addElements([{uuid:ht(),type:this.id,layer:Gn,bbox_xyxy:u,data:[this.color,this.lineWidth,c]}])}normalizePoints(e,t){let s=e[0][0],i=e[0][1],[o,l,r,a]=[s,i,s,i];for(let u of e)o=Math.min(o,u[0]),l=Math.min(l,u[1]),r=Math.max(r,u[0]),a=Math.max(a,u[1]);o-=5+t,l-=5+t,r+=5+t,a+=5+t;let c=[];o=k(o),r=k(r),l=k(l),a=k(a);for(let u of e)c.push([k(u[0]-o),k(u[1]-l)]);return[c,[o,l,r,a]]}activate(){}deactivate(){}}let Yn=1;class Xn extends ut{constructor(e){super(e,On,"marker","accent",5,"77",5,10);d(this,"points",[]);d(this,"lastPoint",[0,0])}render(e){let t=5,s=(e.bbox_xyxy[2]-e.bbox_xyxy[0])*t,i=(e.bbox_xyxy[3]-e.bbox_xyxy[1])*t,o=document.createElement("canvas");o.width=s,o.height=i;let l=o.getContext("2d");l.clearRect(0,0,s,i);let r=getComputedStyle(document.body).getPropertyValue("--color-"+e.data[0]+"-font");l.strokeStyle=r+this.transparency,l.lineWidth=e.data[1]*t,l.beginPath();let a=!0;for(let c of e.data[2]){let u=c[0]*t,p=c[1]*t;a?(l.moveTo(u,p),a=!1):l.lineTo(u,p)}return l.stroke(),l.closePath(),o}onStart(e,t,s,i,o,l,r){let a=getComputedStyle(document.body).getPropertyValue("--color-"+this.color+"-font");t.strokeStyle=a+this.transparency,t.lineWidth=this.lineWidth/r,t.beginPath(),t.moveTo((s-o)/r,(i-l)/r),this.points.push([s,i]),this.lastPoint=[s,i]}onMove(e,t,s,i,o,l,r){let[a,c]=this.lastPoint;if(Math.sqrt((s-a)**2+(i-c)**2)<Yn)return;t.lineTo((s-o)/r,(i-l)/r);let u=getComputedStyle(document.body).getPropertyValue("--color-"+this.color+"-font");t.strokeStyle=u+this.transparency,t.lineWidth=this.lineWidth/r,t.stroke(),this.points.push([s,i]),this.lastPoint=[s,i]}onEnd(e,t,s,i,o,l,r){t.lineTo((s-o)/r,(i-l)/r);let a=getComputedStyle(document.body).getPropertyValue("--color-"+this.color+"-font");t.strokeStyle=a+this.transparency,t.lineWidth=this.lineWidth/r,t.stroke(),t.closePath(),this.points.push([s,i]);let[c,u]=this.normalizePoints(this.points,this.lineWidth);this.points=[],e.addElements([{uuid:ht(),type:this.id,layer:Wn,bbox_xyxy:u,data:[this.color,this.lineWidth,c]}])}normalizePoints(e,t){let s=e[0][0],i=e[0][1],[o,l,r,a]=[s,i,s,i];for(let u of e)o=Math.min(o,u[0]),l=Math.min(l,u[1]),r=Math.max(r,u[0]),a=Math.max(a,u[1]);o-=5+t,l-=5+t,r+=5+t,a+=5+t;let c=[];o=k(o),r=k(r),l=k(l),a=k(a);for(let u of e)c.push([k(u[0]-o),k(u[1]-l)]);return[c,[o,l,r,a]]}activate(){}deactivate(){}}function me(h){let n=[Math.min(h[0][0],h[1][0]),Math.min(h[0][1],h[1][1])],e=[Math.max(h[0][0],h[1][0]),Math.max(h[0][1],h[1][1])];return[n,e]}function je(h,n){return h[0][0]<=n[1][0]&&h[1][0]>=n[0][0]&&h[0][1]<=n[1][1]&&h[1][1]>=n[0][1]}function Zn(h,n){const e=n[0][0]-h[0][0],t=n[0][1]-h[0][1],s=h[1][0]-h[0][0],i=h[1][1]-h[0][1],o=n[1][0]-n[0][0],l=n[1][1]-n[0][1],r=s*l-i*o;if(r!=0){const a=e*l-t*o,c=e*i-t*s,u=a/r,p=c/r;if(0<=u&&u<=1&&0<=p&&p<=1)return!0}return!1}let Qn=["pen","marker"];class Jn extends dt{constructor(e){super(e,Nn,"erasor");d(this,"x0",0);d(this,"y0",0)}onStart(e,t,s,i,o,l,r){this.x0=s,this.y0=i}onMove(e,t,s,i,o,l,r){if(s!=this.x0&&i!=this.y0){let a=[],c=[[this.x0,this.y0],[s,i]];this.drawDebugLine(t,c,o,l,r,"#FF000033",1),e.getDocument().forEach((u,p)=>{if(!Qn.includes(u.type))return;let f=[[u.bbox_xyxy[0],u.bbox_xyxy[1]],[u.bbox_xyxy[2],u.bbox_xyxy[3]]];if(je(me(c),f)){let y=u.data[2],w=u.bbox_xyxy[0],x=u.bbox_xyxy[1];for(let b=1;b<y.length;b++){let S=[y[b-1],y[b]];if(S=[[S[0][0]+w,S[0][1]+x],[S[1][0]+w,S[1][1]+x]],je(me(c),me(S))&&Zn(S,c)){a.push(u);return}}}}),a.length>0&&e.deleteElements(a),this.x0=s,this.y0=i}}drawDebugLine(e,t,s,i,o,l,r){e.beginPath(),e.moveTo((t[0][0]-s)/o,(t[0][1]-i)/o),e.lineTo((t[1][0]-s)/o,(t[1][1]-i)/o),e.strokeStyle=l,e.lineWidth=r,e.stroke(),e.closePath()}onEnd(e,t,s,i,o,l,r){this.onMove(e,t,s,i,o,l,r),e.requestRedraw()}}class Kn extends dt{constructor(e){super(e,An,"insertSpace");d(this,"movingElements",[]);d(this,"lastY",0)}onStart(e,t,s,i){this.movingElements=[];let o=e.getDocument();for(let[l,r]of o)i<r.bbox_xyxy[1]&&this.movingElements.push(r);this.lastY=i}onMove(e,t,s,i){for(let o of this.movingElements){let l=i-this.lastY;o.bbox_xyxy[1]=k(o.bbox_xyxy[1]+l),o.bbox_xyxy[3]=k(o.bbox_xyxy[3]+l)}this.lastY=i,e.modifyElements(this.movingElements,!0)}onEnd(e,t,s,i){this.onMove(e,t,s,i)}}class es extends E{constructor(n,e){super("div","","toolbar"),e&&this.add(new M("back",!1,Rn));let t=new M("save",!1,Mn);R.register("save",(i,o)=>{o.type=="saved"?t.htmlElement.style.fill="var(--color-brand-c1)":t.htmlElement.style.fill="var(--color-bad-font)"}),this.add(t),this.add(new Ln),new jn(this).register(n),new Xn(this).register(n),new Jn(this).register(n),new Kn(this).register(n);let s=new M("menu",!1,Ye,!0,!1);s.addPopup(new In([new fe("clear",Dn,"Clear"),new fe("export",zn,"Export"),new fe("import",Vn,"Import")])),this.add(s),this.add(new M("touchToggle",!1,Fn,!0,!0))}}function ts(h,n){let e=new PointerEvent("mouse"),t=new PointerEvent("pen"),s=new TouchEvent("touch"),i=!1,o=0,l=!1;h.addEventListener("touchstart",function(r){r.preventDefault(),r.targetTouches.length==1&&n.onTouchStart(r),r.targetTouches.length==2&&n.onPinchStart(r),s=r}),h.addEventListener("touchmove",function(r){r.preventDefault(),s.targetTouches.length==1&&(r.targetTouches.length==1?n.onTouchMove(r,s):n.onTouchEnd(r,s),r.targetTouches.length==2&&n.onPinchStart(r)),s.targetTouches.length==2&&(r.targetTouches.length==2?n.onPinchMove(r,s):n.onPinchEnd(r,s),r.targetTouches.length==1&&n.onTouchStart(r)),s=r}),h.addEventListener("touchend",function(r){r.preventDefault(),s.targetTouches.length==1?n.onTouchEnd(r,s):s.targetTouches.length==2&&n.onPinchEnd(r,s),s=r}),h.addEventListener("pointerdown",function(r){r.preventDefault(),r.pointerType=="mouse"&&!i?(i=!0,o=r.button,n.onMouseStart(r,o),e=r):r.pointerType=="pen"&&!l&&(l=!0,n.onPenStart(r),t=r)}),h.addEventListener("pointermove",function(r){r.preventDefault(),r.pointerType=="mouse"&&i?(n.onMouseMove(r,o,e),e=r):r.pointerType=="pen"&&l&&(n.onPenMove(r,t),t=r)}),h.addEventListener("pointerup",function(r){r.preventDefault(),r.pointerType=="mouse"&&i&&r.button==o?(n.onMouseEnd(r,o,e),i=!1,e=r):r.pointerType=="pen"&&l&&(n.onPenEnd(r,t),l=!1,t=r)})}function ns(h,n,e){return'<svg width="'+n+'" height="'+e+`" xmlns="http://www.w3.org/2000/svg">
`+h+"</svg>"}function ss(h,n,e){let t=[];for(let s of h)t.push(s[0]+","+s[1]);return'<polyline points="'+t.join(" ")+'" style="fill:none;stroke:'+n+";stroke-width:"+e+`" />
`}function is(h){return`<!--
`+h+`
-->
`}let Z=210,ge=297;class os extends E{constructor(e,t="notepad-container",s=!1){super("div","",t);d(this,"tools",new Map);d(this,"canvasContainer");d(this,"layers",new Map);d(this,"textures",new Map);d(this,"pageElements",new Map);d(this,"canvas");d(this,"context");d(this,"offscreenCanvas");d(this,"offscreenContext");d(this,"activeTool","pen");d(this,"isTouchAllowed",!1);d(this,"offset",[0,0]);d(this,"scale",1.05);d(this,"deviceScale",1);d(this,"lowestEntity",0);d(this,"saving",null);d(this,"mousePos",[0,0]);d(this,"background","grid");this.add(new es(this.tools,s)),this.canvasContainer=new E("div","","notepad-canvasContainer"),this.add(this.canvasContainer),this.canvas=document.createElement("canvas"),this.offscreenCanvas=document.createElement("canvas"),this.canvasContainer.htmlElement.appendChild(this.canvas),this.context=this.canvas.getContext("2d",{desynchronized:!0}),this.offscreenContext=this.offscreenCanvas.getContext("2d"),window.onresize=this.resizeHandler.bind(this),R.register("toolbar/change",this.onToolbarChange.bind(this)),this.canvas.oncontextmenu=()=>!1,this.canvas.addEventListener("pointermove",this.computeRawPointerPosition.bind(this)),ts(this.canvas,this),this.canvas.addEventListener("wheel",this.scroll.bind(this),!1),this.setData(e),window.setTimeout(this.resizeHandler.bind(this),100)}onBack(e){alert("Notepad::onBack has to be implemented by user.")}onSave(e){alert("Notepad::onSave has to be implemented by user.")}save(){this.onSave(this.getData()),R.send("save",{allowNetwork:!1,data:null,type:"saved"})}getData(){const e=Array.from(this.getDocument().values());return JSON.stringify({version:"1.1",elements:e})}setData(e){if(this.deleteElements(this.getDocument().values(),!1),!e||e=="")return;let t=JSON.parse(e);if(t.version===void 0){for(const s in t){let i=t[s],o=i.bbox_xyxy;if(i.bbox_xyxy=[k(o[0]/7),k(o[1]/7),k(o[2]/7),k(o[3]/7)],i.type=="pen"||i.type=="marker"){i.data[1]=k(i.data[1]/7);for(const l in i.data[2])i.data[2][l][0]=k(i.data[2][l][0]/7),i.data[2][l][1]=k(i.data[2][l][1]/7)}}t={version:"0",elements:t},this.delayedAutosave()}if(t.version=="1")for(const s in t.elements){let i=t.elements[s],o=i.bbox_xyxy;if(i.bbox_xyxy=[k(o[0]),k(o[1]),k(o[2]),k(o[3])],i.type=="pen"||i.type=="marker"){i.data[1]=k(i.data[1]);for(const l in i.data[2])i.data[2][l][0]=k(i.data[2][l][0]),i.data[2][l][1]=k(i.data[2][l][1])}}this.addElements(t.elements,!1)}delayedAutosave(){this.saving!=null&&window.clearTimeout(this.saving),R.send("save",{allowNetwork:!1,data:null,type:"dirty"}),this.saving=window.setTimeout(this.save.bind(this),5e3)}scroll(e){e.deltaY>0?this.changeScale(1.1,this.mousePos):this.changeScale(1/1.1,this.mousePos)}changeScale(e,t){let s=this.scale,i=this.canvas.getBoundingClientRect(),o=i.width*this.scale,l=i.height*this.scale,r=this.offset[0],a=this.offset[1];this.scale*=e,this.scale<.25*this.deviceScale&&(this.scale=.25*this.deviceScale),this.scale>5*this.deviceScale&&(this.scale=5*this.deviceScale);let c=this.scale/s;r+=(1-c)*o*t[0],a+=(1-c)*l*t[1],this.offset[0]=r,this.offset[1]=a,this.limitOffset(),this.requestRedraw()}onMouseStart(e,t){var a;let s=this.computeRawPointerPosition(e),{x:i,y:o,dx:l,dy:r}=this.computeVirtualPosition(s);t==0&&((a=this.tools.get(this.activeTool))==null||a.onStart(this,this.context,i,o,l,r,this.scale))}onMouseMove(e,t,s){var c;let i=this.computeRawPointerPosition(e),{x:o,y:l,dx:r,dy:a}=this.computeVirtualPosition(i);if(t==0&&((c=this.tools.get(this.activeTool))==null||c.onMove(this,this.context,o,l,r,a,this.scale)),t==1||t==2){let u=this.computeRawPointerPosition(s),p=this.computeVirtualPosition(u);this.offset[0]+=p.x-o,this.offset[1]+=p.y-l,this.limitOffset(),this.requestRedraw()}}onMouseEnd(e,t,s){var c;let i=this.computeRawPointerPosition(e),{x:o,y:l,dx:r,dy:a}=this.computeVirtualPosition(i);t==0&&((c=this.tools.get(this.activeTool))==null||c.onEnd(this,this.context,o,l,r,a,this.scale))}onPenStart(e){var r;let t=this.computeRawPointerPosition(e),{x:s,y:i,dx:o,dy:l}=this.computeVirtualPosition(t);(r=this.tools.get(this.activeTool))==null||r.onStart(this,this.context,s,i,o,l,this.scale)}onPenMove(e,t){var a;let s=this.computeRawPointerPosition(e),{x:i,y:o,dx:l,dy:r}=this.computeVirtualPosition(s);(a=this.tools.get(this.activeTool))==null||a.onMove(this,this.context,i,o,l,r,this.scale)}onPenEnd(e,t){var a;let s=this.computeRawPointerPosition(e),{x:i,y:o,dx:l,dy:r}=this.computeVirtualPosition(s);(a=this.tools.get(this.activeTool))==null||a.onEnd(this,this.context,i,o,l,r,this.scale)}onTouchStart(e){}onTouchMove(e,t){if(this.isTouchAllowed){let s=this.computeRawTouchPositions(e)[0],{x:i,y:o}=this.computeVirtualPosition(s),l=this.computeRawTouchPositions(t)[0],r=this.computeVirtualPosition(l);this.offset[0]+=r.x-i,this.offset[1]+=r.y-o,this.limitOffset(),this.requestRedraw()}}onTouchEnd(e,t){}onPinchStart(e){}onPinchMove(e,t){if(this.isTouchAllowed){let[s,i]=this.computeRawTouchPositions(e),[o,l]=this.computeRawTouchPositions(t),r=Math.sqrt((s[0]-i[0])**2+(s[1]-i[1])**2),a=Math.sqrt((o[0]-l[0])**2+(o[1]-l[1])**2),c=[(s[0]+i[0])/2,(s[1]+i[1])/2],u=[(o[0]+l[0])/2,(o[1]+l[1])/2],p=a/r;if(!isNaN(p)){let{x:f,y}=this.computeVirtualPosition(c),w=this.computeVirtualPosition(u);this.offset[0]+=w.x-f,this.offset[1]+=w.y-y;let x=this.canvas.getBoundingClientRect();this.changeScale(p,[c[0]/x.width,c[1]/x.height])}}}onPinchEnd(e,t){}computeRawPointerPosition(e){let t=this.canvas.getBoundingClientRect(),s=e.x-t.left,i=e.y-t.top;return e.pointerType=="mouse"&&(this.mousePos[0]=s/t.width,this.mousePos[1]=i/t.height),[s,i]}computeRawTouchPositions(e){let t=this.canvas.getBoundingClientRect(),s=[];for(let i=0;i<e.targetTouches.length;i++){let o=e.targetTouches[i],l=o.clientX-t.left,r=o.clientY-t.top;s.push([l,r])}return s}computeVirtualPosition(e){let t=this.offset[0],s=this.offset[1],i=e[0]*this.scale+t,o=e[1]*this.scale+s;return{x:i,y:o,dx:t,dy:s}}limitOffset(){Z/this.scale<this.canvas.width?this.offset[0]=Z/2-this.canvas.width/2*this.scale:(this.offset[0]=Math.min(this.offset[0],Z-this.scale*this.canvas.width*19/20),this.offset[0]=Math.max(this.offset[0],-this.scale*this.canvas.width/20)),this.offset[1]=Math.min(this.offset[1],this.lowestEntity-this.scale*this.canvas.height/20),this.offset[1]=Math.max(this.offset[1],-this.scale*this.canvas.height/20)}getDocument(){return this.pageElements}addElements(e,t=!0){this.modifyElements(e,!1,t)}modifyElements(e,t=!1,s=!0){if(!t)for(let i of e){let o=i.type;this.tools.has(o)||alert("Unsupported tool please let the dev know: "+o);let r=this.tools.get(o).render(i);this.pageElements.set(i.uuid,i),this.textures.set(i.uuid,r),this.layers.has(i.layer)||this.layers.set(i.layer,[]);let a=this.layers.get(i.layer);a.indexOf(i.uuid)==-1&&a.push(i.uuid)}this.lowestEntity=0;for(let[i,o]of this.pageElements)this.lowestEntity=Math.max(o.bbox_xyxy[3],this.lowestEntity);this.requestRedraw(),s&&this.delayedAutosave()}deleteElements(e,t=!0){for(let s of e){this.pageElements.delete(s.uuid),this.textures.delete(s.uuid);let i=this.layers.get(s.layer),o=i.indexOf(s.uuid);o>-1&&i.splice(o,1)}this.requestRedraw(),t&&this.delayedAutosave()}requestRedraw(){window.requestAnimationFrame(this.render.bind(this))}render(){let e=this.canvas.width,t=this.canvas.height,s=getComputedStyle(document.body).getPropertyValue("--color-base");this.offscreenContext.fillStyle=s,this.offscreenContext.fillRect(0,0,e,t);let i=Array.from(this.layers.keys());i=i.sort();let o=this.offset[0],l=this.offset[1];for(let c=0;c<2;c++){let u=(Z*c-o)/this.scale;this.offscreenContext.beginPath(),this.offscreenContext.moveTo(u,0),this.offscreenContext.lineTo(u,t);let p=getComputedStyle(document.body).getPropertyValue("--color-bad-font");this.offscreenContext.strokeStyle=p+"AA",this.offscreenContext.lineWidth=2,this.offscreenContext.stroke(),this.offscreenContext.closePath()}let r=Math.ceil(this.canvas.height/(ge/this.scale)),a=Math.floor(l/ge)+1;for(let c=0;c<r;c++){let u=(ge*(c+a)-l)/this.scale;this.offscreenContext.beginPath(),this.offscreenContext.moveTo(0,u),this.offscreenContext.lineTo(e,u);let p=getComputedStyle(document.body).getPropertyValue("--color-bad-font");this.offscreenContext.strokeStyle=p+"AA",this.offscreenContext.lineWidth=2,this.offscreenContext.stroke(),this.offscreenContext.closePath()}this.background=="grid"?this.drawGrid(this.offscreenContext,o,l,e,t):this.background=="lines"&&this.drawLines(this.offscreenContext,o,l,e,t);for(let c of i){let u=this.layers.get(c);for(let p of u){let f=this.pageElements.get(p),y=this.textures.get(p),[w,x,b,S]=f.bbox_xyxy;w=(w-o)/this.scale,x=(x-l)/this.scale,b=(b-o)/this.scale,S=(S-l)/this.scale,(0<=w&&w<=e&&0<=x&&x<=t||0<=b&&b<=e&&0<=S&&S<=t)&&this.offscreenContext.drawImage(y,w,x,b-w,S-x)}}this.context.drawImage(this.offscreenCanvas,0,0,this.canvas.width,this.canvas.height)}drawLines(e,t,s,i,o){let l=10,r=Math.ceil(o/(l/this.scale)),a=Math.floor(s/100)+1;for(let c=0;c<r;c++){let u=(l*(c+a)-s)/this.scale;e.beginPath(),e.moveTo(0,u),e.lineTo(i,u);let p=getComputedStyle(document.body).getPropertyValue("--color-base-hover");e.strokeStyle=p+"AA",e.lineWidth=1,e.stroke(),e.closePath()}}drawGrid(e,t,s,i,o){let l=5,r=Math.ceil(o/(l/this.scale)),a=Math.floor(s/l)+1;for(let p=0;p<r;p++){let f=(l*(p+a)-s)/this.scale;e.beginPath(),e.moveTo(0,f),e.lineTo(i,f);let y=getComputedStyle(document.body).getPropertyValue("--color-base-hover");e.strokeStyle=y+"AA",e.lineWidth=1,e.stroke(),e.closePath()}let c=Math.ceil(i/(l/this.scale)),u=Math.floor(t/l)+1;for(let p=0;p<c;p++){let f=(l*(p+u)-t)/this.scale;e.beginPath(),e.moveTo(f,0),e.lineTo(f,o);let y=getComputedStyle(document.body).getPropertyValue("--color-base-hover");e.strokeStyle=y+"AA",e.lineWidth=1,e.stroke(),e.closePath()}}onToolbarChange(e,t){var s,i;if(t.type=="string"&&t.data.indexOf("tool_")==0){let o=this.activeTool;this.activeTool=t.data.substring(5),o!=this.activeTool&&((s=this.tools.get(o))==null||s.deactivate(),(i=this.tools.get(this.activeTool))==null||i.activate(),console.log("Switched tool to: "+this.activeTool))}else if(t.type=="string"&&t.data=="touchToggle")this.isTouchAllowed=!this.isTouchAllowed;else if(t.type=="string"&&t.data=="save")this.saving!=null&&window.clearTimeout(this.saving),this.save();else if(t.type=="string"&&t.data=="back")this.saving!=null?(window.clearTimeout(this.saving),this.onBack(!0)):this.onBack(!1);else if(t.type=="string"&&t.data=="export"){let o=new Date().toISOString().substring(0,19).replace("T","_").replaceAll(":",""),l=this.getSVG();this.saveToLocalTextFile(l,o+"_Note.spf.svg")}else if(t.type=="string"&&t.data=="import"){let o=new ee;o.add(new E("div",m.NOTEPAD_IMPORT_QUESTION,"notepad-importHeader"));let l=new F("importFile","*.spf.svg or *.spf","file","notepad-importFile");o.add(l);let r=new C(m.NOTEPAD_IMPORT_CONFIRM,"notepad-importConfirm"),a=this;r.onClick=()=>{var u;if((u=l.htmlElement.files)!=null&&u.length){let p=l.htmlElement.files[0];if(!p.name.endsWith(".spf.svg")&&!p.name.endsWith(".spf")){alert(m.NOTEPAD_IMPORT_UNSUPPORTED_FILE);return}var c=new FileReader;c.onload=function(f){let y=f.target;if(y!=null){let w=y.result;if(p.name.endsWith(".spf.svg")){let x=w.indexOf(`<!--
`),b=w.indexOf(`
-->`);w=w.slice(x+5,b)}a.setData(w),R.send("save",{allowNetwork:!1,data:null,type:"dirty"}),o.dispose()}},c.readAsBinaryString(p)}},o.add(r),o.show()}else if(t.type=="string"&&t.data=="clear"){let o="popupContent",l="popupContainer",r=new ce(o,l,m.NOTEPAD_CLEAR_QUESTION,m.NOTEPAD_CLEAR_CANCEL,m.NOTEPAD_CLEAR_CONFIRM);r.onConfirm=()=>{},r.onCancel=()=>{this.deleteElements(this.getDocument().values(),!1),R.send("save",{allowNetwork:!1,data:null,type:"dirty"})},r.show()}}getSVG(){let e=1,t=0,s=0,i=1e5,o=1e5,l="";l+=is(this.getData());let r=Array.from(this.layers.keys());r=r.sort();for(let a of r){let c=this.layers.get(a);for(let u of c){let p=this.pageElements.get(u);console.log(p.type);let[f,y,w,x]=p.bbox_xyxy;w>t&&(t=w),x>s&&(s=x),f<i&&(i=f),y<o&&(o=y)}}for(let a of r){let c=this.layers.get(a);for(let u of c){let p=this.pageElements.get(u);console.log(p.type);let[f,y,w,x]=p.bbox_xyxy,b=p.type;if(this.tools.has(b)||alert("Unsupported tool please let the dev know: "+b),b=="pen"||b=="marker"){let S=this.tools.get(b),B=getComputedStyle(document.body).getPropertyValue("--color-"+p.data[0]+"-font");B=B+S.getTransparancy();let ne=p.data[1]*e,q=[];for(let W of p.data[2]){let V=f+W[0]*e,pt=y+W[1]*e;q.push([V-i,pt-o])}let ue=ss(q,B,ne);l+=ue}}}return ns(l,t-i,s-o)}saveToLocalTextFile(e,t){let s=new Blob([e],{type:"text/plain"}),i=document.createElement("a");i.href=window.URL.createObjectURL(s),i.download=typeof t=="string"?t:"download",i.target="_blank",i.click(),i.remove()}resizeHandler(){this.canvas.width=this.canvasContainer.htmlElement.clientWidth,this.canvas.height=this.canvasContainer.htmlElement.clientHeight,this.offscreenCanvas.width=this.canvas.width,this.offscreenCanvas.height=this.canvas.height;let e=this.deviceScale;this.deviceScale=Z/this.canvas.width,this.scale=this.scale/e*this.deviceScale,this.limitOffset(),this.requestRedraw(),console.log("resized")}}const ls=["txt","json","yaml","py","ts","js","rs","c","h","hpp","cpp","sh","bat"];class Le{constructor(n,e,t,s,i){this.instance=n,this.filepath=e,this.filename=t,this.md5=s,this.ext=i}static async get(n){let e=n.split(":")[0],t=n.split(":")[1],s=t.split("/")[t.split("/").length-1],i=s.split("."),o=i[i.length-1].toLowerCase(),l=L.connections.get(e);if(l==null)return null;let r=await l.md5(t);return r==null?null:new Le(l,t,s,r,o)}}class rs extends E{constructor(){super("div","","editPage");d(this,"openDocument","");d(this,"isDirty",!1);d(this,"saveCallback",null);document.addEventListener("keydown",e=>{e.ctrlKey&&e.key==="s"&&(e.preventDefault(),this.saveCallback!=null&&this.saveCallback())})}async update(e,t){if(e.view==this.openDocument)return;if(this.isDirty){alert(m.VIEWER_UNSAVED_CHANGES);return}if(this.openDocument=e.view,this.parent.parent.setPreferedView("master"),this.htmlElement.innerHTML="",this.saveCallback=null,e.view=="")return;let s=await Le.get(e.view);if(s==null){alert(m.VIEWER_READ_FILE_ERROR);return}this.parent.parent.setPreferedView("detail"),["md","csv"].includes(s.ext)?await this.handleMDFile(s):ls.includes(s.ext)?await this.handleTextFile(s):["pdf"].includes(s.ext)?await this.handlePDFFile(s):s.filename.endsWith(".spf.svg")?await this.handleSPFFile(s):["png","svg","jpg","jpeg","tiff","tif"].includes(s.ext)?await this.handleImageFile(s):await this.handleUnknownFile(s)}async handleImageFile(e){this.createNavbar(e);let t=new E("div","","editImageBackground"),s=new E("img","","editImageView");t.add(s),this.add(t);let i=["tiff","tif"].includes(e.ext)?-1:0;s.htmlElement.src=e.instance.readURL(e.filepath,i),s.htmlElement.onload=()=>{let o=s.htmlElement.width,l=s.htmlElement.height,r=t.htmlElement.clientWidth,a=t.htmlElement.clientHeight,c=o/r,u=l/a,p=c>u?c:u;s.htmlElement.width=o/p,s.htmlElement.height=l/p}}async handleMDFile(e){let t=new z(pe);t.hide(),this.createNavbar(e,[t],[],()=>l.isSaved());let s=new E("div","","editTextOutput"),i=new E("div","","mdOutput");s.add(i),this.add(s);let o=await e.instance.readTxt(e.filepath);if(o==null||e.md5==null){alert(m.VIEWER_READ_FILE_ERROR);return}let l=new xn(i.htmlElement,async r=>this.onSave(e,r,t,()=>l.getText()),!1);l.pluginCreateChunk=r=>{const a=u=>{const p=u.split(`
`);if(p.length<=1)return!1;let f=(p[0].match(/;/g)||[]).length;if(f==0)return!1;for(const y of p)if(y!=""&&f!=(y.match(/;/g)||[]).length)return!1;return!0},c=u=>{const p=u.split(`
`),f=p[0].split(";").map(w=>w.trim()),y=[f.join(" | "),f.map(()=>"---").join(" | ")];for(let w=1;w<p.length;w++){const x=p[w].split(";").map(b=>b.trim());for(let b=0;b<x.length;b++)if(x[b].startsWith("#")){for(;x[b].startsWith("#");)x[b]=x[b].substring(1);x[b]="**"+x[b].trim()+"**"}y.push(x.join(" | "))}for(let w=1;w<y.length;w++)y[w]="| "+y[w]+" |";return y.join(`
`)};return a(r)?c(r):r},l.load(o),l.onDirty=()=>{l.isSaved()?(t.hide(),this.isDirty=!1):(t.show(),this.isDirty=!0)},t.onClick=async()=>{l.save()},this.saveCallback=t.onClick}async handleTextFile(e){let t=!1,s=new z(pe);s.hide();let i=new z(We);this.createNavbar(e,[s],[i],()=>r.htmlElement.value.replaceAll(`\r
`,`
`)==o);let o=await e.instance.readTxt(e.filepath);if(o==null||e.md5==null){alert(m.VIEWER_READ_FILE_ERROR);return}o=o.replaceAll(`\r
`,`
`);let l=new E("div","","editTextOutput");l.htmlElement.innerHTML=o.replaceAll(`
`,"<BR>"),l.htmlElement.style.paddingTop="1em",this.add(l);let r=new E("textarea","","editTextOutputEdit");r.htmlElement.value=o,r.htmlElement.style.resize="none",r.hide(),r.htmlElement.oninput=()=>{r.htmlElement.value.replaceAll(`\r
`,`
`)==o?(s.hide(),this.isDirty=!1):(s.show(),this.isDirty=!0)},this.add(r),s.onClick=async()=>{let a=r.htmlElement.value.replaceAll(`\r
`,`
`);this.onSave(e,a,s,()=>r.htmlElement.value.replaceAll(`\r
`,`
`)),o=a},this.saveCallback=s.onClick,i.onClick=()=>{t=!t,t?(i.htmlElement.innerHTML=Tn,l.hide(),r.show()):(i.htmlElement.innerHTML=We,l.htmlElement.innerHTML=r.htmlElement.value.replaceAll(`
`,"<BR>"),l.show(),r.hide())}}async handleSPFFile(e){let t=new z(pe),s=await e.instance.readTxt(e.filepath);if(s==null||e.md5==null){alert(m.VIEWER_READ_FILE_ERROR);return}let i=s;if(i!=""){let l=i.indexOf(`<!--
`),r=i.indexOf(`
-->`);i=i.slice(l+5,r)}let o=new os(i,"notepad-container",!0);o.onSave=l=>this.onSave(e,o.getSVG(),t,()=>o.getSVG()),o.onBack=()=>{D.update({view:""})},this.add(o),this.saveCallback=o.save}async handlePDFFile(e){this.createNavbar(e);let t=new E("iframe","","editIFrame");t.htmlElement.name="editIFrame",t.htmlElement.src=e.instance.readURL(e.filepath),this.add(t)}async handleUnknownFile(e){this.createNavbar(e);let t=new E("div","","centerChildren"),s=new C(m.VIEWER_LOAD_HERE_FILE,"buttonLarge");s.setClass("good"),s.onClick=()=>{let i=new E("iframe","","editIFrame");i.htmlElement.name="editIFrame",i.htmlElement.src=e.instance.readURL(e.filepath),this.remove(t),this.add(i)},t.add(s),this.add(t)}async onSave(e,t,s,i){if(e.instance==null)return!1;if(await e.instance.putTxt(e.filepath,t,e.md5)){i()==t&&(s.hide(),this.isDirty=!1);let l=await e.instance.md5(e.filepath);if(l==null)return alert(m.VIEWER_READ_MD5_ERROR),!1;e.md5=l}else return alert(m.VIEWER_SAVE_FILE_ERROR),!1;return!0}createNavbar(e,t=[],s=[],i=()=>!0){let o=new Cn,l=new z(Xe);l.setClass("left"),l.onClick=()=>{if(i())D.update({view:""});else{let u=new ce("popupContent","popupContainer",m.VIEWER_EXIT_WITHOUT_SAVE_QUESTION,m.VIEWER_EXIT_WITHOUT_SAVE_CONTINUE_EDITING,m.VIEWER_EXIT_WITHOUT_SAVE_EXIT);u.onConfirm=()=>{},u.onCancel=()=>{this.isDirty=!1,D.update({view:""})}}},o.add(l),t.forEach(u=>{u.setClass("left"),o.add(u)}),o.add(new Sn(e.filename));let r=e.instance.readURL(e.filepath);if(r.includes("localhost")||r.includes("127.0.0.1")){let u=new z(kn);u.setClass("right"),u.onClick=()=>{e.instance.open(e.filepath)},o.add(u)}let a=new z(_n);a.setClass("right"),a.htmlElement.href=r,a.htmlElement.download=e.filename,o.add(a);let c=new z(bn);c.setClass("right"),c.onClick=()=>{new Dt(e.instance,e.filepath,e.md5,()=>{location.reload()})},o.add(c),s.forEach(u=>{u.setClass("right"),o.add(u)}),this.add(o)}hide(){super.hide()}}class as extends E{constructor(){super("div","Not implemented yet!","ai-chat")}}async function cs(){gt(),xt("kb"),document.getElementsByTagName("title")[0].innerHTML=m.APPNAME,kt(),new D("main&search=&view=",{main:new ye(new zt,new rs,new as)})}cs();
