var F=Object.defineProperty;var k=(o,s,e)=>s in o?F(o,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[s]=e;var r=(o,s,e)=>(k(o,typeof s!="symbol"?s+"":s,e),e);(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function t(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();class w{constructor(s,e){r(this,"currentPage","");var t;this.defaultPage=s,this.pages=e,location.hash.slice(1)==""&&(location.hash="#"+s),window.onhashchange=n=>{this.onOpen()};for(const n in e)(t=document.getElementById("app"))==null||t.appendChild(e[n].htmlElement),e[n].hide();this.onOpen()}onOpen(){var a,c,m;let s={},e=this.defaultPage,n=location.hash.slice(1).split("&");n.length>0&&(e=n[0],n=n.splice(1));for(const p of n){let h=p.split("="),d=decodeURIComponent(h[0]),f=decodeURIComponent(h[1]);s[d]=f}let i=this.currentPage!=e;i&&(console.log("Hide page: "+this.currentPage),(a=this.pages[this.currentPage])==null||a.hide(),this.currentPage=e,console.log("Show page: "+e),(c=this.pages[this.currentPage])==null||c.show()),console.log("Calling page.update with: "+JSON.stringify(s)),(m=this.pages[this.currentPage])==null||m.update(s,i)}static open(s,e){window.setTimeout(()=>{let t="";for(let n in e)t+="&"+encodeURIComponent(n)+"="+encodeURIComponent(e[n]);location.hash="#"+encodeURIComponent(s)+t},200)}static back(){history.back()}}class u{constructor(){}static APPLY_COUNTED(s,e){return e.replace("{count}",s.toString())}}r(u,"TIME_LOCALE","en"),r(u,"TIME_YESTERDAY","yesterday"),r(u,"TIME_HOURS_AGO","{count} hour(s) ago"),r(u,"TIME_MINUTES_AGO","{count} minute(s) ago"),r(u,"TIME_SECONDS_AGO","{count} second(s) ago"),r(u,"TIME_TODAY_AT","today at"),r(u,"TIME_JUST_NOW","just now"),r(u,"APPNAME","Knowledgebase"),r(u,"LOGIN_KNOWN_CONNECTIONS","Reuse Connection"),r(u,"LOGIN_SESSION_NAME","Session Name"),r(u,"LOGIN_API_ENDPOINT_LABEL","API Endpoint URL"),r(u,"LOGIN_API_TOKEN_LABEL","API Token"),r(u,"LOGIN_SUBMIT","Add Connection"),r(u,"LOGIN_ERROR_MISSING_INPUTS","You must provide all fields (session name, api endpoint and api token)."),r(u,"LOGIN_ERROR_LOGIN_FAILED","The provided login information is wrong. Is the URL and API token correct?"),r(u,"SEARCH_FILETREE_IS_NULL","Cannot retrieve list of files. Maybe you have a weak internet connection."),r(u,"SEARCH_PLACEHOLDER","Search (Keyword, Keyword, Keyword)"),r(u,"SEARCH_LAST_MODIFIED","modified"),r(u,"SEARCH_CREATED","created"),r(u,"SEARCH_NUM_RESULTS","files found");class O extends u{}r(O,"TIME_LOCALE","de"),r(O,"APPNAME","Wissensdatenbank");let l=u;function P(){switch(localStorage.language){case"de":l=O;break;case"en":case"us":default:l=u;break}}class _{constructor(s){r(this,"apiEndpoint","");r(this,"sessionToken","");this.session_name=s,this.loadSessionConfig()}loadSessionConfig(){if(localStorage.webfs_sessions){let s=JSON.parse(localStorage.webfs_sessions);if(this.session_name in s){let e=s[this.session_name];this.apiEndpoint=e.apiEndpoint,this.sessionToken=e.sessionToken}}}writeSessionConfig(s,e){this.apiEndpoint=s,this.sessionToken=e;let t={};localStorage.webfs_sessions&&(t=JSON.parse(localStorage.webfs_sessions)),t[this.session_name]={apiEndpoint:this.apiEndpoint,sessionToken:e},localStorage.webfs_sessions=JSON.stringify(t)}removeSession(){if(localStorage.webfs_sessions){let s=JSON.parse(localStorage.webfs_sessions);s.indexOf(this.session_name)>=0&&s.remove(this.session_name)}}request(s){s.append("token",this.sessionToken);const e={method:"POST",body:s};return fetch(this.apiEndpoint,e)}async ping(){let s=new FormData;s.append("cmd","ping"),s.append("uri",".");let e=await this.request(s);return e.status!=200?(console.error(e.text()),!1):await e.text()=="pong"}async login(s,e){let t=new FormData;t.append("cmd","login"),t.append("uri","."),t.append("token",e);let i=await fetch(s,{method:"POST",body:t});if(i.status!=200)return console.error(i.text()),!1;let a=await i.text();return this.writeSessionConfig(s,a),!0}buildFileTree(s){return s}async list(s){let e=new FormData;e.append("cmd","list"),e.append("uri",s);let t=await this.request(e);return t.status!=200?(console.error(t.text()),null):await t.json()}async walk(s){let e=new FormData;e.append("cmd","walk"),e.append("uri",s);let t=await this.request(e);if(t.status!=200)return console.error(t.text()),null;let n=await t.json();return this.buildFileTree(n)}async md5(s){let e=new FormData;e.append("cmd","md5"),e.append("uri",s);let t=await this.request(e);return t.status!=200?(console.error(t.text()),null):t.text()}async open(s){let e=new FormData;e.append("cmd","open"),e.append("uri",s);let t=await this.request(e);return t.status!=200?(console.error(t.text()),!1):(await t.text(),!0)}async readTxt(s){let e=new FormData;e.append("cmd","read"),e.append("uri",s);let t=await this.request(e);return t.status!=200?(console.error(t.text()),null):t.text()}readURL(s,e=!1){let t="";return e&&(t="&subsample=1&width=256&height=256"),this.apiEndpoint+"?token="+encodeURIComponent(this.sessionToken)+"&cmd=read&uri="+encodeURIComponent(s)+t}read(s,e="_self"){function t(a,c,m){let p=document.createElement("input");p.type="hidden",p.name=c,p.value=m,a.appendChild(p)}let n=document.getElementsByTagName("body")[0],i=document.createElement("form");i.action=this.apiEndpoint,i.method="post",i.target=e,t(i,"cmd","read"),t(i,"token",this.sessionToken),t(i,"uri",s),n.appendChild(i),i.submit(),n.removeChild(i)}async putTxt(s,e,t){return this.putFile(s,e,t)}async putFile(s,e,t){let n="",i=new FormData;i.append("cmd","write"),i.append("operation","write"),i.append("uri",s),i.append("file",e),i.append("md5",t+","+n);let a=await this.request(i);return a.status!=200?(console.error(a.text()),!1):(await a.text(),!0)}async mkdir(s){let e=new FormData;e.append("cmd","write"),e.append("operation","mkdir"),e.append("uri",s);let t=await this.request(e);return t.status!=200?(console.error(t.text()),!1):(await t.text(),!0)}async rmdir(s){let e=new FormData;e.append("cmd","write"),e.append("operation","rmdir"),e.append("uri",s);let t=await this.request(e);return t.status!=200?(console.error(t.text()),!1):(await t.text(),!0)}async mv(s,e){let t=new FormData;t.append("cmd","write"),t.append("operation","mv"),t.append("uri",s),t.append("target",e);let n=await this.request(t);return n.status!=200?(console.error(n.text()),!1):(await n.text(),!0)}async rm(s,e){let t=new FormData;t.append("cmd","write"),t.append("operation","rm"),t.append("uri",s),t.append("md5",e);let n=await this.request(t);return n.status!=200?(console.error(n.text()),!1):(await n.text(),!0)}}r(_,"instance",null);class E{constructor(s){r(this,"parent",null);r(this,"htmlElement");r(this,"displayStyle","None");this.htmlElement=document.createElement(s)}add(s){this.htmlElement.appendChild(s.htmlElement),s.parent=this}remove(s){this.htmlElement.removeChild(s.htmlElement),s.parent=null}hide(){this.htmlElement.style.display!="None"&&(this.displayStyle=this.htmlElement.style.display,this.htmlElement.style.display="None")}show(){this.displayStyle!="None"&&(this.htmlElement.style.display=this.displayStyle)}update(s,e){}select(){this.setClass("selected")}unselect(){this.unsetClass("selected")}setClass(s){this.htmlElement.classList.contains(s)||this.htmlElement.classList.add(s)}unsetClass(s){this.htmlElement.classList.contains(s)||this.htmlElement.classList.remove(s)}}class A extends E{constructor(s,e=""){super("a"),this.htmlElement.innerText=s,e!=""&&this.setClass(e),this.htmlElement.onclick=()=>{this.onClick()}}onClick(){console.log("Buttom::onClick: Not implemented! Must be implemented by subclass.")}}class x extends E{constructor(...s){super("div");for(const e of s)this.add(e)}submit(){let s=new FormData;for(const e in this.htmlElement.children){let t=this.htmlElement.children[e];t instanceof HTMLInputElement&&s.append(t.name,t.value)}this.onSubmit(s)}onSubmit(s){console.log("Form::onSubmit: Not implemented! Must be implemented by subclass."),console.log(s)}}class g extends E{constructor(s,e,t,n=""){super("input"),this.htmlElement.name=s,this.htmlElement.placeholder=e,this.htmlElement.type=t,n!=""&&this.setClass(n),this.htmlElement.oninput=()=>{this.onChange(this.htmlElement.value)}}value(s=void 0){return s!==void 0&&(this.htmlElement.value=s),this.htmlElement.value}onChange(s){}}class S extends E{constructor(s,e=""){super("label"),this.htmlElement.innerText=s,e!=""&&this.setClass(e)}}class H extends A{onClick(){this.parent.submit()}}const U=6,G=6,B=10,Y=12,q=.001,N=31557600,y=2629800,I=86400,C=3600,R=60;function J(o,s="long"){let e=new Date;const t=b(e,o),{hours:n,minutes:i,seconds:a}=t;let c=new Date(e.toISOString().substring(0,10)),m=new Date(o.toISOString().substring(0,10));const p=b(c,m),{years:h,months:d,days:f}=p;return h>100?"unknown":h>0||d>G?D(o,{includeYear:!0,length:s}):d>0||f>U?D(o,{includeYear:!1,length:s}):f>1?o.toLocaleDateString(l.TIME_LOCALE,{weekday:s}):f===1?l.TIME_YESTERDAY:n>Y?l.TIME_TODAY_AT+" "+o.toLocaleTimeString(l.TIME_LOCALE,{hour:"numeric",minute:"2-digit"}):n>0?l.APPLY_COUNTED(n,l.TIME_HOURS_AGO):i>0?l.APPLY_COUNTED(i,l.TIME_MINUTES_AGO):a>B?l.APPLY_COUNTED(a,l.TIME_SECONDS_AGO):l.TIME_JUST_NOW}function D(o,{includeYear:s,length:e}){const t=o.toLocaleDateString(l.TIME_LOCALE,{month:e});let i=`${o.getDate().toString()}. ${t}`;return s&&(i+=` ${o.getFullYear()}`),i}function v(o){return Math.floor(o*q)}function b(o,s){const e={years:0,months:0,days:0,hours:0,minutes:0,seconds:0};let t=v(o.valueOf())-v(s.valueOf());return e.years=Math.floor(t/N),t-=e.years*N,e.months=Math.floor(t/y),t-=e.months*y,e.days=Math.floor(t/I),t-=e.days*I,e.hours=Math.floor(t/C),t-=e.hours*C,e.minutes=Math.floor(t/R),t-=e.minutes*R,e.seconds=t,e}class W{constructor(s){r(this,"activeTimeout");this.timeout=s}defer(s){this.activeTimeout&&window.clearTimeout(this.activeTimeout),this.activeTimeout=window.setTimeout(()=>{this.activeTimeout=void 0,s()},this.timeout)}}class j extends E{constructor(){super("div");r(this,"searchField");r(this,"results");r(this,"fileTree",null);r(this,"updateHashLater",new W(200));this.searchField=new g("search",l.SEARCH_PLACEHOLDER,"search","searchInput"),this.searchField.onChange=e=>{this.updateSearchResults(),this.updateHashLater.defer(()=>{w.open("search",{q:e})})},this.add(this.searchField),this.results=new E("div"),this.results.setClass("searchResults"),this.add(this.results)}async update(e,t){var n;if(_.instance==null){w.open("login",{});return}t&&(this.fileTree=await((n=_.instance)==null?void 0:n.walk(".")),this.searchField.value(e.q),this.updateSearchResults())}async updateSearchResults(){let e=this.searchField.value();if(this.results.htmlElement.innerHTML="",this.fileTree==null){alert(l.SEARCH_FILETREE_IS_NULL);return}let t=this.flatten(this.fileTree);t=this.sortFilesByLastModified(t),t=this.sortFilesByRelevance(t,e),this.showNumResults(t),t=t.slice(0,50);for(let n of t)this.results.add(new K(n.filepath,J(n.modified)))}showNumResults(e){let t=new E("div");t.htmlElement.innerText=e.length+" "+l.SEARCH_NUM_RESULTS,t.setClass("searchNumResults"),this.results.add(t)}sortFilesByRelevance(e,t){let n=t.toLowerCase().split(",").map(c=>c.trim()),i=[];for(let c of e){let{filename:m,folder:p}=M(c.filepath);var a=0;for(let h of n){if(h==""){a=1;continue}let d=h.startsWith("!");m.toLowerCase().includes(h)&&(a+=100),!d&&p.toLowerCase().includes(h)&&(a+=1),d&&p.toLowerCase().startsWith(h.substring(1))&&(a+=100)}a>0&&i.push({filepath:c.filepath,modified:c.modified,score:a})}return i.sort((c,m)=>m.score-c.score)}sortFilesByLastModified(e){return e.sort((t,n)=>n.modified.toISOString().localeCompare(t.modified.toISOString()))}flatten(e,t="",n=[]){for(const i in e){const a=e[i];typeof a!="string"?n=this.flatten(a,t+i+"/",n):n.push({filepath:t+i,modified:new Date(a)})}return n}}class K extends E{constructor(s,e){super("div"),this.setClass("searchResult");let{filename:t,folder:n}=M(s),i=t.split("."),a=i[i.length-1].toLowerCase();if(a=="png"||a=="jpg"||a=="jpeg"||a=="pdf"){let d=document.createElement("img");d.classList.add("searchResultPreview"),d.onerror=()=>{let f=document.createElement("div");f.innerHTML="<BR>"+a.toUpperCase(),f.classList.add("searchResultPreview"),this.htmlElement.replaceChild(f,this.htmlElement.childNodes[0])},d.src=_.instance.readURL(s,!0),this.htmlElement.appendChild(d)}else if(a=="txt"||a=="md"||a=="py"||a=="csv"||a=="json"){let d=document.createElement("div");d.style.fontSize="1em",d.style.textAlign="left",d.innerHTML="loading...",$.getTxtPreview(s).then(f=>{let T=f.split(`
`);T=T.map((L,X,Z)=>L.startsWith("#")?"<b style='font-size: 1.2em'>"+L+"</b>":L),f=T.join("<BR>"),d.innerHTML=f}),d.classList.add("searchResultPreview"),this.htmlElement.appendChild(d)}else{let d=document.createElement("div");d.innerHTML="<BR>"+a.toUpperCase(),d.classList.add("searchResultPreview"),this.htmlElement.appendChild(d)}let c=document.createElement("div");c.classList.add("searchResultMeta"),this.htmlElement.appendChild(c);let m=document.createElement("div");m.innerText=t,m.classList.add("searchResultFilename"),c.appendChild(m);let p=document.createElement("div");p.innerText=l.SEARCH_LAST_MODIFIED+": "+e,p.classList.add("searchResultModified"),c.appendChild(p);let h=document.createElement("div");h.innerText=n,h.classList.add("searchResultFolder"),c.appendChild(h),this.htmlElement.onclick=()=>{w.open("edit",{folder:n,filename:t})}}}function M(o){let s=o.split("/"),e=s.pop(),t=s.join("/");return t==""&&(t="."),{filename:e,folder:t}}class ${constructor(){}static async getTxtPreview(s){let e=JSON.parse(localStorage.getItem("kb_preview_cache")||"{}");if(e[s])return console.log("cached"),e[s];let t=await _.instance.readTxt(s);if(t!=null){let n=t.split(`
`).slice(0,13);n=n.map((a,c,m)=>a.slice(0,40)),t=n.join(`
`);let i=JSON.parse(localStorage.getItem("kb_preview_cache")||"{}");return i[s]=t,localStorage.setItem("kb_preview_cache",JSON.stringify(i)),t}return"error loading preview"}static async getImgPreview(s){return""}}class z extends E{constructor(){super("div");r(this,"connections");this.setClass("loginView"),this.connections=new E("div"),this.add(this.connections);let e=new x(new S(l.LOGIN_SESSION_NAME,"loginLabel"),new g("sessionName","myserver","text","loginInput"),new S(l.LOGIN_API_ENDPOINT_LABEL,"loginLabel"),new g("apiEndpoint","https://myserver/webfs/api.php","url","loginInput"),new S(l.LOGIN_API_TOKEN_LABEL,"loginLabel"),new g("apiToken","a4ef9...","password","loginInput"),new H(l.LOGIN_SUBMIT,"loginButton"));e.setClass("loginForm"),e.onSubmit=this.onCreateSession.bind(this),this.add(e)}update(e,t){if(this.connections.htmlElement.innerHTML="",localStorage.kb_sessions){let n=JSON.parse(localStorage.kb_sessions);n.length>0&&this.connections.add(new S(l.LOGIN_KNOWN_CONNECTIONS,"loginLabel"));for(const i of n){let a=new A(i,"loginButton");a.onClick=()=>{this.onReuseSession(i)},this.connections.add(a)}if(n.length>0){let i=new E("hr");i.setClass("loginDivider"),this.connections.add(i)}}}async onReuseSession(e){let t=new _(e);await t.ping()?(_.instance=t,w.back()):alert("Connection refused. Either the server is not available or the connection was not used for too long.")}async onCreateSession(e){let t=e.get("sessionName"),n=e.get("apiEndpoint"),i=e.get("apiToken");if(t==""||n==""||i==""||t==null||n==null||i==null){alert(l.LOGIN_ERROR_MISSING_INPUTS);return}let a=new _(t);if(await a.login(n,i)){let c=[];localStorage.kb_sessions&&(c=JSON.parse(localStorage.kb_sessions)),c.push(t),localStorage.kb_sessions=JSON.stringify(c),_.instance=a,w.back()}else alert(l.LOGIN_ERROR_LOGIN_FAILED)}}class V extends E{constructor(){super("div");r(this,"iframe");this.iframe=document.createElement("iframe"),this.iframe.name="editFrame",this.iframe.classList.add("editFrame"),this.htmlElement.appendChild(this.iframe)}async update(e,t){var n;if(_.instance==null){w.open("login",{});return}(n=_.instance)==null||n.read(e.folder+"/"+e.filename,"editFrame")}hide(){this.iframe.src="about:blank",super.hide()}}function Q(){P(),document.getElementsByTagName("title")[0].innerHTML=l.APPNAME,new w("search",{search:new j,login:new z,edit:new V})}Q();
