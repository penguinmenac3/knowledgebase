var M=Object.defineProperty;var v=(a,t,e)=>t in a?M(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var r=(a,t,e)=>(v(a,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();class S{constructor(t,e){r(this,"currentPage","");var s;this.defaultPage=t,this.pages=e,location.hash.slice(1)==""&&(location.hash="#"+t),window.onhashchange=n=>{this.onOpen()};for(const n in e)(s=document.getElementById("app"))==null||s.appendChild(e[n].htmlElement),e[n].hide();this.onOpen()}onOpen(){var i,o,c;let t={},e=this.defaultPage,n=location.hash.slice(1).split("&");n.length>0&&(e=n[0],n=n.splice(1));for(const u of n){let p=u.split("="),h=decodeURIComponent(p[0]),E=decodeURIComponent(p[1]);t[h]=E}this.currentPage!=e&&(console.log("Hide page: "+this.currentPage),(i=this.pages[this.currentPage])==null||i.hide(),this.currentPage=e,console.log("Show page: "+e),(o=this.pages[this.currentPage])==null||o.show()),console.log("Calling page.update with: "+JSON.stringify(t)),(c=this.pages[this.currentPage])==null||c.update(t)}static open(t,e){window.setTimeout(()=>{let s="";for(let n in e)s+="&"+encodeURIComponent(n)+"="+encodeURIComponent(e[n]);location.hash="#"+encodeURIComponent(t)+s},200)}static back(){history.back()}}class d{constructor(){}static APPLY_COUNTED(t,e){return e.replace("{count}",t.toString())}}r(d,"TIME_LOCALE","en"),r(d,"TIME_YESTERDAY","yesterday"),r(d,"TIME_HOURS_AGO","{count} hour(s) ago"),r(d,"TIME_MINUTES_AGO","{count} minute(s) ago"),r(d,"TIME_SECONDS_AGO","{count} second(s) ago"),r(d,"TIME_TODAY_AT","today at"),r(d,"TIME_JUST_NOW","just now"),r(d,"APPNAME","Knowledgebase"),r(d,"LOGIN_KNOWN_CONNECTIONS","Reuse Connection"),r(d,"LOGIN_SESSION_NAME","Session Name"),r(d,"LOGIN_API_ENDPOINT_LABEL","API Endpoint URL"),r(d,"LOGIN_API_TOKEN_LABEL","API Token"),r(d,"LOGIN_SUBMIT","Add Connection"),r(d,"LOGIN_ERROR_MISSING_INPUTS","You must provide all fields (session name, api endpoint and api token)."),r(d,"LOGIN_ERROR_LOGIN_FAILED","The provided login information is wrong. Is the URL and API token correct?"),r(d,"SEARCH_FILETREE_IS_NULL","Cannot retrieve list of files. Maybe you have a weak internet connection."),r(d,"SEARCH_PLACEHOLDER","Search (Keyword, Keyword, Keyword)"),r(d,"SEARCH_LAST_MODIFIED","modified");class g extends d{}r(g,"TIME_LOCALE","de"),r(g,"APPNAME","Wissensdatenbank");let l=d;function F(){switch(localStorage.language){case"de":l=g;break;case"en":case"us":default:l=d;break}}class f{constructor(t){r(this,"apiEndpoint","");r(this,"sessionToken","");this.session_name=t,this.loadSessionConfig()}loadSessionConfig(){if(localStorage.webfs_sessions){let t=JSON.parse(localStorage.webfs_sessions);if(this.session_name in t){let e=t[this.session_name];this.apiEndpoint=e.apiEndpoint,this.sessionToken=e.sessionToken}}}writeSessionConfig(t,e){this.apiEndpoint=t,this.sessionToken=e;let s={};localStorage.webfs_sessions&&(s=JSON.parse(localStorage.webfs_sessions)),s[this.session_name]={apiEndpoint:this.apiEndpoint,sessionToken:e},localStorage.webfs_sessions=JSON.stringify(s)}removeSession(){if(localStorage.webfs_sessions){let t=JSON.parse(localStorage.webfs_sessions);t.indexOf(this.session_name)>=0&&t.remove(this.session_name)}}request(t){t.append("token",this.sessionToken);const e={method:"POST",body:t};return fetch(this.apiEndpoint,e)}async ping(){let t=new FormData;t.append("cmd","ping"),t.append("uri",".");let e=await this.request(t);return e.status!=200?(console.error(e.text()),!1):await e.text()=="pong"}async login(t,e){let s=new FormData;s.append("cmd","login"),s.append("uri","."),s.append("token",e);let i=await fetch(t,{method:"POST",body:s});if(i.status!=200)return console.error(i.text()),!1;let o=await i.text();return this.writeSessionConfig(t,o),!0}buildFileTree(t){return t}async list(t){let e=new FormData;e.append("cmd","list"),e.append("uri",t);let s=await this.request(e);return s.status!=200?(console.error(s.text()),null):await s.json()}async walk(t){let e=new FormData;e.append("cmd","walk"),e.append("uri",t);let s=await this.request(e);if(s.status!=200)return console.error(s.text()),null;let n=await s.json();return this.buildFileTree(n)}async md5(t){let e=new FormData;e.append("cmd","md5"),e.append("uri",t);let s=await this.request(e);return s.status!=200?(console.error(s.text()),null):s.text()}async open(t){let e=new FormData;e.append("cmd","open"),e.append("uri",t);let s=await this.request(e);return s.status!=200?(console.error(s.text()),!1):(await s.text(),!0)}async readTxt(t){let e=new FormData;e.append("cmd","read"),e.append("uri",t);let s=await this.request(e);return s.status!=200?(console.error(s.text()),null):s.text()}read(t,e="_self"){function s(o,c,u){let p=document.createElement("input");p.type="hidden",p.name=c,p.value=u,o.appendChild(p)}let n=document.getElementsByTagName("body")[0],i=document.createElement("form");i.action=this.apiEndpoint,i.method="post",i.target=e,s(i,"cmd","read"),s(i,"token",this.sessionToken),s(i,"uri",t),n.appendChild(i),i.submit(),n.removeChild(i)}async putTxt(t,e,s){return this.putFile(t,e,s)}async putFile(t,e,s){let n="",i=new FormData;i.append("cmd","write"),i.append("operation","write"),i.append("uri",t),i.append("file",e),i.append("md5",s+","+n);let o=await this.request(i);return o.status!=200?(console.error(o.text()),!1):(await o.text(),!0)}async mkdir(t){let e=new FormData;e.append("cmd","write"),e.append("operation","mkdir"),e.append("uri",t);let s=await this.request(e);return s.status!=200?(console.error(s.text()),!1):(await s.text(),!0)}async rmdir(t){let e=new FormData;e.append("cmd","write"),e.append("operation","rmdir"),e.append("uri",t);let s=await this.request(e);return s.status!=200?(console.error(s.text()),!1):(await s.text(),!0)}async mv(t,e){let s=new FormData;s.append("cmd","write"),s.append("operation","mv"),s.append("uri",t),s.append("target",e);let n=await this.request(s);return n.status!=200?(console.error(n.text()),!1):(await n.text(),!0)}async rm(t,e){let s=new FormData;s.append("cmd","write"),s.append("operation","rm"),s.append("uri",t),s.append("md5",e);let n=await this.request(s);return n.status!=200?(console.error(n.text()),!1):(await n.text(),!0)}}r(f,"instance",null);class m{constructor(t){r(this,"parent",null);r(this,"htmlElement");r(this,"displayStyle","None");this.htmlElement=document.createElement(t)}add(t){this.htmlElement.appendChild(t.htmlElement),t.parent=this}remove(t){this.htmlElement.removeChild(t.htmlElement),t.parent=null}hide(){this.htmlElement.style.display!="None"&&(this.displayStyle=this.htmlElement.style.display,this.htmlElement.style.display="None")}show(){this.displayStyle!="None"&&(this.htmlElement.style.display=this.displayStyle)}update(t){}select(){this.setClass("selected")}unselect(){this.unsetClass("selected")}setClass(t){this.htmlElement.classList.contains(t)||this.htmlElement.classList.add(t)}unsetClass(t){this.htmlElement.classList.contains(t)||this.htmlElement.classList.remove(t)}}class b extends m{constructor(t,e=""){super("a"),this.htmlElement.innerText=t,e!=""&&this.setClass(e),this.htmlElement.onclick=()=>{this.onClick()}}onClick(){console.log("Buttom::onClick: Not implemented! Must be implemented by subclass.")}}class k extends m{constructor(...t){super("div");for(const e of t)this.add(e)}submit(){let t=new FormData;for(const e in this.htmlElement.children){let s=this.htmlElement.children[e];s instanceof HTMLInputElement&&t.append(s.name,s.value)}this.onSubmit(t)}onSubmit(t){console.log("Form::onSubmit: Not implemented! Must be implemented by subclass."),console.log(t)}}class w extends m{constructor(t,e,s,n=""){super("input"),this.htmlElement.name=t,this.htmlElement.placeholder=e,this.htmlElement.type=s,n!=""&&this.setClass(n),this.htmlElement.oninput=()=>{this.onChange(this.htmlElement.value)}}value(t=void 0){return t!==void 0&&(this.htmlElement.value=t),this.htmlElement.value}onChange(t){}}class _ extends m{constructor(t,e=""){super("label"),this.htmlElement.innerText=t,e!=""&&this.setClass(e)}}class x extends b{onClick(){this.parent.submit()}}const P=6,H=6,U=10,G=12,Y=.001,T=31557600,N=2629800,I=86400,y=3600,L=60;function B(a,t="long"){let e=new Date;const s=A(e,a),{hours:n,minutes:i,seconds:o}=s;let c=new Date(e.toISOString().substring(0,10)),u=new Date(a.toISOString().substring(0,10));const p=A(c,u),{years:h,months:E,days:O}=p;return h>100?"unknown":h>0||E>H?C(a,{includeYear:!0,length:t}):E>0||O>P?C(a,{includeYear:!1,length:t}):O>1?a.toLocaleDateString(l.TIME_LOCALE,{weekday:t}):O===1?l.TIME_YESTERDAY:n>G?l.TIME_TODAY_AT+" "+a.toLocaleTimeString(l.TIME_LOCALE,{hour:"numeric",minute:"2-digit"}):n>0?l.APPLY_COUNTED(n,l.TIME_HOURS_AGO):i>0?l.APPLY_COUNTED(i,l.TIME_MINUTES_AGO):o>U?l.APPLY_COUNTED(o,l.TIME_SECONDS_AGO):l.TIME_JUST_NOW}function C(a,{includeYear:t,length:e}){const s=a.toLocaleDateString(l.TIME_LOCALE,{month:e});let i=`${a.getDate().toString()}. ${s}`;return t&&(i+=` ${a.getFullYear()}`),i}function D(a){return Math.floor(a*Y)}function A(a,t){const e={years:0,months:0,days:0,hours:0,minutes:0,seconds:0};let s=D(a.valueOf())-D(t.valueOf());return e.years=Math.floor(s/T),s-=e.years*T,e.months=Math.floor(s/N),s-=e.months*N,e.days=Math.floor(s/I),s-=e.days*I,e.hours=Math.floor(s/y),s-=e.hours*y,e.minutes=Math.floor(s/L),s-=e.minutes*L,e.seconds=s,e}class q{constructor(t){r(this,"activeTimeout");this.timeout=t}defer(t){this.activeTimeout&&window.clearTimeout(this.activeTimeout),this.activeTimeout=window.setTimeout(()=>{this.activeTimeout=void 0,t()},this.timeout)}}class J extends m{constructor(){super("div");r(this,"searchField");r(this,"results");r(this,"currentSearch");r(this,"updateHashLater",new q(1e3));this.searchField=new w("search",l.SEARCH_PLACEHOLDER,"search","searchInput"),this.searchField.onChange=e=>{this.updateSearchResults(),this.updateHashLater.defer(()=>{S.open("search",{q:e})})},this.add(this.searchField),this.results=new m("div"),this.results.setClass("searchResults"),this.add(this.results)}async update(e){if(f.instance==null){S.open("login",{});return}this.searchField.value(e.q),this.updateSearchResults()}async updateSearchResults(){var i;let e=this.searchField.value();if(this.currentSearch==e)return;this.currentSearch=e;let s=await((i=f.instance)==null?void 0:i.walk("."));if(s==null){alert(l.SEARCH_FILETREE_IS_NULL);return}let n=this.flatten(s);n=this.sortFilesByLastModified(n),n=this.sortFilesByRelevance(n,e),n=n.slice(0,50),this.results.htmlElement.innerHTML="";for(let o of n)this.results.add(new W(o.filepath,B(o.modified)))}sortFilesByRelevance(e,s){let n=s.toLowerCase().split(",").map(c=>c.trim()),i=[];for(let c of e){let{filename:u,folder:p}=R(c.filepath);var o=0;for(let h of n){if(h==""){o=1;continue}let E=h.startsWith("!");u.toLowerCase().includes(h)&&(o+=100),!E&&p.toLowerCase().includes(h)&&(o+=1),E&&p.toLowerCase().startsWith(h.substring(1))&&(o+=100)}o>0&&i.push({filepath:c.filepath,modified:c.modified,score:o})}return i.sort((c,u)=>u.score-c.score)}sortFilesByLastModified(e){return e.sort((s,n)=>n.modified.toISOString().localeCompare(s.modified.toISOString()))}flatten(e,s="",n=[]){for(const i in e){const o=e[i];typeof o!="string"?n=this.flatten(o,s+i+"/",n):n.push({filepath:s+i,modified:new Date(o)})}return n}}class W extends m{constructor(t,e){super("div"),this.setClass("searchResult");let{filename:s,folder:n}=R(t),i=document.createElement("div");i.innerText=s,i.classList.add("searchResultFilename"),this.htmlElement.appendChild(i);let o=document.createElement("div");o.innerText=l.SEARCH_LAST_MODIFIED+": "+e,o.classList.add("searchResultModified"),this.htmlElement.appendChild(o);let c=document.createElement("div");c.innerText=n,c.classList.add("searchResultFolder"),this.htmlElement.appendChild(c),this.htmlElement.onclick=()=>{var u;(u=f.instance)==null||u.read(n+"/"+s,"_blank")}}}function R(a){let t=a.split("/"),e=t.pop(),s=t.join("/");return s==""&&(s="."),{filename:e,folder:s}}class K extends m{constructor(){super("div");r(this,"connections");this.setClass("loginView"),this.connections=new m("div"),this.add(this.connections);let e=new k(new _(l.LOGIN_SESSION_NAME,"loginLabel"),new w("sessionName","myserver","text","loginInput"),new _(l.LOGIN_API_ENDPOINT_LABEL,"loginLabel"),new w("apiEndpoint","https://myserver/webfs/api.php","url","loginInput"),new _(l.LOGIN_API_TOKEN_LABEL,"loginLabel"),new w("apiToken","a4ef9...","password","loginInput"),new x(l.LOGIN_SUBMIT,"loginButton"));e.setClass("loginForm"),e.onSubmit=this.onCreateSession.bind(this),this.add(e)}update(e){if(this.connections.htmlElement.innerHTML="",localStorage.kb_sessions){let s=JSON.parse(localStorage.kb_sessions);s.length>0&&this.connections.add(new _(l.LOGIN_KNOWN_CONNECTIONS,"loginLabel"));for(const n of s){let i=new b(n,"loginButton");i.onClick=()=>{this.onReuseSession(n)},this.connections.add(i)}if(s.length>0){let n=new m("hr");n.setClass("loginDivider"),this.connections.add(n)}}}async onReuseSession(e){let s=new f(e);await s.ping()?(f.instance=s,S.back()):alert("Connection refused. Either the server is not available or the connection was not used for too long.")}async onCreateSession(e){let s=e.get("sessionName"),n=e.get("apiEndpoint"),i=e.get("apiToken");if(s==""||n==""||i==""||s==null||n==null||i==null){alert(l.LOGIN_ERROR_MISSING_INPUTS);return}let o=new f(s);if(await o.login(n,i)){let c=[];localStorage.kb_sessions&&(c=JSON.parse(localStorage.kb_sessions)),c.push(s),localStorage.kb_sessions=JSON.stringify(c),f.instance=o,S.back()}else alert(l.LOGIN_ERROR_LOGIN_FAILED)}}function j(){F(),document.getElementsByTagName("title")[0].innerHTML=l.APPNAME,new S("search",{search:new J,login:new K})}j();
